<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Go Gin框架 | Eli&#39;s Blog</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/favicon/favicon.ico">
  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Eli's Blog</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Eli's Blog
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" target="_blank" href="https://xaoxuu.com/wiki/material-x/"
                
                  rel="nofollow noopener"
                
                
                id="https:xaoxuu.comwikimaterial-x">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2019/05/17/Go%20Gin%E6%A1%86%E6%9E%B6/">
        Go Gin框架
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="https://elihe2011.github.io" rel="nofollow">
        
          <img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png">
        
        <p>Eli He</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2019-05-17</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/Golang/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Golang</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <h1 id="1-Gin简介"><a href="#1-Gin简介" class="headerlink" title="1. Gin简介"></a>1. Gin简介</h1><h2 id="1-1-核心术语"><a href="#1-1-核心术语" class="headerlink" title="1.1 核心术语"></a>1.1 核心术语</h2><ul>
<li>Engine: 实现 ServeHTTP 接口的 Handler</li>
<li>MethodTree： 根据http请求方法分别维护的路由树</li>
<li>RouterGroup：路由表分组，方便中间件统一处理</li>
<li>Context：上下文，在 Handler 之间传递参数</li>
</ul>
<h2 id="1-2-HttpRouter"><a href="#1-2-HttpRouter" class="headerlink" title="1.2 HttpRouter"></a>1.2 HttpRouter</h2><p>gin 使用路由框架 httprouter，它使用动态压缩前缀树 (compact prefix trie) 或称基数树 (radix tree) ，具有共同前缀的节点拥有相同的父节点，内存开销极小，没有反射。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.go</span></span><br><span class="line"><span class="keyword">type</span> Router <span class="keyword">struct</span> &#123;</span><br><span class="line">    trees <span class="keyword">map</span>[<span class="keyword">string</span>]*node       <span class="comment">// 每种请求方法，单独管理一棵树</span></span><br><span class="line">    RedirectTrailingSlash <span class="keyword">bool</span>   <span class="comment">// 自动处理URL尾部的 “/”</span></span><br><span class="line">    RedirectFixedPath <span class="keyword">bool</span>       <span class="comment">// 路径矫正，如../和//</span></span><br><span class="line">    HandleMethodNotAllowed <span class="keyword">bool</span></span><br><span class="line">	HandleOPTIONS <span class="keyword">bool</span>           <span class="comment">// 开启OPTIONS自动匹配, 手动匹配优先级更高</span></span><br><span class="line">	NotFound http.Handler</span><br><span class="line">	MethodNotAllowed http.Handler</span><br><span class="line">	PanicHandler <span class="function"><span class="keyword">func</span><span class="params">(http.ResponseWriter, *http.Request, <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tree.go</span></span><br><span class="line"><span class="keyword">type</span> node <span class="keyword">struct</span> &#123;</span><br><span class="line">	path      <span class="keyword">string</span></span><br><span class="line">	indices   <span class="keyword">string</span>   <span class="comment">// 分支的首字母：indices = eu，下面的 s [earch, upport]</span></span><br><span class="line">	wildChild <span class="keyword">bool</span>     <span class="comment">// 是否为参数节点，参数节点用:name表示</span></span><br><span class="line">	nType     nodeType <span class="comment">// static：没有handler，root: 第一个插入的节点，catchAll: 有*匹配的节点，param: 参数节点如:post</span></span><br><span class="line">	priority  <span class="keyword">uint32</span>   <span class="comment">// 子节点越多，或说绑定handle方法越多的节点，priority优先级越高</span></span><br><span class="line">	children  []*node</span><br><span class="line">	handle    Handle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>路由的保存：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Priority   Path             Handle</span><br><span class="line">9          \                *&lt;1&gt;</span><br><span class="line">3          ├s               nil</span><br><span class="line">2          |├earch\         *&lt;2&gt;</span><br><span class="line">1          |└upport\        *&lt;3&gt;</span><br><span class="line">2          ├blog\           *&lt;4&gt;</span><br><span class="line">1          |    └:post      nil</span><br><span class="line">1          |         └\     *&lt;5&gt;</span><br><span class="line">2          ├about-us\       *&lt;6&gt;</span><br><span class="line">1          |        └team\  *&lt;7&gt;</span><br><span class="line">1          └contact\        *&lt;8&gt;</span><br><span class="line"></span><br><span class="line">GET(&quot;/search/&quot;, h1)</span><br><span class="line">GET(&quot;/support/&quot;, h2)</span><br><span class="line">GET(&quot;/blog/:post/&quot;, h3)</span><br><span class="line">GET(&quot;/about-us/&quot;, h4)</span><br><span class="line">GET(&quot;/about-us/team/&quot;, h5)</span><br><span class="line">GET(&quot;/contact/&quot;, h6)</span><br></pre></td></tr></table></figure>



<p>r.Handle：<code>r.Get</code>, <code>r.Post</code>等方法的具体实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span> <span class="title">Handle</span><span class="params">(method, path <span class="keyword">string</span>, handle Handle)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> path[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;path must begin with &#x27;/&#x27; in path &#x27;&quot;</span> + path + <span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> r.trees == <span class="literal">nil</span> &#123;</span><br><span class="line">		r.trees = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*node)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按方法创建路由树</span></span><br><span class="line">	root := r.trees[method]</span><br><span class="line">	<span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">		root = <span class="built_in">new</span>(node)</span><br><span class="line">		r.trees[method] = root</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	root.addRoute(path, handle)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h1><h2 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/gin-gonic/gin</span><br></pre></td></tr></table></figure>



<h2 id="2-2-入门"><a href="#2-2-入门" class="headerlink" title="2.2 入门"></a>2.2 入门</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">JSON</span><span class="params">(code <span class="keyword">int</span>, obj <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="keyword">type</span> H <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 路由</span></span><br><span class="line">    r := gin.Default()</span><br><span class="line"></span><br><span class="line">    r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(<span class="number">200</span>, gin.H &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;hello world!&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-3-请求参数"><a href="#2-3-请求参数" class="headerlink" title="2.3 请求参数"></a>2.3 请求参数</h2><h3 id="2-3-1-路由参数"><a href="#2-3-1-路由参数" class="headerlink" title="2.3.1 路由参数"></a>2.3.1 路由参数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Param</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/user/:name&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		name := c.Param(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">		c.String(http.StatusOK, <span class="string">&quot;hello %s&quot;</span>, name)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将匹配 /user/john/ 和 /user/john/send</span></span><br><span class="line">    <span class="comment">// 如果没有其他路由匹配 /user/john，它将重定向到 /user/john/</span></span><br><span class="line">	r.GET(<span class="string">&quot;/user/:name/*action&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		name := c.Param(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">		action := c.Param(<span class="string">&quot;action&quot;</span>)</span><br><span class="line"></span><br><span class="line">		msg := name + <span class="string">&quot; is doing &quot;</span> + action</span><br><span class="line">		c.String(http.StatusOK, msg)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-2-Query参数"><a href="#2-3-2-Query参数" class="headerlink" title="2.3.2 Query参数"></a>2.3.2 Query参数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Query</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">GetQuery</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">bool</span>)</span></span> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">DefaultQuery</span><span class="params">(key, defaultValue <span class="keyword">string</span>)</span> <span class="title">string</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/user&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        filters := c.Query(<span class="string">&quot;filters&quot;</span>)</span><br><span class="line">		pageIndex := c.DefaultQuery(<span class="string">&quot;page_index&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">		pageSize := c.DefaultQuery(<span class="string">&quot;page_size&quot;</span>, <span class="string">&quot;10&quot;</span>)</span><br><span class="line"></span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;filters&quot;</span>: filters, <span class="string">&quot;page_index&quot;</span>: pageIndex, <span class="string">&quot;page_size&quot;</span>: pageSize&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-3-Form参数"><a href="#2-3-3-Form参数" class="headerlink" title="2.3.3 Form参数"></a>2.3.3 Form参数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">PostForm</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">DefaultPostForm</span><span class="params">(key, defaultValue <span class="keyword">string</span>)</span> <span class="title">string</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.POST(<span class="string">&quot;/login&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		username := c.PostForm(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">		password := c.DefaultPostForm(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span><br><span class="line"></span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;username&quot;</span>: username,</span><br><span class="line">			<span class="string">&quot;password&quot;</span>: password,</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// curl -d &#x27;username=tom&amp;password=abc123&#x27; -X POST http://127.0.0.1:8080/login</span></span><br></pre></td></tr></table></figure>



<h3 id="2-3-4-参数相关方法"><a href="#2-3-4-参数相关方法" class="headerlink" title="2.3.4 参数相关方法"></a>2.3.4 参数相关方法</h3><table>
<thead>
<tr>
<th align="left">查询参数</th>
<th align="left">Form表单</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Query</td>
<td align="left">PostForm</td>
<td align="left">获取key对应的值，不存在为空字符串</td>
</tr>
<tr>
<td align="left">GetQuery</td>
<td align="left">GetPostForm</td>
<td align="left">多返回一个key是否存在的结果</td>
</tr>
<tr>
<td align="left">QueryArray</td>
<td align="left">PostFormArray</td>
<td align="left">获取key对应的数组，不存在返回一个空数组</td>
</tr>
<tr>
<td align="left">GetQueryArray</td>
<td align="left">GetPostFormArray</td>
<td align="left">多返回一个key是否存在的结果</td>
</tr>
<tr>
<td align="left">QueryMap</td>
<td align="left">PostFormMap</td>
<td align="left">获取key对应的map，不存在返回空map</td>
</tr>
<tr>
<td align="left">GetQueryMap</td>
<td align="left">GetPostFormMap</td>
<td align="left">多返回一个key是否存在的结果</td>
</tr>
<tr>
<td align="left">DefaultQuery</td>
<td align="left">DefaultPostForm</td>
<td align="left">key不存在的话，可以指定返回的默认值</td>
</tr>
</tbody></table>
<h2 id="2-4-文件操作"><a href="#2-4-文件操作" class="headerlink" title="2.4 文件操作"></a>2.4 文件操作</h2><p>调整文件上传表单大小：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给表单限制上传大小，默认 32MiB</span></span><br><span class="line">r.MaxMultipartMemory = <span class="number">128</span> &lt;&lt; <span class="number">20</span>  <span class="comment">// 128MB</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4-1-单文件上传"><a href="#2-4-1-单文件上传" class="headerlink" title="2.4.1 单文件上传"></a>2.4.1 单文件上传</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 限制文件大小</span></span><br><span class="line">	err := c.Request.ParseMultipartForm(<span class="number">4</span> &lt;&lt; <span class="number">20</span>) <span class="comment">// 4Mb</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.String(http.StatusBadRequest, <span class="string">&quot;file is too large&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// header, err := c.FormFile(&quot;file&quot;)</span></span><br><span class="line">	file, header, err := c.Request.FormFile(<span class="string">&quot;file&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.String(http.StatusBadRequest, err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;filename: %s, size: %d&quot;</span>, header.Filename, header.Size)</span><br><span class="line">	err = saveFile(header.Filename, file)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.String(http.StatusBadRequest, err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.String(http.StatusOK, <span class="string">&quot;uploaded!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveFile</span><span class="params">(name <span class="keyword">string</span>, input multipart.File)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> output *os.File</span><br><span class="line">	output, err = os.OpenFile(name, os.O_CREATE|os.O_RDWR, <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> output.Close()</span><br><span class="line"></span><br><span class="line">	_, err = io.Copy(output, input)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">curl -X POST http:<span class="comment">//192.168.80.1:8080/upload \</span></span><br><span class="line">  -F <span class="string">&quot;file=@/home/ubuntu/ryu-socket_20210527.tar&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: multipart/form-data&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4-2-多文件上传"><a href="#2-4-2-多文件上传" class="headerlink" title="2.4.2 多文件上传"></a>2.4.2 多文件上传</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">uploadFiles</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	form, err := c.MultipartForm()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.String(http.StatusBadRequest, err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	files := form.File[<span class="string">&quot;upload[]&quot;</span>]</span><br><span class="line">	fmt.Printf(<span class="string">&quot;file numbers: %d\n&quot;</span>, <span class="built_in">len</span>(files))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i, _ := <span class="keyword">range</span> files &#123;</span><br><span class="line">		file, err := files[i].Open()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.String(http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">&quot;filename: %s, size: %d\n&quot;</span>, files[i].Filename, files[i].Size)</span><br><span class="line"></span><br><span class="line">		err = saveFile(files[i].Filename, file)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.String(http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.String(http.StatusOK, <span class="string">&quot;uploaded&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">curl -X POST http:<span class="comment">//192.168.80.1:8080/uploadFiles \</span></span><br><span class="line">  -F <span class="string">&quot;upload[]=@/home/ubuntu/clean_ryu_imgs.sh&quot;</span> \</span><br><span class="line">  -F <span class="string">&quot;upload[]=@/home/ubuntu/.profile&quot;</span> \</span><br><span class="line">  -F <span class="string">&quot;upload[]=@/home/ubuntu/vegeta_12.8.4_linux_amd64.tar.gz&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: multipart/form-data&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4-3-文件下载"><a href="#2-4-3-文件下载" class="headerlink" title="2.4.3 文件下载"></a>2.4.3 文件下载</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">download</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	txt := c.Query(<span class="string">&quot;content&quot;</span>)</span><br><span class="line">	content := <span class="string">&quot;hello, 我是文件, &quot;</span> + txt</span><br><span class="line"></span><br><span class="line">	c.Writer.WriteHeader(http.StatusOK)</span><br><span class="line">	c.Header(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment; filename=hello.txt&quot;</span>)</span><br><span class="line">	c.Header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/text/plain&quot;</span>)</span><br><span class="line">	c.Header(<span class="string">&quot;Accept-Length&quot;</span>, fmt.Sprintf(<span class="string">&quot;%d&quot;</span>, <span class="built_in">len</span>(content)))</span><br><span class="line">	c.Writer.Write([]<span class="keyword">byte</span>(content))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">curl http:<span class="comment">//192.168.80.1:8080/download?content=abc</span></span><br></pre></td></tr></table></figure>



<h1 id="4-高级功能"><a href="#4-高级功能" class="headerlink" title="4. 高级功能"></a>4. 高级功能</h1><h2 id="4-1-路由分组"><a href="#4-1-路由分组" class="headerlink" title="4.1 路由分组"></a>4.1 路由分组</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	v1 := r.Group(<span class="string">&quot;/v1&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		v1.POST(<span class="string">&quot;/login&quot;</span>, LoginHandler)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v2 := r.Group(<span class="string">&quot;/v2&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		v2.POST(<span class="string">&quot;/login&quot;</span>, LoginV2Handler)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-2-中间件"><a href="#4-2-中间件" class="headerlink" title="4.2 中间件"></a>4.2 中间件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">Use</span><span class="params">(middleware ...HandlerFunc)</span> <span class="title">IRoutes</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 不使用默认中间件： Logger 和 Recovery </span></span><br><span class="line">	r := gin.New()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 全局中间件</span></span><br><span class="line">	r.Use(gin.Logger())</span><br><span class="line">	r.Use(gin.Recovery())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 路由中间件</span></span><br><span class="line">	r.GET(<span class="string">&quot;/location&quot;</span>, LocationLogger(), LocationHandler)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分组中间件</span></span><br><span class="line">	auth := r.Group(<span class="string">&quot;/auth&quot;</span>)</span><br><span class="line">	auth.Use(AuthRequired())</span><br><span class="line">	&#123;</span><br><span class="line">		auth.POST(<span class="string">&quot;/user&quot;</span>, UserHandler)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-1-自定义中间件"><a href="#4-2-1-自定义中间件" class="headerlink" title="4.2.1 自定义中间件"></a>4.2.1 自定义中间件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.New()</span><br><span class="line">	r.Use(Logger())</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;msg&quot;</span>: c.MustGet(<span class="string">&quot;foo&quot;</span>),</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Logger</span><span class="params">()</span> <span class="title">gin</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="comment">// before request</span></span><br><span class="line">		t := time.Now()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// set a variable</span></span><br><span class="line">		c.Set(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// DO request</span></span><br><span class="line">		c.Next()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// after request</span></span><br><span class="line">		latency := time.Since(t)</span><br><span class="line">		log.Println(latency)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// access the result status</span></span><br><span class="line">		status := c.Writer.Status()</span><br><span class="line">		log.Println(status)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-2-BasicAuth中间件"><a href="#4-2-2-BasicAuth中间件" class="headerlink" title="4.2.2 BasicAuth中间件"></a>4.2.2 BasicAuth中间件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// simulate private data</span></span><br><span class="line"><span class="keyword">var</span> secrets = gin.H&#123;</span><br><span class="line">	<span class="string">&quot;foo&quot;</span>:  gin.H&#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;foo@abc.com&quot;</span>, <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;13302254321&quot;</span>&#125;,</span><br><span class="line">	<span class="string">&quot;jack&quot;</span>: gin.H&#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;jack@abc.com&quot;</span>, <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;18952098765&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	authorized := r.Group(<span class="string">&quot;/admin&quot;</span>, gin.BasicAuth(gin.Accounts&#123;</span><br><span class="line">		<span class="string">&quot;foo&quot;</span>:  <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">		<span class="string">&quot;jack&quot;</span>: <span class="string">&quot;1234&quot;</span>,</span><br><span class="line">	&#125;))</span><br><span class="line"></span><br><span class="line">	authorized.GET(<span class="string">&quot;/secrets&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		user := c.MustGet(gin.AuthUserKey).(<span class="keyword">string</span>)</span><br><span class="line">		<span class="keyword">if</span> secret, ok := secrets[user]; ok &#123;</span><br><span class="line">			c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">				<span class="string">&quot;user&quot;</span>:   user,</span><br><span class="line">				<span class="string">&quot;secret&quot;</span>: secret,</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">				<span class="string">&quot;user&quot;</span>:   user,</span><br><span class="line">				<span class="string">&quot;secret&quot;</span>: <span class="string">&quot;NO SECRET&quot;</span>,</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-记录日志"><a href="#4-3-记录日志" class="headerlink" title="4.3 记录日志"></a>4.3 记录日志</h2><h3 id="4-3-1-日志文件"><a href="#4-3-1-日志文件" class="headerlink" title="4.3.1 日志文件"></a>4.3.1 日志文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	LogSavePath    = <span class="string">&quot;logs/&quot;</span></span><br><span class="line">	LogSaveName    = <span class="string">&quot;gin&quot;</span></span><br><span class="line">	LogSaveFileExt = <span class="string">&quot;log&quot;</span></span><br><span class="line">	TimeFormat     = <span class="string">&quot;20060102&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Level <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	F *os.File</span><br><span class="line"></span><br><span class="line">	DefaultPrefix      = <span class="string">&quot;&quot;</span></span><br><span class="line">	DefaultCallerDepth = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	logger     *log.Logger</span><br><span class="line">	logPrefix  = <span class="string">&quot;&quot;</span></span><br><span class="line">	levelFlags = []<span class="keyword">string</span>&#123;<span class="string">&quot;DEBUG&quot;</span>, <span class="string">&quot;INFO&quot;</span>, <span class="string">&quot;WRAN&quot;</span>, <span class="string">&quot;ERROR&quot;</span>, <span class="string">&quot;FATAL&quot;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	DEBUG Level = <span class="literal">iota</span></span><br><span class="line">	INFO</span><br><span class="line">	WARNING</span><br><span class="line">	ERROR</span><br><span class="line">	FATAL</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	filePath := getLogFileFullPath()</span><br><span class="line">	F = openLogFile(filePath)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 新建日志处理</span></span><br><span class="line">	logger = log.New(F, DefaultPrefix, log.LstdFlags)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getLogFilePath</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s&quot;</span>, LogSavePath)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getLogFileFullPath</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	prefixPath := getLogFilePath()</span><br><span class="line">	suffixPath := fmt.Sprintf(<span class="string">&quot;%s%s.%s&quot;</span>, LogSaveName, time.Now().Format(TimeFormat), LogSaveFileExt)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s%s&quot;</span>, prefixPath, suffixPath)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">openLogFile</span><span class="params">(filePath <span class="keyword">string</span>)</span> *<span class="title">os</span>.<span class="title">File</span></span> &#123;</span><br><span class="line">	_, err := os.Stat(filePath)</span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> os.IsNotExist(err):</span><br><span class="line">		makeDir()</span><br><span class="line">	<span class="keyword">case</span> os.IsPermission(err):</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Permission: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	handle, err := os.OpenFile(filePath, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Failed to OpenFile: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeDir</span><span class="params">()</span></span> &#123;</span><br><span class="line">	pwd, _ := os.Getwd()</span><br><span class="line">	err := os.MkdirAll(pwd+<span class="string">&quot;/&quot;</span>+getLogFilePath(), os.ModePerm)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Debug</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	setPrefix(DEBUG)</span><br><span class="line">	logger.Println(v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Info</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	setPrefix(INFO)</span><br><span class="line">	logger.Println(v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Warn</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	setPrefix(WARNING)</span><br><span class="line">	logger.Println(v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Error</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	setPrefix(ERROR)</span><br><span class="line">	logger.Println(v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatal</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	setPrefix(FATAL)</span><br><span class="line">	logger.Println(v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setPrefix</span><span class="params">(level Level)</span></span> &#123;</span><br><span class="line">	_, file, line, ok := runtime.Caller(DefaultCallerDepth)</span><br><span class="line">	<span class="keyword">if</span> ok &#123;</span><br><span class="line">		logPrefix = fmt.Sprintf(<span class="string">&quot;[%s][%s:%d]&quot;</span>, levelFlags[level], filepath.Base(file), line)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		logPrefix = fmt.Sprintf(<span class="string">&quot;[%s]&quot;</span>, levelFlags[level])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	logger.SetPrefix(logPrefix)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-3-2-日志格式"><a href="#4-3-2-日志格式" class="headerlink" title="4.3.2 日志格式"></a>4.3.2 日志格式</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := gin.New()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// LoggerWithFormatter 中间件会将日志写入 gin.DefaultWriter</span></span><br><span class="line">	<span class="comment">// By default gin.DefaultWriter = os.Stdout</span></span><br><span class="line">	router.Use(gin.LoggerWithFormatter(<span class="function"><span class="keyword">func</span><span class="params">(param gin.LogFormatterParams)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 你的自定义格式</span></span><br><span class="line">		<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s - [%s] \&quot;%s %s %s %d %s \&quot;%s\&quot; %s\&quot;\n&quot;</span>,</span><br><span class="line">			param.ClientIP,</span><br><span class="line">			param.TimeStamp.Format(time.RFC1123),</span><br><span class="line">			param.Method,</span><br><span class="line">			param.Path,</span><br><span class="line">			param.Request.Proto,</span><br><span class="line">			param.StatusCode,</span><br><span class="line">			param.Latency,</span><br><span class="line">			param.Request.UserAgent(),</span><br><span class="line">			param.ErrorMessage,</span><br><span class="line">		)</span><br><span class="line">	&#125;))</span><br><span class="line">	router.Use(gin.Recovery())</span><br><span class="line"></span><br><span class="line">	router.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.String(<span class="number">200</span>, <span class="string">&quot;pong&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	router.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-4-模型绑定和验证"><a href="#4-4-模型绑定和验证" class="headerlink" title="4.4 模型绑定和验证"></a>4.4 模型绑定和验证</h2><p>Gin使用 go-playground/validator.v10 验证参数。</p>
<p>将请求主体绑定到结构体中，目前支持JSON、XML、YAML和标准表单值(foo=bar&amp;boo=baz)的绑定。</p>
<p>绑定方法：</p>
<ul>
<li><p>Must bind:</p>
<ul>
<li>Methods: Bind, BindJSON, BindXML, BindQuery, BindYAML</li>
<li>Behavior: 底层使用MustBindWith，如果存在绑定错误，请求将被以下指令中止 <code>c.AbortWithError(400, err).SetType(ErrorTypeBind)</code></li>
</ul>
</li>
<li><p>Should bind:</p>
<ul>
<li>Methods: ShouldBind, ShouldBindJSON, ShouldBindXML, ShouldBindQuery, ShouldBindYAML</li>
<li>Behavior: 底层使用ShouldBindWith，如果存在绑定错误，则返回错误，开发人员可正确处理请求和错误</li>
</ul>
</li>
</ul>
<h3 id="4-4-1-请求参数绑定"><a href="#4-4-1-请求参数绑定" class="headerlink" title="4.4.1 请求参数绑定"></a>4.4.1 请求参数绑定</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Username <span class="keyword">string</span> <span class="string">`form:&quot;username&quot; json:&quot;username&quot; xml:&quot;username&quot; binding:&quot;required&quot;`</span></span><br><span class="line">	Password <span class="keyword">string</span> <span class="string">`form:&quot;password&quot; json:&quot;password&quot; xml:&quot;password&quot; binding:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.POST(<span class="string">&quot;/login&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> user User</span><br><span class="line">		<span class="comment">//if err := c.ShouldBind(&amp;user); err != nil &#123;</span></span><br><span class="line">		<span class="keyword">if</span> err := c.ShouldBindJSON(&amp;user); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">				<span class="string">&quot;code&quot;</span>: <span class="number">-1</span>,</span><br><span class="line">				<span class="string">&quot;msg&quot;</span>:  err.Error(),</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> user.Username != <span class="string">&quot;admin&quot;</span> || user.Password != <span class="string">&quot;123&quot;</span> &#123;</span><br><span class="line">			c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">				<span class="string">&quot;code&quot;</span>: <span class="number">-1</span>,</span><br><span class="line">				<span class="string">&quot;msg&quot;</span>:  <span class="string">&quot;unauthorized&quot;</span>,</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">&quot;msg&quot;</span>:  <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-2-自定义校验器"><a href="#4-4-2-自定义校验器" class="headerlink" title="4.4.2 自定义校验器"></a>4.4.2 自定义校验器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin/binding&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;gopkg.in/go-playground/validator.v10&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Booking <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// v8</span></span><br><span class="line">    <span class="comment">// CheckIn  time.Time `form:&quot;check_in&quot; binding:&quot;required,bookabledate&quot; time_format:&quot;2006-01-02&quot;`</span></span><br><span class="line">    CheckIn  time.Time <span class="string">`form:&quot;check_in&quot; binding:&quot;required&quot; validate:&quot;bookabledate&quot; time_format:&quot;2006-01-02&quot;`</span></span><br><span class="line">	CheckOut time.Time <span class="string">`form:&quot;check_out&quot; binding:&quot;required,gtfield=CheckIn&quot; time_format:&quot;2006-01-02&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bookableDate</span><span class="params">(fl validator.FieldLevel)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> date, ok := fl.Field().Interface().(time.Time); ok &#123;</span><br><span class="line">		today := time.Now()</span><br><span class="line">		<span class="keyword">if</span> today.Before(date) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// v10</span></span><br><span class="line">	validate := validator.New()</span><br><span class="line">	validate.RegisterValidation(<span class="string">&quot;bookabledate&quot;</span>, bookableDate)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/book&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> book Booking</span><br><span class="line">		<span class="keyword">if</span> err := c.ShouldBindWith(&amp;book, binding.Query); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">				<span class="string">&quot;code&quot;</span>: <span class="number">-1</span>,</span><br><span class="line">				<span class="string">&quot;msg&quot;</span>:  err.Error(),</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// v10: 绑定和校验分离</span></span><br><span class="line">		err := validate.Struct(book)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">				<span class="string">&quot;code&quot;</span>: <span class="number">-1</span>,</span><br><span class="line">				<span class="string">&quot;msg&quot;</span>:  err.Error(),</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">&quot;msg&quot;</span>:  <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-3-绑定uri"><a href="#4-4-3-绑定uri" class="headerlink" title="4.4.3 绑定uri"></a>4.4.3 绑定uri</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID   <span class="keyword">string</span> <span class="string">`uri:&quot;id&quot; binding:&quot;required,uuid&quot;`</span></span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`uri:&quot;name&quot; binding:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/:name/:id&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> person Person</span><br><span class="line">		<span class="keyword">if</span> err := c.ShouldBindUri(&amp;person); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">				<span class="string">&quot;code&quot;</span>: <span class="number">-1</span>,</span><br><span class="line">				<span class="string">&quot;msg&quot;</span>:  err.Error(),</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">&quot;msg&quot;</span>:  <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-4-错误翻译器"><a href="#4-4-4-错误翻译器" class="headerlink" title="4.4.4 错误翻译器"></a>4.4.4 错误翻译器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 定义翻译器 translator.go</span></span><br><span class="line"><span class="keyword">package</span> translator</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin/binding&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/go-playground/locales/zh&quot;</span></span><br><span class="line">	ut <span class="string">&quot;github.com/go-playground/universal-translator&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/go-playground/validator/v10&quot;</span></span><br><span class="line">	zhTrans <span class="string">&quot;github.com/go-playground/validator/v10/translations/zh&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	uni      *ut.UniversalTranslator</span><br><span class="line">	validate *validator.Validate</span><br><span class="line">	trans    ut.Translator</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitTrans</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 翻译器</span></span><br><span class="line">	zh := zh.New()</span><br><span class="line">	uni = ut.New(zh, zh)</span><br><span class="line"></span><br><span class="line">	trans, _ = uni.GetTranslator(<span class="string">&quot;zh&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取gin的校验器</span></span><br><span class="line">	validate = binding.Validator.Engine().(*validator.Validate)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注册翻译器</span></span><br><span class="line">	zhTrans.RegisterDefaultTranslations(validate, trans)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Translate</span><span class="params">(err error)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> result []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	errors := err.(validator.ValidationErrors)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, err := <span class="keyword">range</span> errors &#123;</span><br><span class="line">		result = <span class="built_in">append</span>(result, err.Translate(trans))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> strings.Join(result, <span class="string">&quot;; &quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 初始化</span></span><br><span class="line">translator.InitTrans()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 使用实例</span></span><br><span class="line"><span class="keyword">type</span> addUserRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	Username <span class="keyword">string</span> <span class="string">`json:&quot;username&quot; binding:&quot;required,min=3,max=20&quot;`</span></span><br><span class="line">	Password <span class="keyword">string</span> <span class="string">`json:&quot;password&quot; binding:&quot;required,min=6,max=8&quot;`</span></span><br><span class="line">	Email    <span class="keyword">string</span> <span class="string">`json:&quot;email&quot; binding:&quot;omitempty,email&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AddUserHandler</span><span class="params">(c *gin.Context)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> req addUserRequest</span><br><span class="line"></span><br><span class="line">	err := c.ShouldBindJSON(&amp;req)</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, e.ParameterError(translator.Translate(err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 新增用户</span></span><br><span class="line">	srv := &amp;service.AddUserService&#123;&#125;</span><br><span class="line">	err = srv.AddUser(req.Username, req.Password, req.Email)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> srv, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="4-5-响应渲染"><a href="#4-5-响应渲染" class="headerlink" title="4.5 响应渲染"></a>4.5 响应渲染</h2><h3 id="4-5-1-常见格式"><a href="#4-5-1-常见格式" class="headerlink" title="4.5.1 常见格式"></a>4.5.1 常见格式</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;ok&quot;</span>&#125;)</span><br><span class="line">c.XML(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;ok&quot;</span>&#125;)</span><br><span class="line">c.YAML(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;ok&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="4-5-2-ProtoBuf"><a href="#4-5-2-ProtoBuf" class="headerlink" title="4.5.2 ProtoBuf"></a>4.5.2 ProtoBuf</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/protobuf&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		reps := []<span class="keyword">int64</span>&#123;<span class="keyword">int64</span>(<span class="number">1</span>), <span class="keyword">int64</span>(<span class="number">2</span>)&#125;</span><br><span class="line"></span><br><span class="line">		label := <span class="string">&quot;test&quot;</span></span><br><span class="line">		data := &amp;protoexample.Test&#123;</span><br><span class="line">			Label: &amp;label,</span><br><span class="line">			Reps:  reps,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c.ProtoBuf(http.StatusOK, data)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-5-3-SecureJSON"><a href="#4-5-3-SecureJSON" class="headerlink" title="4.5.3 SecureJSON"></a>4.5.3 SecureJSON</h3><p>SecureJSON可以防止json劫持，如果返回的数据是数组，则会默认在返回值前加上”while(1)”</p>
<p>JSON劫持，其实就是恶意网站，通过<code>&lt;script&gt;</code>标签获取你的JSON数据，因为JSON数组默认为是可执行的JS，所以通过这种方式，可以获得你的敏感数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// facebook</span></span><br><span class="line">	r.SecureJsonPrefix(<span class="string">&quot;for(;;);&quot;</span>)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		nums := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">		c.SecureJSON(http.StatusOK, nums) <span class="comment">// while(1);[1,2,3,4,5]  默认Google</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-5-4-JSONP"><a href="#4-5-4-JSONP" class="headerlink" title="4.5.4 JSONP"></a>4.5.4 JSONP</h3><p>JSONP可以跨域传输，如果参数中存在回调参数，那么返回的参数将是回调函数的形式</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	data := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	data[<span class="string">&quot;bar&quot;</span>] = <span class="string">&quot;foo&quot;</span></span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.JSONP(http.StatusOK, data)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// http://localhost:8080/test?callback=sayHello</span></span><br><span class="line">	<span class="comment">// sayHello(&#123;&quot;bar&quot;:&quot;foo&quot;&#125;);</span></span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        alert(<span class="built_in">JSON</span>.stringify(data))</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://localhost:8080/jsonp?callback=sayHello&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<h3 id="4-5-5-AsciiJSON"><a href="#4-5-5-AsciiJSON" class="headerlink" title="4.5.5 AsciiJSON"></a>4.5.5 AsciiJSON</h3><p>编码中文、标签等特殊字符</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	data := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;lang&quot;</span>: <span class="string">&quot;中文&quot;</span>,</span><br><span class="line">		<span class="string">&quot;tag&quot;</span>:  <span class="string">&quot;&lt;xml&gt;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.AsciiJSON(http.StatusOK, data)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &#123;&quot;lang&quot;:&quot;\u4e2d\u6587&quot;,&quot;tag&quot;:&quot;\u003cxml\u003e&quot;&#125;</span></span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-5-6-PureJSON"><a href="#4-5-6-PureJSON" class="headerlink" title="4.5.6 PureJSON"></a>4.5.6 PureJSON</h3><p>JSON会将特殊的HTML字符替换为对应的unicode字符, 但PureJSON保留原有格式</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.PureJSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;html&quot;</span>: <span class="string">&quot;&lt;h1&gt;Hello World&lt;/h1&gt;&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &#123;&quot;html&quot;:&quot;&lt;h1&gt;Hello World&lt;/h1&gt;&quot;&#125;</span></span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-5-7-jsoniter"><a href="#4-5-7-jsoniter" class="headerlink" title="4.5.7 jsoniter"></a>4.5.7 jsoniter</h3><p>高性能json工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import jsoniter &quot;github.com/json-iterator/go&quot;</span><br><span class="line"></span><br><span class="line">var json = jsoniter.ConfigCompatibleWithStandardLibrary</span><br><span class="line">json.Marshal(&amp;data)</span><br><span class="line">json.Unmarshal(input, &amp;data)</span><br></pre></td></tr></table></figure>

<p>Gin 默认使用 <code>encoding/json</code>，可以在编译中使用标签将其修改为 <a target="_blank" rel="noopener" href="https://github.com/json-iterator/go">jsoniter</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build -tags=jsoniter .</span><br></pre></td></tr></table></figure>



<h2 id="4-6-静态文件"><a href="#4-6-静态文件" class="headerlink" title="4.6 静态文件"></a>4.6 静态文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.String(http.StatusOK, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Static(<span class="string">&quot;/assets&quot;</span>, <span class="string">&quot;./assets&quot;</span>)</span><br><span class="line">	r.StaticFS(<span class="string">&quot;/disk&quot;</span>, http.Dir(<span class="string">`E:\Download`</span>))</span><br><span class="line">	r.StaticFile(<span class="string">&quot;favicon.ico&quot;</span>, <span class="string">&quot;./assets/favicon.ico&quot;</span>)</span><br><span class="line"></span><br><span class="line">	r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-7-代理下载文件"><a href="#4-7-代理下载文件" class="headerlink" title="4.7 代理下载文件"></a>4.7 代理下载文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">downloadFromUrl</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	url := c.Query(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">	resp, err := http.Get(url)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || resp.StatusCode != http.StatusOK &#123;</span><br><span class="line">		c.Status(http.StatusServiceUnavailable)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	arr := strings.Split(url, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">	filename := arr[<span class="built_in">len</span>(arr)<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">	reader := resp.Body</span><br><span class="line">	contentLength := resp.ContentLength</span><br><span class="line">	contentType := resp.Header.Get(<span class="string">&quot;Content-Type&quot;</span>)</span><br><span class="line"></span><br><span class="line">	extraHeaders := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">&quot;Content-Disposition&quot;</span>: fmt.Sprintf(<span class="string">&quot;attachment; filename=%s&quot;</span>, filename),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.DataFromReader(http.StatusOK, contentLength, contentType, reader, extraHeaders)</span><br></pre></td></tr></table></figure>



<h2 id="4-8-HTML渲染"><a href="#4-8-HTML渲染" class="headerlink" title="4.8 HTML渲染"></a>4.8 HTML渲染</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//r.LoadHTMLFiles(&quot;templates/index.tmpl&quot;, &quot;templates/login.tmpl&quot;)</span></span><br><span class="line">	r.LoadHTMLGlob(<span class="string">&quot;templates/*&quot;</span>)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.HTML(http.StatusOK, <span class="string">&quot;index.tmpl&quot;</span>, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;title&quot;</span>: <span class="string">&quot;Home Page&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">        &#123;&#123; .title &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="4-9-重定向"><a href="#4-9-重定向" class="headerlink" title="4.9 重定向"></a>4.9 重定向</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 外部重定向</span></span><br><span class="line">	r.GET(<span class="string">&quot;/test1&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.Redirect(http.StatusMovedPermanently, <span class="string">&quot;https://google.com&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 路由重定向 HandleContext</span></span><br><span class="line">	r.GET(<span class="string">&quot;/test2&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.Request.URL.Path = <span class="string">&quot;/test3&quot;</span></span><br><span class="line">		r.HandleContext(c)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test3&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.String(http.StatusOK, <span class="string">&quot;hello world!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.Request.URL.Path = <span class="string">&quot;/test2&quot;</span></span><br><span class="line">		r.HandleContext(c)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test2&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;hello world!&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-10-支持https"><a href="#4-10-支持https" class="headerlink" title="4.10 支持https"></a>4.10 支持https</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;golang.org/x/crypto/acme/autocert&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/autotls&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.String(http.StatusOK, <span class="string">&quot;pong&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	m := autocert.Manager&#123;</span><br><span class="line">		Prompt:     autocert.AcceptTOS,</span><br><span class="line">		HostPolicy: autocert.HostWhitelist(<span class="string">&quot;localhost:8080&quot;</span>, <span class="string">&quot;example1.com&quot;</span>, <span class="string">&quot;example2.com&quot;</span>),</span><br><span class="line">		Cache:      autocert.DirCache(<span class="string">&quot;/var/www/.cache&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Fatal(autotls.RunWithManager(r, &amp;m))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-11-使用cookie"><a href="#4-11-使用cookie" class="headerlink" title="4.11 使用cookie"></a>4.11 使用cookie</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/test&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		cookie, err := c.Cookie(<span class="string">&quot;gin_cookie&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			cookie = <span class="string">&quot;NO_SET&quot;</span></span><br><span class="line">			c.SetCookie(<span class="string">&quot;gin_cookie&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="number">3600</span>, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;localhost&quot;</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c.String(http.StatusOK, <span class="string">&quot;cookie=%s&quot;</span>, cookie)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-13-服务配置"><a href="#4-13-服务配置" class="headerlink" title="4.13 服务配置"></a>4.13 服务配置</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">	Addr           <span class="keyword">string</span></span><br><span class="line">	Handler        http.Handler</span><br><span class="line">	TLSConfig      *tls.Config</span><br><span class="line">	ReadTimeout    time.Duration</span><br><span class="line">	ReadHeaderTime time.Duration</span><br><span class="line">	WriteTimeout   time.Duration</span><br><span class="line">	IdleTimeout    time.Duration</span><br><span class="line">	MaxHeaderBytes <span class="keyword">int</span></span><br><span class="line">	ConnState      <span class="function"><span class="keyword">func</span><span class="params">(net.Conn, http.ConnState)</span></span></span><br><span class="line">	ErrorLog       *log.Logger</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line"></span><br><span class="line">    s := &amp;http.Server&#123;</span><br><span class="line">        Addr:           <span class="string">&quot;:8080&quot;</span>,</span><br><span class="line">        Handler:        router,</span><br><span class="line">        ReadTimeout:    <span class="number">10</span> * time.Second,</span><br><span class="line">        WriteTimeout:   <span class="number">10</span> * time.Second,</span><br><span class="line">        MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">20</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    s.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-14-使用-goroutine"><a href="#4-14-使用-goroutine" class="headerlink" title="4.14 使用 goroutine"></a>4.14 使用 goroutine</h2><p>在中间件或处理程序中启动 Goroutine 时，需要使用只读副本 <code>c.Copy()</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.GET(<span class="string">&quot;/sync&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		start := time.Now()</span><br><span class="line">		time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">		log.Println(c.Request.URL)</span><br><span class="line">		latency := time.Now().Sub(start)</span><br><span class="line">		c.String(http.StatusOK, latency.String())</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/async&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		start := time.Now()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 协程中使用，必须先复制</span></span><br><span class="line">		cc := c.Copy()</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">			log.Println(cc.Request.URL)</span><br><span class="line">		&#125;()</span><br><span class="line"></span><br><span class="line">		latency := time.Now().Sub(start)</span><br><span class="line">		c.String(http.StatusOK, latency.String())</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="5-运行多个服务"><a href="#5-运行多个服务" class="headerlink" title="5. 运行多个服务"></a>5. 运行多个服务</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/sync/errgroup&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	g errgroup.Group</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">router01</span><span class="params">()</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">	r := gin.New()</span><br><span class="line">	r.Use(gin.Recovery())</span><br><span class="line">	r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;welcome to server 01&quot;</span>&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">router02</span><span class="params">()</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">	r := gin.New()</span><br><span class="line">	r.Use(gin.Recovery())</span><br><span class="line">	r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;welcome to server 02&quot;</span>&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server01 := &amp;http.Server&#123;</span><br><span class="line">		Addr:         <span class="string">&quot;:8080&quot;</span>,</span><br><span class="line">		Handler:      router01(),</span><br><span class="line">		ReadTimeout:  <span class="number">5</span> * time.Second,</span><br><span class="line">		WriteTimeout: <span class="number">10</span> * time.Second,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	server02 := &amp;http.Server&#123;</span><br><span class="line">		Addr:         <span class="string">&quot;:8081&quot;</span>,</span><br><span class="line">		Handler:      router02(),</span><br><span class="line">		ReadTimeout:  <span class="number">5</span> * time.Second,</span><br><span class="line">		WriteTimeout: <span class="number">10</span> * time.Second,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> server01.ListenAndServe()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> server02.ListenAndServe()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := g.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="6-集成JWT"><a href="#6-集成JWT" class="headerlink" title="6. 集成JWT"></a>6. 集成JWT</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/dgrijalva/jwt-go</span><br></pre></td></tr></table></figure>

<p>涉及方法：</p>
<ul>
<li><code>NewWithClaims(method SigningMethod, claims Claims)</code>, method对应着<code>SigningMethodHMAC struct&#123;&#125;</code>，其包含<code>SigningMethodHS256</code>, <code>SigningMethodHS384</code>, <code>SigningMethodHS512</code>三种crypt.Hash</li>
<li><code>func (t *Token) SignedString(key interface&#123;&#125;)</code> 内部生成签名字符串，再用于获取完整、已签名的token</li>
<li><code>func (p *Parser) ParseWithClaims</code>解析鉴权声明，方法内部主要是具体的解码和校验过程，最终返回*Token</li>
<li><code>func (m MapClaims) Valid()</code> 验证基于时间的声明exp, iat, nbf</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;gin-blog/pkg/setting&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	jwt <span class="string">&quot;github.com/dgrijalva/jwt-go&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> jwtSecret = []<span class="keyword">byte</span>(setting.JwtSecret)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Claims <span class="keyword">struct</span> &#123;</span><br><span class="line">	Username <span class="keyword">string</span> <span class="string">`json:&quot;username&quot;`</span></span><br><span class="line">	Password <span class="keyword">string</span> <span class="string">`json:&quot;password&quot;`</span></span><br><span class="line">	jwt.StandardClaims</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenerateToken</span><span class="params">(username, password <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	nowTime := time.Now()</span><br><span class="line">	expireTime := nowTime.Add(<span class="number">3</span> * time.Hour)</span><br><span class="line"></span><br><span class="line">	claims := Claims&#123;</span><br><span class="line">		username,</span><br><span class="line">		password,</span><br><span class="line">		jwt.StandardClaims&#123;</span><br><span class="line">			ExpiresAt: expireTime.Unix(),</span><br><span class="line">			Issuer:    <span class="string">&quot;gin-blog&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tokenClaims := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">	token, err := tokenClaims.SignedString(jwtSecret)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> token, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParseToken</span><span class="params">(token <span class="keyword">string</span>)</span> <span class="params">(*Claims, error)</span></span> &#123;</span><br><span class="line">	tokenClaims, err := jwt.ParseWithClaims(token, &amp;Claims&#123;&#125;,</span><br><span class="line">		<span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> jwtSecret, <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> tokenClaims != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> claims, ok := tokenClaims.Claims.(*Claims); ok &amp;&amp; tokenClaims.Valid &#123;</span><br><span class="line">			<span class="keyword">return</span> claims, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="7-重启服务器"><a href="#7-重启服务器" class="headerlink" title="7. 重启服务器"></a>7. 重启服务器</h1><p>要求：</p>
<ul>
<li>不关闭现有连接 （正在运行中的程序）</li>
<li>新的进程启动并替代旧进程</li>
<li>新的进程结构新的连接</li>
<li>连接要随时响应用户的请求，当用户仍在请求旧进程时，要保持连接，新用户应请求新进程，不可出现拒绝请求的情况</li>
</ul>
<h2 id="7-1-endless"><a href="#7-1-endless" class="headerlink" title="7.1 endless"></a>7.1 endless</h2><p>endless: Zero downtime restarts for golfing HTTP and HTTPS servers</p>
<p>每次更新发布、修改配置文件等，只要给该进行发送SIGTERM信号(kill )，而不需要强制结束应用</p>
<p>监听信号：</p>
<ul>
<li><code>syscall.SIGHUP</code>: 触发fork子进程和重新启动</li>
<li><code>syscall.SIGUSR1/syscall.SIGTSTP</code>: 被监听，但不触发任何动作</li>
<li><code>syscall.SIGUSR2</code>: 触发hammerTime</li>
<li><code>syscall.SIGINT/syscall.SIGTERM</code>: 触发服务器关闭（会完成正在运行的请求）</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;gin-blog/pkg/setting&quot;</span></span><br><span class="line">	<span class="string">&quot;gin-blog/routers&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/fvbock/endless&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//router := routers.InitRouter()</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//server := &amp;http.Server&#123;</span></span><br><span class="line">	<span class="comment">//	Addr:           fmt.Sprintf(&quot;:%d&quot;, setting.HTTPPort),</span></span><br><span class="line">	<span class="comment">//	Handler:        router,</span></span><br><span class="line">	<span class="comment">//	ReadTimeout:    setting.ReadTimeout,</span></span><br><span class="line">	<span class="comment">//	WriteTimeout:   setting.WriteTimeout,</span></span><br><span class="line">	<span class="comment">//	MaxHeaderBytes: 1 &lt;&lt; 20,</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">	endless.DefaultReadTimeOut = setting.ReadTimeout</span><br><span class="line">	endless.DefaultWriteTimeOut = setting.WriteTimeout</span><br><span class="line">	endless.DefaultMaxHeaderBytes = <span class="number">1</span> &lt;&lt; <span class="number">20</span></span><br><span class="line">	endPoint := fmt.Sprintf(<span class="string">&quot;:%d&quot;</span>, setting.HTTPPort)</span><br><span class="line"></span><br><span class="line">	server := endless.NewServer(endPoint, routers.InitRouter())</span><br><span class="line">	server.BeforeBegin = <span class="function"><span class="keyword">func</span><span class="params">(add <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;Actual pid is %d&quot;</span>, syscall.Getpid())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err := server.ListenAndServe()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;Server error: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-2-Shutdown"><a href="#7-2-Shutdown" class="headerlink" title="7.2 Shutdown"></a>7.2 Shutdown</h2><p>使用 http.Server 内置的 <code>Shutdown()</code>方法优雅地关闭服务，它不会中断任何活动的连接，直到所有连接处理完毕</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := initRouter()</span><br><span class="line"></span><br><span class="line">	server := &amp;http.Server&#123;</span><br><span class="line">		Addr:           fmt.Sprintf(<span class="string">&quot;:%d&quot;</span>, setting.HTTPPort),</span><br><span class="line">		Handler:        router,</span><br><span class="line">		ReadTimeout:    setting.ReadTimeout,</span><br><span class="line">		WriteTimeout:   setting.WriteTimeout,</span><br><span class="line">		MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">20</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := server.ListenAndServe(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;Listen: %v\n&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</span><br><span class="line">	signal.Notify(quit, os.Interrupt)</span><br><span class="line">	&lt;-quit</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">&quot;Shutdown Server ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := server.Shutdown(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;Server Shutdown:&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">&quot;Server exiting&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="8-Swagger-API"><a href="#8-Swagger-API" class="headerlink" title="8. Swagger API"></a>8. Swagger API</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/swaggo/swag/cmd/swag</span><br><span class="line">go get -u github.com/swaggo/gin-swagger</span><br><span class="line">go get -u github.com/swaggo/gin-swagger/swaggerFiles</span><br></pre></td></tr></table></figure>



<h2 id="8-1-API-接口注释"><a href="#8-1-API-接口注释" class="headerlink" title="8.1 API 接口注释"></a>8.1 API 接口注释</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LoginHandler godoc</span></span><br><span class="line"><span class="comment">// @Summary 登录系统</span></span><br><span class="line"><span class="comment">// @Tags 用户相关接口</span></span><br><span class="line"><span class="comment">// @Accept  json</span></span><br><span class="line"><span class="comment">// @Produce  json</span></span><br><span class="line"><span class="comment">// @Param object body loginRequest true &quot;请求参数&quot;</span></span><br><span class="line"><span class="comment">// @Success 200 &#123;object&#125; router.Response</span></span><br><span class="line"><span class="comment">// @Failure 400 &#123;object&#125; e.ApiError</span></span><br><span class="line"><span class="comment">// @Router /api/v1/login [post]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoginHandler</span><span class="params">(c *gin.Context)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> req loginRequest</span><br><span class="line"></span><br><span class="line">	err := c.ShouldBindJSON(&amp;req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, e.ParameterError(translator.Translate(err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 登录</span></span><br><span class="line">	srv := &amp;service.LoginService&#123;&#125;</span><br><span class="line">	err = srv.Login(req.Username, req.Password)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, e.ParameterError(translator.Translate(err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> srv, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8-2-生成配置"><a href="#8-2-生成配置" class="headerlink" title="8.2 生成配置"></a>8.2 生成配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swag init</span><br></pre></td></tr></table></figure>



<h2 id="8-3-引入配置"><a href="#8-3-引入配置" class="headerlink" title="8.3 引入配置"></a>8.3 引入配置</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// swagger 相关信息</span></span><br><span class="line">	docs.SwaggerInfo.Title = <span class="string">&quot;XXX 项目接口文档&quot;</span></span><br><span class="line">	docs.SwaggerInfo.Description = <span class="string">&quot;just a test&quot;</span></span><br><span class="line">	docs.SwaggerInfo.Version = <span class="string">&quot;1.0&quot;</span></span><br><span class="line">	docs.SwaggerInfo.Host = addr</span><br><span class="line">	docs.SwaggerInfo.BasePath = <span class="string">&quot;/&quot;</span></span><br><span class="line">	docs.SwaggerInfo.Schemes = []<span class="keyword">string</span>&#123;<span class="string">&quot;http&quot;</span>, <span class="string">&quot;https&quot;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8-4-禁用Swagger"><a href="#8-4-禁用Swagger" class="headerlink" title="8.4 禁用Swagger"></a>8.4 禁用Swagger</h2><p><code>gin-swagger</code>还提供了<code>DisablingWrapHandler</code>函数，方便我们通过设置某些环境变量来。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r.GET(&quot;/swagger/*any&quot;, gs.DisablingWrapHandler(swaggerFiles.Handler, &quot;NAME_OF_ENV_VARIABLE&quot;))</span><br></pre></td></tr></table></figure>

<p>此时如果将环境变量<code>NAME_OF_ENV_VARIABLE</code>设置为任意值，则<code>/swagger/*any</code>将返回404响应，就像未指定路由时一样。</p>
<h1 id="9-接口测试"><a href="#9-接口测试" class="headerlink" title="9. 接口测试"></a>9. 接口测试</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http/httptest&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/stretchr/testify/assert&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func setRouter() *gin.Engine &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.GET(<span class="string">&quot;/ping&quot;</span>, func(c *gin.Context) &#123;</span><br><span class="line">		c.String(http.StatusOK, <span class="string">&quot;pong&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="built_in">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func TestPingRoute(t *testing.T) &#123;</span><br><span class="line">	router := setRouter()</span><br><span class="line"></span><br><span class="line">	w := httptest.NewRecorder()</span><br><span class="line">	req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/ping&quot;</span>, nil)</span><br><span class="line">	router.ServeHTTP(w, req)</span><br><span class="line"></span><br><span class="line">	assert.Equal(t, http.StatusOK, w.Code)</span><br><span class="line">	assert.Equal(t, <span class="string">&quot;pong&quot;</span>, w.Body.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="10-源码解析"><a href="#10-源码解析" class="headerlink" title="10. 源码解析"></a>10. 源码解析</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取一个gin框架实例</span></span><br><span class="line">gin.Default()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体的Default方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Default</span><span class="params">()</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">    <span class="comment">// 调试模式日志输出 </span></span><br><span class="line">	debugPrintWARNINGDefault()</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 创建一个gin框架实例</span></span><br><span class="line">    engine := New()</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 注册中间件的方式一致</span></span><br><span class="line">	engine.Use(Logger(), Recovery())</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个gin框架实例 具体方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">    <span class="comment">// 调试模式日志输出 </span></span><br><span class="line">	debugPrintWARNINGNew()</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 初始化一个Engine实例</span></span><br><span class="line">    engine := &amp;Engine&#123;</span><br><span class="line">        <span class="comment">// 给框架实例绑定上一个路由组</span></span><br><span class="line">        RouterGroup: RouterGroup&#123;</span><br><span class="line">            Handlers: <span class="literal">nil</span>,   <span class="comment">// engine.Use 注册的中间方法到这里</span></span><br><span class="line">            basePath: <span class="string">&quot;/&quot;</span>,  </span><br><span class="line">            root:     <span class="literal">true</span>,   <span class="comment">// 是否是路由根节点</span></span><br><span class="line">        &#125;,</span><br><span class="line">        FuncMap:                template.FuncMap&#123;&#125;,</span><br><span class="line">        RedirectTrailingSlash:  <span class="literal">true</span>,</span><br><span class="line">        RedirectFixedPath:      <span class="literal">false</span>,</span><br><span class="line">        HandleMethodNotAllowed: <span class="literal">false</span>,</span><br><span class="line">        ForwardedByClientIP:    <span class="literal">true</span>,</span><br><span class="line">        AppEngine:              defaultAppEngine,</span><br><span class="line">        UseRawPath:             <span class="literal">false</span>,</span><br><span class="line">        UnescapePathValues:     <span class="literal">true</span>,</span><br><span class="line">        MaxMultipartMemory:     defaultMultipartMemory,</span><br><span class="line">        trees:                  <span class="built_in">make</span>(methodTrees, <span class="number">0</span>, <span class="number">9</span>),   <span class="comment">// 路由树</span></span><br><span class="line">        delims:                 render.Delims&#123;Left: <span class="string">&quot;&#123;&#123;&quot;</span>, Right: <span class="string">&quot;&#125;&#125;&quot;</span>&#125;,</span><br><span class="line">        secureJsonPrefix:       <span class="string">&quot;while(1);&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// RouterGroup绑定engine自身的实例</span></span><br><span class="line">	engine.RouterGroup.engine = engine</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 绑定从实例池获取上下文的闭包方法</span></span><br><span class="line">    engine.pool.New = <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">        <span class="comment">// 获取一个Context实例</span></span><br><span class="line">        <span class="keyword">return</span> engine.allocateContext()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回框架实例</span></span><br><span class="line">    <span class="keyword">return</span> engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册日志&amp;goroutin panic捕获中间件</span></span><br><span class="line">engine.Use(Logger(), Recovery())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体的注册中间件的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Use</span><span class="params">(middleware ...HandlerFunc)</span> <span class="title">IRoutes</span></span> &#123;</span><br><span class="line">    engine.RouterGroup.Use(middleware...)</span><br><span class="line">    engine.rebuild404Handlers()</span><br><span class="line">    engine.rebuild405Handlers()</span><br><span class="line">    <span class="keyword">return</span> engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册GET请求路由</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">GET</span><span class="params">(relativePath <span class="keyword">string</span>, handlers ...HandlerFunc)</span> <span class="title">IRoutes</span></span> &#123;</span><br><span class="line">    <span class="comment">// 往路由组内 注册GET请求路由</span></span><br><span class="line">    <span class="keyword">return</span> group.handle(<span class="string">&quot;GET&quot;</span>, relativePath, handlers)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">handle</span><span class="params">(httpMethod, relativePath <span class="keyword">string</span>, handlers HandlersChain)</span> <span class="title">IRoutes</span></span> &#123;</span><br><span class="line">	absolutePath := group.calculateAbsolutePath(relativePath)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 把中间件的handle和该路由的handle合并</span></span><br><span class="line">	handlers = group.combineHandlers(handlers)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 注册一个GET集合的路由</span></span><br><span class="line">    group.engine.addRoute(httpMethod, absolutePath, handlers)</span><br><span class="line">    <span class="keyword">return</span> group.returnObj()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">addRoute</span><span class="params">(method, path <span class="keyword">string</span>, handlers HandlersChain)</span></span> &#123;</span><br><span class="line">    assert1(path[<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>, <span class="string">&quot;path must begin with &#x27;/&#x27;&quot;</span>)</span><br><span class="line">    assert1(method != <span class="string">&quot;&quot;</span>, <span class="string">&quot;HTTP method can not be empty&quot;</span>)</span><br><span class="line">    assert1(<span class="built_in">len</span>(handlers) &gt; <span class="number">0</span>, <span class="string">&quot;there must be at least one handler&quot;</span>)</span><br><span class="line"></span><br><span class="line">	debugPrintRoute(method, path, handlers)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 检查有没有对应method集合的路由</span></span><br><span class="line">    root := engine.trees.get(method)</span><br><span class="line">    <span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 没有 创建一个新的路由节点</span></span><br><span class="line">		root = <span class="built_in">new</span>(node)</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 添加该method的路由tree到当前的路由到路由树里</span></span><br><span class="line">        engine.trees = <span class="built_in">append</span>(engine.trees, methodTree&#123;method: method, root: root&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 添加路由</span></span><br><span class="line">    root.addRoute(path, handlers)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由树节点</span></span><br><span class="line"><span class="keyword">type</span> node <span class="keyword">struct</span> &#123;</span><br><span class="line">    path      <span class="keyword">string</span></span><br><span class="line">    indices   <span class="keyword">string</span></span><br><span class="line">    children  []*node</span><br><span class="line">    handlers  HandlersChain   <span class="comment">// 所有的handle 构成一个链</span></span><br><span class="line">    priority  <span class="keyword">uint32</span></span><br><span class="line">    nType     nodeType</span><br><span class="line">    maxParams <span class="keyword">uint8</span></span><br><span class="line">    wildChild <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动http server</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Run</span><span class="params">(addr ...<span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; debugPrintError(err) &#125;()</span><br><span class="line"></span><br><span class="line">    address := resolveAddress(addr)</span><br><span class="line">	debugPrint(<span class="string">&quot;Listening and serving HTTP on %s\n&quot;</span>, address)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 执行http包的ListenAndServe方法 启动路由</span></span><br><span class="line">    err = http.ListenAndServe(address, engine)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// engine自身就实现了Handler接口</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">    ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听IP+端口</span></span><br><span class="line">ln, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接着就是Serve</span></span><br><span class="line">srv.Serve(tcpKeepAliveListener&#123;ln.(*net.TCPListener)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Accept请求</span></span><br><span class="line">rw, e := l.Accept()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用goroutine去处理一个请求，最终就执行的是engine的ServeHTTP方法</span></span><br><span class="line"><span class="keyword">go</span> c.serve(ctx)</span><br><span class="line"></span><br><span class="line"><span class="comment">// engine实现http.Handler接口ServeHTTP的具体方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 获取一个上下文实例，从实例池获取 性能高</span></span><br><span class="line">	c := engine.pool.Get().(*Context)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 重置获取到的上下文实例的http.ResponseWriter</span></span><br><span class="line">	c.writermem.reset(w)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 重置获取到的上下文实例*http.Request</span></span><br><span class="line">	c.Request = req</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 重置获取到的上下文实例的其他属性</span></span><br><span class="line">    c.reset()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实际处理请求的地方，传递当前的上下文</span></span><br><span class="line">    engine.handleHTTPRequest(c)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//归还上下文实例</span></span><br><span class="line">    engine.pool.Put(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体执行路由的方法</span></span><br><span class="line">engine.handleHTTPRequest(c)</span><br><span class="line"></span><br><span class="line">t := engine.trees</span><br><span class="line"><span class="keyword">for</span> i, tl := <span class="number">0</span>, <span class="built_in">len</span>(t); i &lt; tl; i++ &#123;</span><br><span class="line">    <span class="comment">// 遍历路由树，查找当前请求method</span></span><br><span class="line">    <span class="keyword">if</span> t[i].method != httpMethod &#123;</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 找到节点</span></span><br><span class="line">	root := t[i].root</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 寻找当前请求的路由</span></span><br><span class="line">    handlers, params, tsr := root.getValue(path, c.Params, unescape)</span><br><span class="line">    <span class="keyword">if</span> handlers != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 把找到的handles赋值给上下文</span></span><br><span class="line">        c.handlers = handlers</span><br><span class="line">        <span class="comment">// 把找到的入参赋值给上下文</span></span><br><span class="line">        c.Params = params</span><br><span class="line">        <span class="comment">// 执行handle</span></span><br><span class="line">        c.Next()</span><br><span class="line">        <span class="comment">// 处理响应内容</span></span><br><span class="line">        c.writermem.WriteHeaderNow()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法树结构体</span></span><br><span class="line"><span class="keyword">type</span> methodTree <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// HTTP Method</span></span><br><span class="line">    method <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// 当前HTTP Method的路由节点</span></span><br><span class="line">    root   *node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法树集合</span></span><br><span class="line"><span class="keyword">type</span> methodTrees []methodTree</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行handle</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Next</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 上下文处理之后c.index被执为-1</span></span><br><span class="line">    c.index++</span><br><span class="line">    <span class="keyword">for</span> s := <span class="keyword">int8</span>(<span class="built_in">len</span>(c.handlers)); c.index &lt; s; c.index++ &#123;</span><br><span class="line">        <span class="comment">// 遍历执行所有handle(其实就是中间件+路由handle)</span></span><br><span class="line">        c.handlers[c.index](c)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Context的重置方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">reset</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c.Writer = &amp;c.writermem</span><br><span class="line">    c.Params = c.Params[<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">    c.handlers = <span class="literal">nil</span></span><br><span class="line">    <span class="comment">// 很关键 注意这里是-1哦</span></span><br><span class="line">    c.index = <span class="number">-1</span></span><br><span class="line">    c.Keys = <span class="literal">nil</span></span><br><span class="line">    c.Errors = c.Errors[<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">    c.Accepted = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/platform/gin-architecture.png" alt="img"> </p>

      </div>
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-07-12T20:38:39+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>更新于 2021年7月12日</p>
  </a>
</div>

        
      
        
          

        
      
        
          

        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                          <h4>
                              <a href="/2019/05/18/Go%20GORM/" rel="prev" title="Go GORM">
                                
                                    Go GORM
                                
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2019/05/16/Go%20OS%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE/" rel="prev" title="Go OS性能数据">
                                  
                                      Go OS性能数据
                                  
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Go Gin框架',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
      
        
          
          
            
              <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:eli.he@outlook.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/elihe2011"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=282243842"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Gin%E7%AE%80%E4%BB%8B"><span class="toc-text">1. Gin简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%A0%B8%E5%BF%83%E6%9C%AF%E8%AF%AD"><span class="toc-text">1.1 核心术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-HttpRouter"><span class="toc-text">1.2 HttpRouter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8"><span class="toc-text">2. 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85"><span class="toc-text">2.1 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%85%A5%E9%97%A8"><span class="toc-text">2.2 入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-text">2.3 请求参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E8%B7%AF%E7%94%B1%E5%8F%82%E6%95%B0"><span class="toc-text">2.3.1 路由参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-Query%E5%8F%82%E6%95%B0"><span class="toc-text">2.3.2 Query参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-Form%E5%8F%82%E6%95%B0"><span class="toc-text">2.3.3 Form参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%8F%82%E6%95%B0%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-text">2.3.4 参数相关方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-text">2.4 文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E5%8D%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">2.4.1 单文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">2.4.2 多文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD"><span class="toc-text">2.4.3 文件下载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="toc-text">4. 高级功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84"><span class="toc-text">4.1 路由分组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text">4.2 中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text">4.2.1 自定义中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-BasicAuth%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text">4.2.2 BasicAuth中间件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97"><span class="toc-text">4.3 记录日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-text">4.3.1 日志文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-text">4.3.2 日志格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%A8%A1%E5%9E%8B%E7%BB%91%E5%AE%9A%E5%92%8C%E9%AA%8C%E8%AF%81"><span class="toc-text">4.4 模型绑定和验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A"><span class="toc-text">4.4.1 请求参数绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E5%99%A8"><span class="toc-text">4.4.2 自定义校验器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E7%BB%91%E5%AE%9Auri"><span class="toc-text">4.4.3 绑定uri</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-4-%E9%94%99%E8%AF%AF%E7%BF%BB%E8%AF%91%E5%99%A8"><span class="toc-text">4.4.4 错误翻译器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E5%93%8D%E5%BA%94%E6%B8%B2%E6%9F%93"><span class="toc-text">4.5 响应渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-1-%E5%B8%B8%E8%A7%81%E6%A0%BC%E5%BC%8F"><span class="toc-text">4.5.1 常见格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-2-ProtoBuf"><span class="toc-text">4.5.2 ProtoBuf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-3-SecureJSON"><span class="toc-text">4.5.3 SecureJSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-4-JSONP"><span class="toc-text">4.5.4 JSONP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-5-AsciiJSON"><span class="toc-text">4.5.5 AsciiJSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-6-PureJSON"><span class="toc-text">4.5.6 PureJSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-7-jsoniter"><span class="toc-text">4.5.7 jsoniter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-text">4.6 静态文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-%E4%BB%A3%E7%90%86%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-text">4.7 代理下载文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-HTML%E6%B8%B2%E6%9F%93"><span class="toc-text">4.8 HTML渲染</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">4.9 重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10-%E6%94%AF%E6%8C%81https"><span class="toc-text">4.10 支持https</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-11-%E4%BD%BF%E7%94%A8cookie"><span class="toc-text">4.11 使用cookie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-13-%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-text">4.13 服务配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14-%E4%BD%BF%E7%94%A8-goroutine"><span class="toc-text">4.14 使用 goroutine</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-text">5. 运行多个服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E9%9B%86%E6%88%90JWT"><span class="toc-text">6. 集成JWT</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">7. 重启服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-endless"><span class="toc-text">7.1 endless</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-Shutdown"><span class="toc-text">7.2 Shutdown</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Swagger-API"><span class="toc-text">8. Swagger API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-API-%E6%8E%A5%E5%8F%A3%E6%B3%A8%E9%87%8A"><span class="toc-text">8.1 API 接口注释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E7%94%9F%E6%88%90%E9%85%8D%E7%BD%AE"><span class="toc-text">8.2 生成配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E5%BC%95%E5%85%A5%E9%85%8D%E7%BD%AE"><span class="toc-text">8.3 引入配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-%E7%A6%81%E7%94%A8Swagger"><span class="toc-text">8.4 禁用Swagger</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">9. 接口测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-text">10. 源码解析</span></a></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/categories/"
    title="blog/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/CentOS/" href="/categories/CentOS/"><div class='name'>CentOS</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Docker/" href="/categories/Docker/"><div class='name'>Docker</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Golang/" href="/categories/Golang/"><div class='name'>Golang</div><div class='badge'>(39)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Linux/" href="/categories/Linux/"><div class='name'>Linux</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/MySQL/" href="/categories/MySQL/"><div class='name'>MySQL</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Nginx/" href="/categories/Nginx/"><div class='name'>Nginx</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/NoSQL/" href="/categories/NoSQL/"><div class='name'>NoSQL</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/RabbitMQ/" href="/categories/RabbitMQ/"><div class='name'>RabbitMQ</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Tools/" href="/categories/Tools/"><div class='name'>Tools</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/golang/" href="/categories/golang/"><div class='name'>golang</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/k8s/" href="/categories/k8s/"><div class='name'>k8s</div><div class='badge'>(9)</div></a></li>
        
          <li><a class="flat-box" title="/categories/kubernetes/" href="/categories/kubernetes/"><div class='name'>kubernetes</div><div class='badge'>(3)</div></a></li>
        
      </ul>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget tagcloud'>
    
<header class='pure'>
  <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/tags/"
    title="blog/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <a href="/tags/algorithm/" style="font-size: 17.33px; color: #828282">algorithm</a> <a href="/tags/elasticsearch/" style="font-size: 14px; color: #999">elasticsearch</a> <a href="/tags/git/" style="font-size: 14px; color: #999">git</a> <a href="/tags/go/" style="font-size: 24px; color: #555">go</a> <a href="/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/tags/mongodb/" style="font-size: 14px; color: #999">mongodb</a> <a href="/tags/nginx/" style="font-size: 14px; color: #999">nginx</a> <a href="/tags/orm/" style="font-size: 14px; color: #999">orm</a> <a href="/tags/rabbitmq/" style="font-size: 14px; color: #999">rabbitmq</a> <a href="/tags/redis/" style="font-size: 14px; color: #999">redis</a> <a href="/tags/rpc/" style="font-size: 20.67px; color: #6c6c6c">rpc</a> <a href="/tags/supervisor/" style="font-size: 14px; color: #999">supervisor</a> <a href="/tags/websocket/" style="font-size: 14px; color: #999">websocket</a>
    </div>
  </section>


            
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:eli.he@outlook.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/elihe2011"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/#/user/home?id=282243842"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="/js/app.js"></script>



  
<script src="/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
