<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>MySQL | Eli&#39;s Blog</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/favicon/favicon.ico">
  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Eli's Blog</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Eli's Blog
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" target="_blank" href="https://xaoxuu.com/wiki/material-x/"
                
                  rel="nofollow noopener"
                
                
                id="https:xaoxuu.comwikimaterial-x">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2020/03/24/MySQL/">
        MySQL
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="https://elihe2011.github.io" rel="nofollow">
        
          <img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png">
        
        <p>Eli He</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2020-03-24</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/MySQL/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>MySQL</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h1><h2 id="1-1-架构图"><a href="#1-1-架构图" class="headerlink" title="1.1 架构图"></a>1.1 架构图</h2><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-arch.png" alt="a"></p>
<h2 id="1-2-SQL-执行流程"><a href="#1-2-SQL-执行流程" class="headerlink" title="1.2 SQL 执行流程"></a>1.2 SQL 执行流程</h2><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-execute-sql.png" alt="a"></p>
<span id="more"></span>

<p><strong>连接器:</strong> 处理客户端的连接、获取用户权限、维持和管理连接</p>
<p><strong>查询缓存</strong>: 连接器拿到查询SQL后，先通过key-value方式查询缓存，如果缓存存在则直接返回。但是，它非常容易失效，只要表进行了更新，该表相关的所有查询缓存都会被清空。MySQL 8.0 已删除该功能</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@query</span>_cache_type;</span><br></pre></td></tr></table></figure>

<p><strong>分析器</strong>:</p>
<ul>
<li><p>词法分析 (识别关键字，操作，表名，列名)</p>
</li>
<li><p>语法分析 (判断是否符合语法）</p>
</li>
</ul>
<p><strong>优化器:</strong> 决定使用哪个索引；有多表关联时，决定表的连接顺序。最后输出执行方案</p>
<p><strong>执行器:</strong> 执行SQL时，先判断用户是否对表有查询权限。如果没有，返回没有权限的错误。如果有权限，执行语句扫描表中的数据</p>
<h2 id="1-3-数据类型"><a href="#1-3-数据类型" class="headerlink" title="1.3 数据类型"></a>1.3 数据类型</h2><ul>
<li>DECIMAL：高精度。float/double 浮点数近似值</li>
<li>CHAR：定长，存取效率高；VARCHAR变长，节约磁盘空间。</li>
<li>VARCHAR(50)和VARCHAR(200): 存储相同字符串，所占空间相同，但后者在排序时会消耗更多内存，因为order by采取fixed_length计算col长度。</li>
<li>INT(10): 10表示数据的长度，不是存储数据的大小。</li>
<li>CHAR(10): 10位固定字符串，不足补空格</li>
<li>VARCHAR(10): 10位可变字符串，不补空格</li>
<li>TEXT/BLOB：尽量避免使用，查询时会使用临时表，导致严重性能开销</li>
<li>TIMESTAMP：比 datetime 空间效率高</li>
</ul>
<h1 id="2-引擎"><a href="#2-引擎" class="headerlink" title="2. 引擎"></a>2. 引擎</h1><table>
<thead>
<tr>
<th></th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>存储结构</td>
<td>每张表三个文件：表结构(.frm)，表数据(.MYD)，表索引(.MYI)</td>
<td>所有表存储在一个或多个文件中，甚至独立的表空间文件中。</td>
</tr>
<tr>
<td>存储空间</td>
<td>可被压缩，存储空间减小</td>
<td>需要更多的内存和存储，会在内存中建立其专用的缓冲池用于高速缓冲数据和索引</td>
</tr>
<tr>
<td>备份恢复</td>
<td>通过拷贝表相关的三个文件即可</td>
<td>拷贝数据文件、备份binlog，或使用mysqldump。</td>
</tr>
<tr>
<td>文件格式</td>
<td>数据和索引分开存储 <code>.MYD</code> &amp; <code>.MYI</code></td>
<td>数据和索引集中存储  <code>.idb</code></td>
</tr>
<tr>
<td>存储顺序</td>
<td>按记录插入顺序保存</td>
<td>按主键大小有序插入</td>
</tr>
<tr>
<td>外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>锁</td>
<td>表锁，不适合高并发</td>
<td>表锁、行锁，适合高并发</td>
</tr>
<tr>
<td>SELECT</td>
<td>MyIASM 更优</td>
<td></td>
</tr>
<tr>
<td>I &amp; U &amp; D</td>
<td></td>
<td>InnoDB 更优</td>
</tr>
<tr>
<td>索引实现方式</td>
<td>B+树，堆表</td>
<td>B+树，索引组织表</td>
</tr>
<tr>
<td>哈希索引</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>全文索引</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<h2 id="2-1-聚簇索引"><a href="#2-1-聚簇索引" class="headerlink" title="2.1 聚簇索引"></a>2.1 聚簇索引</h2><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-clustered-index-innodb.png" alt="a"></p>
<p>聚簇索引：叶节点存储了行数据、主键及其他索引的列数据。主键索引、覆盖索引都非常高效。</p>
<p>非聚簇索引：叶节点只存储了行数据地址，需要再次寻址才能得到数据</p>
<p>InnoDB: 主键使用聚簇索引</p>
<p>MyISAM: 主键和普通索引，都是非聚合索引</p>
<p>聚簇索引优点：数据检索高效</p>
<p>聚簇索引缺点：</p>
<ul>
<li>插入速度严重依赖插入顺序</li>
<li>更新主键代价很高，会导致被更新行移动</li>
<li>二级索引访问需要两次索引查找，第一次找主键，第二次根据主键找到数据</li>
</ul>
<h2 id="2-2-InnoDB"><a href="#2-2-InnoDB" class="headerlink" title="2.2 InnoDB"></a>2.2 InnoDB</h2><p><strong>支持事务、行锁、外键约束，MyISAM均不支持</strong>。</p>
<p>InnoDB 的四大特性：</p>
<ul>
<li>插入缓冲 (insert buffer)</li>
<li>二次写 (double write)</li>
<li>自适应哈希索引 (ahi)</li>
<li>预读 (read ahead)</li>
</ul>
<h1 id="3-索引"><a href="#3-索引" class="headerlink" title="3. 索引"></a>3. 索引</h1><h2 id="3-1-什么是索引"><a href="#3-1-什么是索引" class="headerlink" title="3.1 什么是索引"></a>3.1 什么是索引</h2><p>索引是一种特殊的文件，它采用排序的数据结构，保存表中记录的引用指针。能实现快速检索表数据。底层实现为B树及B+树。</p>
<p><strong>索引原理：</strong></p>
<ul>
<li>把创建了索引的列进行排序</li>
<li>把排序结果生成倒排表</li>
<li>在倒排表内容上拼上数据地址链</li>
<li>查询时，先拿到倒排表内容，再取出地址链，从而拿到具体数据</li>
</ul>
<p><strong>索引的优缺点：</strong></p>
<ul>
<li>优点：提高了数据的检索速度</li>
<li>缺点：<ul>
<li>时间方面：创建和维护索引，到要消耗时间。对表数据进行写操作，索引也要进行维护，从而降低了执行效率</li>
<li>空间方面：需要占用额外的磁盘</li>
</ul>
</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>where</li>
<li>order by, group by</li>
<li>join</li>
</ul>
<p><strong>覆盖索引：</strong>select 的字段，<strong>都建立了索引</strong>，此时将直接从索引表返回数据，不需要再次扫描数据表。索引覆盖能够很大的提高查询效率。</p>
<h2 id="3-2-数据结构"><a href="#3-2-数据结构" class="headerlink" title="3.2 数据结构"></a>3.2 数据结构</h2><h3 id="3-2-1-BTree-amp-B-Tree"><a href="#3-2-1-BTree-amp-B-Tree" class="headerlink" title="3.2.1 BTree &amp; B+Tree"></a>3.2.1 BTree &amp; B+Tree</h3><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-btree-bptree.png" alt="a"></p>
<table>
<thead>
<tr>
<th>BTree</th>
<th>B+Tree</th>
</tr>
</thead>
<tbody><tr>
<td>所有节点都有数据指针</td>
<td>只有叶子节点有数据指针</td>
</tr>
<tr>
<td>key可能不在叶子节点上，因此搜索需要更多时间</td>
<td>key都在叶子节点上，因此搜索更快，更准</td>
</tr>
<tr>
<td>树中没有key的重复项</td>
<td>key重复，所有节点都在叶子上</td>
</tr>
<tr>
<td>插入会耗费更多时间</td>
<td>插入容易</td>
</tr>
<tr>
<td>内部节点删除非常复杂，树需要进行大量转换</td>
<td>删除任何节点都很容易，因为所有节点都在叶子节点上</td>
</tr>
<tr>
<td>叶子节点不存储为结构链表</td>
<td>叶子节点存储为结构链表</td>
</tr>
<tr>
<td>没有多余的搜索键</td>
<td>可能存在冗余的搜索键</td>
</tr>
</tbody></table>
<p><strong>B+树优于B树的原因：</strong></p>
<ul>
<li><strong>B+树空间利用率更高，可减少IO次数，磁盘读写代价更低</strong>。因为B+树内部节点没有指向关键字具体信息的指针，只做索引使用，内部节点相对B树小</li>
<li><strong>B+树的查询效率更加稳定</strong>。B+树所有关键字的查询路径长度相同，导致每个关键字的查询效率相当。</li>
<li><strong>B+树增删节点的效率更高</strong>。</li>
</ul>
<p><strong>相关树总结：</strong></p>
<ul>
<li><p>平衡二叉树：基于二分法的策略提高数据的查找速度的二叉树的数据结构；</p>
<ul>
<li>每个节点最多拥有两个子节点</li>
<li>Left-child &lt; Node &lt; Right-child</li>
<li>树的左右两边的层数相差最多一层</li>
</ul>
</li>
<li><p>BTree: 平衡多路查找树，即查找路径不止两个</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-btree.png" alt="a"></p>
</li>
<li><p>B+Tree: </p>
<ul>
<li><strong>非叶子节点</strong>：不保存关键字记录的指针，只进行数据索引</li>
<li><strong>叶子节点</strong>：保存父节点的所有关键字记录的指针，所有数据地址必须要到叶子节点才能获取到。所以每次数据查询的次数都一样</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-bptree.png" alt="a"></p>
</li>
</ul>
<p><strong>查询方式：</strong></p>
<ul>
<li><p>主键索引区：PI, 关联数据的地址，按主键查询</p>
</li>
<li><p>普通索引区：SI, 关联id的地址，然后再到达上面的地址</p>
</li>
</ul>
<h3 id="3-2-2-哈希索引"><a href="#3-2-2-哈希索引" class="headerlink" title="3.2.2 哈希索引"></a>3.2.2 哈希索引</h3><p>通过hash算法实现，常见hash算法有直接定址法、平方取中法、折叠法、除数取余法、随机数法等</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-hash-index.png" alt="a"></p>
<p>特点：</p>
<ul>
<li>仅支持”=”,”IN”和”&lt;=&gt;”查询，不能使用范围</li>
<li>检索效率非常高，索引的检索可以一次定位，不像B-Tree 索引需要从根节点到枝节点，最后才能访问到页节点这样多次的IO访问，所以 Hash 索引的查询效率要远高于 B-Tree 索引</li>
<li>只有Memory存储引擎显示支持hash索引</li>
</ul>
<h3 id="3-2-3-全文索引"><a href="#3-2-3-全文索引" class="headerlink" title="3.2.3 全文索引"></a>3.2.3 全文索引</h3><p>全文索引：搜索引擎使用的一种关键技术，当前 MyISAM 和 InnoDB 均支持</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tbl_article(</span><br><span class="line">	`id` <span class="type">INT</span>(<span class="number">11</span>) auto_increment <span class="keyword">primary</span> key,</span><br><span class="line">    `title` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    `content` TEXT</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># 全文索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_article <span class="keyword">ADD</span> FULLTEXT(content);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_article <span class="keyword">WHERE</span> <span class="keyword">MATCH</span>(content) AGAINST(<span class="string">&#x27;New York&#x27;</span> <span class="keyword">IN</span> <span class="keyword">NATURAL</span> <span class="keyword">LANGUAGE</span> MODE);</span><br></pre></td></tr></table></figure>



<h2 id="3-3-使用原则"><a href="#3-3-使用原则" class="headerlink" title="3.3 使用原则"></a>3.3 使用原则</h2><ul>
<li><p>最左前缀匹配严重：联合索引尤为重要</p>
</li>
<li><p>较频繁的查询条件字段，应建立索引</p>
</li>
<li><p>更新频繁的字段，不适合做索引</p>
</li>
<li><p>数量大量重复的字段，不适合做索引</p>
</li>
<li><p>尽量扩展索引，不要新建索引</p>
</li>
<li><p>外键列，一定要建索引</p>
</li>
<li><p>text, blob 不能建立普通索引</p>
</li>
<li><p>NULL值字段不要创建索引，应改为NOT NULL，并设置DEFAULT</p>
</li>
<li><p>索引字段越小越好，key过长会导致间接索引层次增加，性能降低</p>
</li>
</ul>
<h1 id="4-事务"><a href="#4-事务" class="headerlink" title="4. 事务"></a>4. 事务</h1><p>事务：数据库执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。</p>
<h2 id="4-1-ACID"><a href="#4-1-ACID" class="headerlink" title="4.1 ACID"></a>4.1 ACID</h2><table>
<thead>
<tr>
<th>特性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>原子性 Atomicity</td>
<td>事务作为一个整体被执行，要么全部成功，要么全部失败</td>
</tr>
<tr>
<td>一致性 Consistent</td>
<td>数据库无中间状态，数据库中的数据应满足完整性约束</td>
</tr>
<tr>
<td>隔离性 Isolation</td>
<td>多个事务并发执行，相互不影响</td>
</tr>
<tr>
<td>持久性 Durability</td>
<td>提交成功的事务，对数据库的修改是永久的，不可逆</td>
</tr>
</tbody></table>
<h2 id="4-2-隔离级别"><a href="#4-2-隔离级别" class="headerlink" title="4.2 隔离级别"></a>4.2 隔离级别</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL &#123;READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE&#125;</span><br><span class="line"></span><br><span class="line">SELECT @@global.tx_isolation;</span><br><span class="line">SELECT @@session.tx_isolation;</span><br><span class="line">SELECT @@tx_isolation;</span><br><span class="line"></span><br><span class="line"># 设置为 read uncommitted</span><br><span class="line">set session transaction isolation level read uncommitted;</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>级别</th>
<th>含义</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交 (Read Uncommitted)</td>
<td><strong>一个事务可以读取到另一个事务还未提交的数据</strong></td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>读已提交 (Read Committed)</td>
<td><strong>事务中多次读取同一数据，都能读到其他事务提交的数据</strong></td>
<td>N</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>可重复读 (Repeatable Read)</td>
<td><strong>事务中多次读取同一数据，即使其他事务提交了该是数据，该数据在本事务中不会改变。</strong></td>
<td>N</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>可串行化 (Serializable)</td>
<td>事务串行执行，不允许并发</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
</tbody></table>
<ul>
<li><strong>脏读</strong>：一个事务内，读取到了其他事务还没提交的数据。</li>
<li><strong>不可重复读</strong>：一个事务内，多次读同一数据，如果另一个事务恰好修改了这个数据，那么在第一个事务中，两次读取的数据就可能不一致。</li>
<li><strong>幻读</strong>：一个事务内，第一次查询某条记录，发现没有，但当试图更新这条不存在的记录时，竟然成功，并且再次读取同一条记录，竟然存在。</li>
</ul>
<h1 id="5-锁"><a href="#5-锁" class="headerlink" title="5. 锁"></a>5. 锁</h1><h2 id="5-1-锁的分类"><a href="#5-1-锁的分类" class="headerlink" title="5.1 锁的分类"></a>5.1 锁的分类</h2><ul>
<li>操作颗粒度<ul>
<li>表级锁(偏读)：偏向MyISAM引擎，开销少，加锁快；无死锁；锁定粒度大，锁冲突概率高，并发度低</li>
<li>行级锁(偏写)：偏向InnoDB引擎，开销大，加锁慢；会产生死锁；锁定粒度小，锁冲突概率低，并发度高</li>
<li>页锁：DBD引擎，开销介于行锁和表锁之间，会出现死锁</li>
</ul>
</li>
<li>操作类型：<ul>
<li>读锁(共享锁): 多个读操作可同时进行而不相互影响</li>
<li>写锁(排他锁): 写操作未完成前，它会阻断其他写锁和读锁</li>
</ul>
</li>
</ul>
<h2 id="5-2-表级锁"><a href="#5-2-表级锁" class="headerlink" title="5.2 表级锁"></a>5.2 表级锁</h2><p>表读锁：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>session 1 (lock A read)</th>
<th>session X</th>
</tr>
</thead>
<tbody><tr>
<td>读A表</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr>
<td>写A表</td>
<td>NO</td>
<td>NO</td>
</tr>
<tr>
<td>读写B表</td>
<td>NO</td>
<td>YES</td>
</tr>
</tbody></table>
<p>表写锁：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>session 1 (lock A write)</th>
<th>session X</th>
</tr>
</thead>
<tbody><tr>
<td>读A表</td>
<td>YES</td>
<td>NO</td>
</tr>
<tr>
<td>写A表</td>
<td>YES</td>
<td>NO</td>
</tr>
<tr>
<td>读写B表</td>
<td>NO</td>
<td>YES</td>
</tr>
</tbody></table>
<p>总结：<strong>读锁阻塞写，但不会阻塞读；而写锁会把读和写都阻塞。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看是否已加锁 in_use=1</span><br><span class="line">show open tables; </span><br><span class="line">    </span><br><span class="line">lock table tbl_A read;</span><br><span class="line">lock table tbl_B write;</span><br><span class="line">    </span><br><span class="line">unlock tables;</span><br><span class="line"></span><br><span class="line"># 表锁分析</span><br><span class="line">show status like &#x27;table_locks%&#x27;</span><br><span class="line">table_locks_immediate --产生表级锁的次数，每加一次表锁，自动累加1</span><br><span class="line">table_locks_waited --表级锁定后，发生等待的次数</span><br></pre></td></tr></table></figure>



<h2 id="5-3-行级锁"><a href="#5-3-行级锁" class="headerlink" title="5.3 行级锁"></a>5.3 行级锁</h2><p>行锁算法：</p>
<ul>
<li>Record lock: 单行记录上的锁</li>
<li>Gap lock： 间隙锁，锁定一个范围，不包括记录本身</li>
<li>Next-key lock: record+gap 锁定一个范围，包含记录本身</li>
</ul>
<h3 id="5-3-1-行锁"><a href="#5-3-1-行锁" class="headerlink" title="5.3.1 行锁"></a>5.3.1 行锁</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">create table tbl_emp (</span><br><span class="line">    id int(11) auto_increment primary key, </span><br><span class="line">    name varchar(20) not null default &#x27;&#x27;,</span><br><span class="line">    age smallint(4) not null default 0</span><br><span class="line">);</span><br><span class="line">create index idx_name on tbl_emp(name);</span><br><span class="line">insert into tbl_emp values(1, &#x27;eli&#x27;, 34);</span><br><span class="line">insert into tbl_emp values(2, &#x27;rania&#x27;, 26);</span><br><span class="line"></span><br><span class="line">-- session 1</span><br><span class="line">set autocommit=0;</span><br><span class="line">update tbl_emp set age=32 where id=1;</span><br><span class="line"></span><br><span class="line">-- session 2</span><br><span class="line">set autocommit=0;</span><br><span class="line">update tbl_emp set age=33 where id=1; --locked</span><br><span class="line">update tbl_emp set age=24 where id=2; --ok</span><br><span class="line"></span><br><span class="line">---索引失效，行锁变表锁--------</span><br><span class="line">-- session 1</span><br><span class="line">set autocommit=0;</span><br><span class="line">update tbl_emp set age=18 where name=123; --索引失效，MySQL8.0直接错误</span><br><span class="line"></span><br><span class="line">-- session 2</span><br><span class="line">set autocommit=0;</span><br><span class="line">update tbl_emp set age=19 where name=&#x27;123&#x27;; --locked</span><br><span class="line">update tbl_emp set age=28 where name=&#x27;eli&#x27;; --locked</span><br></pre></td></tr></table></figure>



<h3 id="5-3-2-间隙锁："><a href="#5-3-2-间隙锁：" class="headerlink" title="5.3.2 间隙锁："></a>5.3.2 间隙锁：</h3><p>当用范围作为检索条件时，InnoDB会将整个范围锁定，即使该范围内有不存在的记录。这些不存在的记录即为间隙(gap)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_gap(</span><br><span class="line">	a <span class="type">int</span>(<span class="number">10</span>),</span><br><span class="line">    b <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_gap <span class="keyword">values</span>(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_gap <span class="keyword">values</span>(<span class="number">3</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_gap <span class="keyword">values</span>(<span class="number">4</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_gap <span class="keyword">values</span>(<span class="number">6</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_gap <span class="keyword">values</span>(<span class="number">7</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1</span></span><br><span class="line"><span class="keyword">set</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">update tbl_gap <span class="keyword">set</span> b<span class="operator">=</span><span class="string">&#x27;x&#x27;</span> <span class="keyword">where</span> a <span class="operator">&gt;=</span><span class="number">1</span> <span class="keyword">and</span> a <span class="operator">&lt;=</span> <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 2</span></span><br><span class="line"><span class="keyword">set</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_gap(a, b) <span class="keyword">values</span>(<span class="number">2</span>, <span class="string">&#x27;b&#x27;</span>); <span class="comment">--locked</span></span><br></pre></td></tr></table></figure>



<h3 id="5-3-3-锁定一行"><a href="#5-3-3-锁定一行" class="headerlink" title="5.3.3 锁定一行"></a>5.3.3 锁定一行</h3><p>如何锁定一行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl_a <span class="keyword">where</span> id<span class="operator">=</span><span class="number">5</span> <span class="keyword">for</span> update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<p><code>select ... for update ...where ...</code>的锁行为：</p>
<ul>
<li><p>使用了索引，为行锁</p>
</li>
<li><p>未使用索引，为表锁</p>
</li>
<li><p>未查到数据，无锁</p>
</li>
</ul>
<h3 id="5-3-4-行锁总结"><a href="#5-3-4-行锁总结" class="headerlink" title="5.3.4 行锁总结"></a>5.3.4 行锁总结</h3><ul>
<li>尽可能让所有数据检索通过索引来完成，避免无索引升级为表锁</li>
<li>尽可能减少检索条件，避免间隙锁</li>
</ul>
<h2 id="5-4-死锁"><a href="#5-4-死锁" class="headerlink" title="5.4 死锁"></a>5.4 死锁</h2><p>死锁: 两个或多个事务在同一资源上相互占用，并请求锁定对方的资源，从而导致恶性循环的现象。</p>
<p>解决死锁：</p>
<p>1）如果不同程序会并发存取多个表，尽量约定以相同的顺序访问表，可大大降低死锁机会。</p>
<p>2）同一事务中，尽可能做的一次锁定所需的所有资源，减少死锁产生的概率。</p>
<p>3）对非常容易产生死锁的业务，可尝试使用升级锁定颗粒度，通过表级锁来减少死锁发生的概率。</p>
<h2 id="5-5-MVVC"><a href="#5-5-MVVC" class="headerlink" title="5.5 MVVC"></a>5.5 MVVC</h2><ul>
<li><strong>悲观锁</strong>：想办法避免冲突。每次去拿数据时，都认为别人会修改，所以每次在拿数据时都上锁。</li>
<li><strong>乐观锁</strong>：允许冲突，但发生冲突时，有能力解决。乐观的认为冲突不会发生，除非检测到确实产生了冲突<ul>
<li>逻辑时钟 (Logical Clock)</li>
<li>MVCC：Multi-version Concurrent Control</li>
</ul>
</li>
</ul>
<blockquote>
<p>实现乐观锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> data <span class="keyword">AS</span> old_data, version <span class="keyword">AS</span> old_version <span class="keyword">FROM</span> ...;</span><br><span class="line">UPDATE ... <span class="keyword">SET</span> data <span class="operator">=</span> new_data, version <span class="operator">=</span> new_version <span class="keyword">WHERE</span> version <span class="operator">=</span> old_version;</span><br><span class="line"></span><br><span class="line">if (updated_row <span class="operator">&gt;</span> <span class="number">0</span>) &#123;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 乐观锁获取成功，操作完成</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 乐观锁获取失败，回滚并重试</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>MVCC 中的版本一般选择使用时间戳或者事务ID来标识。在处理一个写请求时，MVCC不是简单的有新值覆盖旧值，而是为这一项添加一个新版本数据。在读取一个数据项时，要先确定读取的版本，然后根据版本找到对应的数据。MVCC中的读操作永远不会被阻塞。</p>
<p>MVCC两种读形式：</p>
<ul>
<li><p>快照读：读取的只是当前事务的可见版本，不用加锁。<code>select * from tablename where id=xxx</code> 即为快照读</p>
</li>
<li><p>当前读：读取当前版本，比如特殊的读操作，更新/插入/删除操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tablename <span class="keyword">where</span> id<span class="operator">=</span>xxx lock <span class="keyword">in</span> share mode;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tablename <span class="keyword">where</span> id<span class="operator">=</span>xxx <span class="keyword">for</span> update;</span><br><span class="line"></span><br><span class="line">update tablename <span class="keyword">set</span> ...</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tablename(xxx,) <span class="keyword">values</span>(xxx,)</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tablename <span class="keyword">where</span> id<span class="operator">=</span>xxx;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="6-视图"><a href="#6-视图" class="headerlink" title="6. 视图"></a>6. 视图</h1><p>视图：本质上是一种虚拟表，在物理上不存在，其内容和真实的表相似。它的行和列来自定义视图的查询所引用基本表，在具体引用视图时动态生成。</p>
<h2 id="6-1-特点"><a href="#6-1-特点" class="headerlink" title="6.1 特点"></a>6.1 特点</h2><ul>
<li><p>视图是由一个或多个实表产生的虚表</p>
</li>
<li><p>视图的建立和删除不影响基本表</p>
</li>
<li><p>对视图内容的更新(增删改)直接影响基本表</p>
</li>
<li><p>当视图来自多个基本表时，不允许添加和删除数据</p>
</li>
</ul>
<h2 id="6-2-使用场景"><a href="#6-2-使用场景" class="headerlink" title="6.2 使用场景"></a>6.2 使用场景</h2><p>视图的用途：优化SQL查询，提高开发效率</p>
<ul>
<li>重用SQL语句</li>
<li>简化复杂的SQL操作。编写完查询后，可方便重用而不必关心查询细节</li>
<li>使用表的组成部分而不是整表</li>
<li>保护数据。可给用户授予表的部分数据访问权限而不是整个表</li>
<li>改变数据格式和表示。</li>
</ul>
<h2 id="6-3-优缺点"><a href="#6-3-优缺点" class="headerlink" title="6.3 优缺点"></a>6.3 优缺点</h2><ul>
<li><p>优点：</p>
<ul>
<li>查询简单化</li>
<li>数据安全性</li>
<li>逻辑数据独立性。视图对重构数据库提供了一定程度的逻辑独立性</li>
</ul>
</li>
<li><p>缺点：</p>
<ul>
<li>性能。如果视图由一个复杂的多表查询定义，那么即使视图的一个简单查询，也需要花费一定的时间</li>
<li>修改限制。较复杂的视图，可能是不可修改的</li>
</ul>
</li>
</ul>
<h1 id="7-存储过程"><a href="#7-存储过程" class="headerlink" title="7. 存储过程"></a>7. 存储过程</h1><p>存储过程：一个预编译的SQL语句，允许模块化设计，即只要创建一次，后续可多次调用。</p>
<p>优点：</p>
<ul>
<li>预编译的，执行效率高</li>
<li>存储过程代码直接放数据库，通过存储过程名称调用，减少网络通信</li>
<li>安全性高，执行存储过程需要一定的权限</li>
<li>可重复使用</li>
</ul>
<p>缺点：</p>
<ul>
<li>调试麻烦</li>
<li>移植困难</li>
<li>带引用关系的对象发生改变，受影响的存储过程、包将需要重新编译</li>
<li>维护困难。对于大型项目，多版本迭代的数据结构变化，存储过程维护会相当麻烦。</li>
</ul>
<p>存储过程实例：</p>
<ul>
<li><p>设置参数log_bin_trust_function_creators</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建函数，可能出错: This function has none of DETERMINISTIC...</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_bin_trust_function_creators&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_bin_trust_function_creators<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建函数，随机产生数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_string(n <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> chars <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;abcdefghijk...LMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> ret <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	WHILE i <span class="operator">&lt;</span> n DO</span><br><span class="line">		<span class="keyword">SET</span> ret <span class="operator">=</span> CONCAT(ret, <span class="built_in">SUBSTRING</span>(chars, <span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>RAND()<span class="operator">*</span><span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line">		<span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">END</span> WHILE;</span><br><span class="line">	<span class="keyword">RETURN</span> ret;</span><br><span class="line"><span class="keyword">END</span>$$</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_emp(<span class="keyword">IN</span> <span class="keyword">start</span> <span class="type">INT</span>(<span class="number">10</span>), <span class="keyword">IN</span> <span class="keyword">offset</span> <span class="type">INT</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">SET</span> autocommit<span class="operator">=</span><span class="number">0</span>; # </span><br><span class="line">	REPEAT</span><br><span class="line">		<span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp(name, ...) <span class="keyword">VALUES</span>(rand_string(<span class="number">4</span>), ...);</span><br><span class="line">		UNTIL i <span class="operator">=</span> <span class="keyword">offset</span> </span><br><span class="line">	<span class="keyword">END</span> REPEAT;</span><br><span class="line">	<span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER ;<span class="keyword">CALL</span> insert_emp(<span class="number">100</span>, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h1 id="8-主从复制"><a href="#8-主从复制" class="headerlink" title="8. 主从复制"></a>8. 主从复制</h1><p>主从复制：将主库中的DDL和DML操作通过二进制日志(BINLOG) 传输到从库上，然后在从库上重现这些操作，使主从数据库一致</p>
<p>主从复制的用途：</p>
<ul>
<li>主数据库宕机，切到从库继续工作</li>
<li>实现读写分离</li>
<li>数据库日常备份</li>
</ul>
<p>主从复制流程：</p>
<p>主：binlog线程，记录下所有改变数据的日志到binlog中</p>
<p>从：io线程，从master上拉取binlog日志，并放入relay log中</p>
<p>从：sql执行线程，执行relay log中的语句</p>
<h2 id="8-1-读写分离方案"><a href="#8-1-读写分离方案" class="headerlink" title="8.1 读写分离方案"></a>8.1 读写分离方案</h2><ul>
<li><p><code>mysql-proxy</code></p>
<ul>
<li><p>优点：直接实现了读写分离和负载均衡，不用修改代码</p>
</li>
<li><p>缺点：性能低，不支持事务。不推荐使用</p>
</li>
</ul>
</li>
<li><p>ORM实现</p>
</li>
</ul>
<h2 id="8-2-主从配置"><a href="#8-2-主从配置" class="headerlink" title="8.2 主从配置"></a>8.2 主从配置</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">log-bin</span>=/data/mysql/mysql-bin</span><br><span class="line"><span class="attr">log-err</span>=/data/mysql/mysql-err</span><br><span class="line"></span><br><span class="line"><span class="comment"># slave</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>授权：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># master</span><br><span class="line"><span class="keyword">grant</span> replication save <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;root@192.168.80.3&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"><span class="keyword">show</span> master status\G</span><br><span class="line"></span><br><span class="line"># slave</span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;192.168.80.1&#x27;</span>, master_user<span class="operator">=</span><span class="string">&#x27;root&#x27;</span>, master_password<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>, master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000002&#x27;</span>, master_log_pos<span class="operator">=</span><span class="number">1206</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">start</span> slave;</span><br><span class="line"><span class="keyword">show</span> slave status\G</span><br><span class="line">...</span><br><span class="line">Salve_IO_Running: Yes   # 成功</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h1 id="9-SQL"><a href="#9-SQL" class="headerlink" title="9. SQL"></a>9. SQL</h1><h2 id="9-1-语句分类"><a href="#9-1-语句分类" class="headerlink" title="9.1 语句分类"></a>9.1 语句分类</h2><ul>
<li>DDL: CREATE, DROP, ALTER，TRUNCATE</li>
<li>DQL: SELECT</li>
<li>DML: INSERT, UPDATE, DELETE</li>
<li>DCL: GRANT, REVOKE, COMMIT, ROLLBACK</li>
</ul>
<h2 id="9-2-关联查询"><a href="#9-2-关联查询" class="headerlink" title="9.2 关联查询"></a>9.2 关联查询</h2><ul>
<li><p>INNER JOIN</p>
</li>
<li><p>LEFT JOIN：以左表为主，先查出左表，然后按照ON的关联条件匹配右表，没有匹配到用NULL填充。</p>
</li>
<li><p>RIGHT JOIN：以右表为主，先查出右表，然后按照ON的关联条件匹配左表，没有匹配到用NULL填充。</p>
</li>
<li><p>FULL OUTER JOIN ：MySQL不支持，但可实现</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> B A.id<span class="operator">=</span>B.aid </span><br><span class="line"><span class="keyword">UNION</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> A <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> B A.id<span class="operator">=</span>B.aid;</span><br></pre></td></tr></table></figure>
</li>
<li><p>UNION：合并多个集合(联合查询的列必须一致)，<strong>相同的记录会合并</strong></p>
</li>
<li><p>UNION ALL：不会合并重复行，效率比UNION低</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-join.png" alt="a"></p>
<h2 id="9-3-子查询"><a href="#9-3-子查询" class="headerlink" title="9.3 子查询"></a>9.3 子查询</h2><ul>
<li>条件：一条SQL语句的查询结果作为另一条查询语句的条件或查询结果</li>
<li>嵌套：多条SQL语句嵌套使用，内部的SQL查询语句称为子查询</li>
</ul>
<p>子查询的三种情况：</p>
<p>1）子查询是一个单行单例，使用“=”</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> age<span class="operator">=</span>(<span class="keyword">select</span> <span class="built_in">max</span>(age) <span class="keyword">from</span> users);</span><br></pre></td></tr></table></figure>

<p>2）子查询是一个多行单例，使用“in”</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> age <span class="keyword">in</span> (<span class="keyword">select</span> age <span class="keyword">from</span> users <span class="keyword">where</span> gender<span class="operator">=</span><span class="string">&#x27;female&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>3）子查询是多行多列，结果集类似一张虚表，但不能使用where</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept d, (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">20</span>) u <span class="keyword">where</span> u.dept_id<span class="operator">=</span>d.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> d.<span class="operator">*</span>, u.<span class="operator">*</span> <span class="keyword">from</span> dept d <span class="keyword">inner</span> <span class="keyword">join</span> users u <span class="keyword">on</span> d.id<span class="operator">=</span><span class="operator">=</span>u.dept_id <span class="keyword">where</span> u.age<span class="operator">&gt;</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>



<h2 id="9-4-in-amp-exists"><a href="#9-4-in-amp-exists" class="headerlink" title="9.4 in &amp; exists"></a>9.4 in &amp; exists</h2><p>in: 把外表和内表做hash连接</p>
<p>exists： 对外表做loop循环，每次loop循环再对内表进行查询</p>
<p>执行效率对比：</p>
<ul>
<li>如果查询的两个表大小相当，in和exists差别不大</li>
<li>如果两个表中一个较小，一个较大，则子查询表大的用exists，子查询表小的on-going-in</li>
<li>not exists 使用索引，但not in无法使用索引，所以not exists更高效</li>
</ul>
<h2 id="9-5-分页"><a href="#9-5-分页" class="headerlink" title="9.5 分页"></a>9.5 分页</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name LIMIT <span class="number">5</span>;     <span class="operator">/</span><span class="operator">/</span> <span class="number">1</span><span class="operator">~</span><span class="number">5</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name LIMIT <span class="number">5</span>,<span class="number">10</span>;  <span class="operator">/</span><span class="operator">/</span> <span class="number">6</span><span class="operator">~</span><span class="number">15</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name LIMIT <span class="number">5</span>,<span class="number">-1</span>;  <span class="operator">/</span><span class="operator">/</span> <span class="number">6</span><span class="operator">~</span><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="9-6-查找字段相同的数据"><a href="#9-6-查找字段相同的数据" class="headerlink" title="9.6 查找字段相同的数据"></a>9.6 查找字段相同的数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.id <span class="keyword">from</span> group_member a,</span><br><span class="line">(<span class="keyword">select</span> group_id, user_id, status <span class="keyword">from</span> group_member <span class="keyword">group</span> <span class="keyword">by</span> group_id, user_id, status <span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">1</span>) b</span><br><span class="line"><span class="keyword">where</span> a.group_id<span class="operator">=</span>b.group_id <span class="keyword">and</span> a.user_id<span class="operator">=</span>b.user_id <span class="keyword">and</span> a.status<span class="operator">=</span>b.status;</span><br></pre></td></tr></table></figure>



<h2 id="9-7-循环更新数据"><a href="#9-7-循环更新数据" class="headerlink" title="9.7 循环更新数据"></a>9.7 循环更新数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE contact a <span class="keyword">INNER</span> <span class="keyword">JOIN</span> users b <span class="keyword">ON</span> a.inviter<span class="operator">=</span>b.phone <span class="keyword">SET</span> a.inviter_id<span class="operator">=</span>b.id;</span><br><span class="line">UPDATE contact a <span class="keyword">INNER</span> <span class="keyword">JOIN</span> users b <span class="keyword">ON</span> a.invitee<span class="operator">=</span>b.phone <span class="keyword">SET</span> a.invitee_id<span class="operator">=</span>b.id;</span><br></pre></td></tr></table></figure>



<h2 id="9-8-强制删除外键引用的表"><a href="#9-8-强制删除外键引用的表" class="headerlink" title="9.8 强制删除外键引用的表"></a>9.8 强制删除外键引用的表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> users;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<h1 id="10-日志"><a href="#10-日志" class="headerlink" title="10. 日志"></a>10. 日志</h1><h2 id="10-1-undoLog"><a href="#10-1-undoLog" class="headerlink" title="10.1 undoLog"></a>10.1 undoLog</h2><p><strong>事务回滚日志</strong></p>
<ul>
<li><p>insert undo log: 插入数据时产生，事务提交后丢弃</p>
</li>
<li><p>update undo log: 更新或删除数据时产生，快照读的时候需要所以不能直接删除，只有当系统没有比这个log更早的read-view的时候才能被删除</p>
</li>
</ul>
<h2 id="10-2-redoLog"><a href="#10-2-redoLog" class="headerlink" title="10.2 redoLog"></a>10.2 redoLog</h2><p><strong>重做日志文件，记录数据修改之后的值，用于持久化到磁盘中</strong></p>
<ul>
<li><p>redo log buffer: 内存中的日志缓冲，易丢失</p>
</li>
<li><p>redo log file: 磁盘上的日志文件，持久化的。记录物理数据页修改的信息。当数据更新时，InnoDB会先将数据更新，然后记录redoLog在内存中，然后找个时间将redoLog持久化到磁盘。不管提交是否成功都要记录</p>
</li>
</ul>
<h2 id="10-3-binLog"><a href="#10-3-binLog" class="headerlink" title="10.3 binLog"></a>10.3 binLog</h2><p><strong>逻辑日志，记录sql的原始逻辑</strong></p>
<p>数据修改时，binlog会追加写入指定大小的物理文件中，如果文件写满则创建一个新的文件写入；用于复制和恢复在主从复制中，从库利用主库的binlog进行重播。</p>
<p>binlog 的三种格式：statement, row 和 mixed</p>
<ul>
<li><p>statement：每一条修改数据的sql都会记录在binlog中。不需要记录每一行的变化，减少了 binlog 日志量，节约了 IO，提高性能。由于sql的执行是有上下文的，因此在保存的时候，需要保存相关的信息，同时还有一些使用了函数之类的语句无法被记录复制。</p>
</li>
<li><p>row：不记录sql语句上下文信息，仅保存那条记录被修改。记录单元为每一行的改动，基本可以全部记录下来。但由于操作过多，导致大量行改动 (如：alter table)。此种模式的文件保存信息过多，日志量太大。（新版优化：当表结构发生变化时，记录操作语言，而不是行记录）</p>
</li>
<li><p>mixed：折中方案。普通操作使用statement记录，当无法使用statement时使用row。</p>
</li>
</ul>
<h1 id="11-查询分析"><a href="#11-查询分析" class="headerlink" title="11. 查询分析"></a>11. 查询分析</h1><h2 id="11-1-问题分析"><a href="#11-1-问题分析" class="headerlink" title="11.1 问题分析"></a>11.1 问题分析</h2><ul>
<li>开启慢查询日志，设置阈值，比如超过5s即为慢SQL，将其记录下来</li>
<li>explain 分析慢SQL，可解决大部分问题</li>
<li>show profile，查询SQL的执行细节和生命周期</li>
<li>数据库参数调优</li>
</ul>
<h2 id="11-2-慢查询日志"><a href="#11-2-慢查询日志" class="headerlink" title="11.2 慢查询日志"></a>11.2 慢查询日志</h2><p>slow_query_log: 慢查询日志参数</p>
<p>long_query_time：慢查询SQL记录阈值，默认10s</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;slow_query_log%&#x27;;</span><br><span class="line">+---------------------+------------------------------------+</span><br><span class="line">| Variable_name       | Value                              |</span><br><span class="line">+---------------------+------------------------------------+</span><br><span class="line">| slow_query_log      | OFF                                |</span><br><span class="line">| slow_query_log_file | /var/lib/mysql/ubuntu20-a-slow.log |</span><br><span class="line">+---------------------+------------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &#x27;long_query_time%&#x27;;</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| Variable_name   | Value     |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| long_query_time | 10.000000 |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line"></span><br><span class="line">mysql&gt; set global slow_query_log=1;</span><br><span class="line"></span><br><span class="line">mysql&gt; set global long_query_time=5;</span><br></pre></td></tr></table></figure>

<p>慢SQL分析工具：mysqldumpslow</p>
<h2 id="11-3-explain"><a href="#11-3-explain" class="headerlink" title="11.3 explain"></a>11.3 explain</h2><h3 id="11-3-1-explain-详解"><a href="#11-3-1-explain-详解" class="headerlink" title="11.3.1 explain 详解"></a>11.3.1 explain 详解</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from tbl_emp where id=1;</span><br><span class="line">+----+-------------+---------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span><br><span class="line">| id | select_type | table   | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+----+-------------+---------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span><br><span class="line">|  1 | SIMPLE      | tbl_emp | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |</span><br><span class="line">+----+-------------+---------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span><br></pre></td></tr></table></figure>

<p>注意字段含义：</p>
<ul>
<li><p>id: 优先级</p>
<ul>
<li>相同时，自上而下顺序执行</li>
<li>不同时，id值越大，越早执行</li>
</ul>
</li>
<li><p>select_type: 查询类型</p>
<ul>
<li>simple</li>
<li>primary: 最外层查询，也是最后的查询</li>
<li>subquery</li>
<li>derived：衍生虚表</li>
<li>union</li>
<li>union result: 联合结果合并</li>
</ul>
</li>
<li><p>table：表名称，也可以为<code>&lt;derived N&gt;</code>或<code>&lt;UNION N&gt;</code></p>
</li>
<li><p>type: 访问类型，从好到差的顺序如下，至少需要优化到range</p>
<ul>
<li>system: 表中只有一条数据，相当于系统表</li>
<li>const: 一次索引就能找到，即主键、唯一索引</li>
<li>eq_ref: 唯一性索引扫描，只有一条数据与之匹配，常见于主键、唯一索引</li>
<li>ref: 非唯一性索引扫描，可能匹配到多条数据</li>
<li>range: 检索特定范围的行。使用一个索引来选择行，即 <code>between, &gt;, &lt;, in</code></li>
<li>index: 全索引扫描 <code>select id from tbl_user</code>, 直接从索引中获取数据</li>
<li>ALL: 全表扫描 <code>select * from tbl_user</code></li>
</ul>
</li>
<li><p>possible_keys: 可能使用到的索引，但不一定实际使用</p>
</li>
<li><p>key：</p>
<ul>
<li>primary: 主键索引</li>
<li>idx_X: 普通索引名</li>
<li>NULL：未使用索引</li>
</ul>
</li>
<li><p>key_len: 索引字段最大可能长度，越小越好</p>
</li>
<li><p>ref: 索引条件使用到的值。<code>where uid=tbl_user.id and name=&#39;R&amp;D&#39;</code></p>
<ul>
<li>const: 常量条件</li>
<li>tbl_user.ID</li>
<li>NULL</li>
</ul>
</li>
<li><p>rows: 估算所查记录需要读取的行数，越小越好</p>
</li>
<li><p>Extra:</p>
<ul>
<li>Using filesort: 索引外排序，即无法使用索引进行排序，被称为文件排序。order by 未用到索引时出现。要想办法优化</li>
<li>Using temporary: 使用临时表保存中间结果，常见于order by 或group by。较严重问题，可将by后的字段建立联合索引来解决该问题</li>
<li>Using index: 使用索引。索引覆盖：查询的列，可直接从索引中得到，不必读取数据行，即查询的列被所建索引覆盖</li>
<li>Using where</li>
<li>Using join buffer</li>
<li>impossible where: where 条件 false, <code>where name=&#39;jack&#39; and name=&#39;tom&#39;</code></li>
<li>select tables optimized away</li>
<li>distinct</li>
</ul>
</li>
</ul>
<h3 id="11-3-2-索引优化"><a href="#11-3-2-索引优化" class="headerlink" title="11.3.2 索引优化"></a>11.3.2 索引优化</h3><ul>
<li>尽量减少join中的NestedLoop的循环总是：永远用小结果集驱动大结果集。</li>
<li>优先优化NestedLoop的内层循环</li>
<li>保证join中被驱动表上join条件字段被建立索引</li>
</ul>
<p>优化原则：<strong>小表驱动大表，即小表数据作为过滤条件</strong></p>
<p>A为大表，B为小表，此时 in 的效率大于 exists:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> b_id <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> B)</span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> id <span class="keyword">from</span> B</span><br><span class="line">	<span class="keyword">for</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> A.b_id <span class="operator">=</span> B.id</span><br></pre></td></tr></table></figure>



<p>A为小表，B为大表，此时 exists 的效率大于 in:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B <span class="keyword">where</span> B.id <span class="operator">=</span> A.b_id)</span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A</span><br><span class="line">	<span class="keyword">for</span> <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B <span class="keyword">where</span> B.id <span class="operator">=</span> A.b_id</span><br></pre></td></tr></table></figure>

<p>注意：exists (sub-query) 只返回 True 或 False</p>
<h3 id="11-3-3-索引失效"><a href="#11-3-3-索引失效" class="headerlink" title="11.3.3 索引失效"></a>11.3.3 索引失效</h3><ul>
<li><p>全值匹配最优</p>
</li>
<li><p>最佳左前缀法则</p>
</li>
<li><p>不在索引列上做任何操作（计算、函数、类型转换等），会导致全表扫描</p>
</li>
<li><p>不能使用索引中范围条件右边的列 <code>where name=&#39;jack&#39; and age&gt;20 and score=90</code>   三字段索引</p>
</li>
<li><p>尽量使用覆盖索引（即直接从索引中查询数据，无需扫描表）即少使用<code>select *</code></p>
</li>
<li><p>使用不等于(!= 或 &lt;&gt;)时，无法使用索引，导致全表扫描</p>
</li>
<li><p>is null, is not null 无法使用索引</p>
</li>
<li><p><code>like %xxx...</code> 无法使用索引，导致全表扫描。</p>
<ul>
<li>解决方案：使用覆盖索引（即select 索引列），然后从索引中直接获取</li>
</ul>
</li>
<li><p>字符串不加单引号索引失效</p>
</li>
<li><p>少用<code>or</code>，它会导致索引失效 </p>
</li>
</ul>
<h3 id="11-3-4-索引总结"><a href="#11-3-4-索引总结" class="headerlink" title="11.3.4 索引总结"></a>11.3.4 索引总结</h3><ol>
<li>带头大哥不能死</li>
<li>中间兄弟不能断，永远要符合左前缀最佳匹配原则</li>
<li>索引列上不计算</li>
<li>like %加右边</li>
<li>范围之后全失效</li>
<li>字符串有引号</li>
</ol>
<h2 id="11-4-Show-profile"><a href="#11-4-Show-profile" class="headerlink" title="11.4 Show profile"></a>11.4 Show profile</h2><p>用来分析当前会话中语句执行的资源消耗情况，可用于SQL的调优测量。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;profiling&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> profiling<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--执行一堆查询</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> profiles;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> profile cpu, block io <span class="keyword">for</span> query <span class="number">10</span>;</span><br><span class="line"><span class="comment">-- all, block io, cpu, memory, ...</span></span><br></pre></td></tr></table></figure>

<p>严重问题：</p>
<ul>
<li>converting HEAP to MyISAM: 查询结果太大，内存不足，使用磁盘</li>
<li>creating tmp table: 拷贝数据到临时表，用完删除</li>
<li>copying to tmp table on disk: 临时表存储在磁盘上，更要命</li>
<li>locked：</li>
</ul>
<h2 id="11-5-全局查询日志"><a href="#11-5-全局查询日志" class="headerlink" title="11.5 全局查询日志"></a>11.5 全局查询日志</h2><p>注意：绝对不能在生产环境开启此功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;general_log%&#x27;;</span><br><span class="line">+------------------+-------------------------------+</span><br><span class="line">| Variable_name    | Value                         |</span><br><span class="line">+------------------+-------------------------------+</span><br><span class="line">| general_log      | OFF                           |</span><br><span class="line">| general_log_file | /var/lib/mysql/ubuntu20-a.log |</span><br><span class="line">+------------------+-------------------------------+</span><br><span class="line"></span><br><span class="line">show variables like &#x27;general_log&#x27;</span><br><span class="line">set global general_log=1;</span><br><span class="line">set global log_output=&#x27;TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">select * from mysql.general_log;</span><br></pre></td></tr></table></figure>



<h2 id="11-6-Order-by"><a href="#11-6-Order-by" class="headerlink" title="11.6 Order by"></a>11.6 Order by</h2><p>尽量使用 index 方式排序，避免使用 FileSort 方式排序</p>
<p>Order by使用Index的条件：</p>
<ul>
<li>order by 后使用索引最左前列</li>
<li>Where 条件与 order by子句条件组合满足索引最左前列</li>
</ul>
<p>提高 order by 效率：</p>
<ul>
<li><p>不要用 <code>select *</code>, 只查询order by 后的字段：</p>
<ul>
<li>query的字段长度总和小于max_length_for_sort_data时，排序字段不为TEXT|BLOB时，使用单路排序，否则使用多路排序（即两次磁盘扫描）</li>
<li>两种算法的数据可能超出sort_buffer容量，超出之后，会创建tmp文件进行合并排序，导致多次IO</li>
</ul>
</li>
<li><p>sort_buffer_size：尝试提高该参数值，避免产生tmp文件</p>
</li>
<li><p>max_length_for_sort_data: 尝试提高该参数值会增加改进算法的效率。但如果太高，会导致磁盘IO过高，CPU使用率低的情况</p>
</li>
</ul>
<p>排序的两种方式：filesort, index</p>
<p><code>KEY a_b_c (a, b, c)</code></p>
<p>order by 使用索引左前缀：</p>
<ul>
<li>ORDER BY a</li>
<li>ORDER BY a, b</li>
<li>ORDER BY a, b, c</li>
<li>ORDER BY a DESC, b DESC, c DESC</li>
</ul>
<p>WHERE中的索引与order by中的索引构成最左前缀：</p>
<ul>
<li><p>WHERE a=const ORDER BY b, c</p>
</li>
<li><p>WHERE a=const AND b=const ORDER BY c</p>
</li>
<li><p>WHERE a=const AND b&gt;const ORDER BY b, c</p>
</li>
</ul>
<p>不能使用索引进行排序</p>
<ul>
<li>ORDER BY a ASC, B DESC, c DESC    // 排序不一致</li>
<li>WHERE x=const ORDER BY b, c  // 丢失a索引</li>
<li>WHERE a=const ORDER BY c      // 丢失b索引</li>
<li>WHERE a=const ORDER BY a, d  // d不是索引的一部分</li>
<li>WHERE a in (…) ORDER BY b, c  // 范围不能使用索引</li>
</ul>
<h2 id="11-7-Group-by"><a href="#11-7-Group-by" class="headerlink" title="11.7 Group by"></a>11.7 Group by</h2><ul>
<li>Group by 本质上先排序后分组，遵照索引最佳左前缀原则</li>
<li>当无法使用索引时，增大max_length_for_sort_data和sort_buffer_size参数</li>
<li>where 高于 having，能写在where的限定条件不要去having限定</li>
</ul>
<h1 id="12-SQL-性能优化"><a href="#12-SQL-性能优化" class="headerlink" title="12. SQL 性能优化"></a>12. SQL 性能优化</h1><ol>
<li><p>为避免全表扫描，涉及 WHERE 和 ORDER BY 的字段建立索引</p>
</li>
<li><p>避免 WHERE 中使用 NULL 判断，建表时尽量使用NOT NULL</p>
</li>
<li><p>避免 WHERE 中使用 != 或 &lt;&gt;，这些操作可使用索引：&lt;, &lt;=, =, &gt;, &gt;=, BETWEEN, IN，LIKE (某些时候)</p>
</li>
<li><p>避免 WHERE 中使用 OR，它会导致引擎放弃使用索引而进行全表扫描，可以使用 UNION 代替</p>
</li>
<li><p>慎用 IN 和 NOT IN，连续的数值，推荐BETWEEN </p>
</li>
<li><p>WHERE 中字段 不要使用函数、表达式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> record <span class="keyword">WHERE</span> amount<span class="operator">/</span><span class="number">30</span> <span class="operator">&lt;</span> <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> record <span class="keyword">WHERE</span> <span class="keyword">convert</span>(<span class="type">char</span>(<span class="number">10</span>), <span class="type">date</span>, <span class="number">112</span>) <span class="operator">=</span> <span class="string">&#x27;20201220&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用EXISTS 代替 IN</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> num <span class="keyword">from</span> a <span class="keyword">where</span> num <span class="keyword">in</span> (<span class="keyword">select</span> num <span class="keyword">from</span> b)</span><br><span class="line"><span class="keyword">select</span> num <span class="keyword">from</span> a <span class="keyword">where</span> num <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> b)</span><br></pre></td></tr></table></figure>
</li>
<li><p>索引会提高SELECT的效率，但也降低了INSERT和UPDATE的效率(索引重建), 一个表的索引，最好不要超过6个</p>
</li>
<li><p>JOIN的表不要超过5个，考虑使用临时表。</p>
</li>
<li><p>少用子查询，视图嵌套不要超过2层</p>
</li>
<li><p>数量统计，用<code>count(1)</code>代替 <code>count(*)</code></p>
</li>
<li><p>记录是否存在，用 EXISTS 代替 <code>count(1)</code></p>
</li>
<li><p><code>&gt;=</code> 效率比 <code>&gt;</code> 高</p>
</li>
<li><p>GROUP BY 前，先进行数据过滤：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> job, <span class="built_in">avg</span>(sal) <span class="keyword">from</span> emp <span class="keyword">GROUP</span> <span class="keyword">BY</span> job <span class="keyword">HAVING</span> job<span class="operator">=</span><span class="string">&#x27;engineer&#x27;</span> <span class="keyword">or</span> job<span class="operator">=</span><span class="string">&#x27;saler&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> job, <span class="built_in">avg</span>(sal) <span class="keyword">from</span> emp <span class="keyword">where</span> job<span class="operator">=</span><span class="string">&#x27;engineer&#x27;</span> <span class="keyword">or</span> job<span class="operator">=</span><span class="string">&#x27;saler&#x27;</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> job;</span><br></pre></td></tr></table></figure>
</li>
<li><p>尽量不使用触发器，trigger事件比较耗时</p>
</li>
<li><p>避免使用DISTINCT</p>
</li>
</ol>
<h1 id="99-问题集"><a href="#99-问题集" class="headerlink" title="99. 问题集"></a>99. 问题集</h1><h2 id="99-1-删除百万级别数据"><a href="#99-1-删除百万级别数据" class="headerlink" title="99.1 删除百万级别数据"></a>99.1 删除百万级别数据</h2><p>不要直接去操作，直接操作会存在索引更新问题；另外删除过程中断，会导致回滚</p>
<p>1）先删除索引 </p>
<p>2）删除无用数据</p>
<p>3）重建索引</p>
<h2 id="99-2-线上环境大表，添加索引"><a href="#99-2-线上环境大表，添加索引" class="headerlink" title="99.2 线上环境大表，添加索引"></a>99.2 线上环境大表，添加索引</h2><p>数据量超过100W，直接增加索引，可能导致服务器奔溃</p>
<p>两种方法：</p>
<p>1）临时表</p>
<p>注意：此方法可能会损失少量数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--复制旧表结构</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> new_table <span class="keyword">like</span> old_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">--加字段、索引</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> new_table <span class="keyword">add</span> index (<span class="keyword">column</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--拷贝旧表数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> new_table(field1, field2, ...) <span class="keyword">select</span> field1, field2, ... <span class="keyword">from</span> old_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">--修改表名</span></span><br><span class="line">rename <span class="keyword">table</span> old_table <span class="keyword">to</span> old_table_bak;</span><br><span class="line">rename <span class="keyword">table</span> new_table <span class="keyword">to</span> old_table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> admin_user RENAME <span class="keyword">TO</span> a_user;</span><br></pre></td></tr></table></figure>

<p>2）主从切换</p>
<p>从库中进行加字段、索引</p>
<p>主库切换到从库</p>
<h2 id="99-3-大表数据查询优化"><a href="#99-3-大表数据查询优化" class="headerlink" title="99.3 大表数据查询优化"></a>99.3 大表数据查询优化</h2><p>1）优化schema、sql、索引</p>
<p>2）增加缓存 redis 等</p>
<p>3）主从复制，读写分离</p>
<p>4）垂直拆分（一表分多表）。根据模块耦合度，将一个大的系统拆分成多个小系统，即分布式系统</p>
<p>5）水平切分（存储数据分片）。大表，考虑选择合适的分片(sharding key).</p>
<p>分片问题：</p>
<ul>
<li>事务：需要支持分布式事务</li>
<li>跨库join、count, order by, group by及聚合函数等：分别在各个节点上得到结果，然后在应用程序端进行合并。</li>
<li>数据迁移、容量规划、扩容</li>
<li>ID问题：Twitter的分布式自增ID算法Snowflake</li>
<li>跨分区排序：多节点查询，结果集汇总并再排序</li>
</ul>
<h2 id="99-4-慢查询优化"><a href="#99-4-慢查询优化" class="headerlink" title="99.4 慢查询优化"></a>99.4 慢查询优化</h2><ul>
<li>分析查询语句，检查是否load了额外的数据，对查询语句重写，去除多余的查询</li>
<li>分析语句的执行计划，获取其使用索引的情况，优化索引，使其尽可能命中</li>
<li>已无法优化的大表，考虑横向或纵向分表</li>
</ul>
<h2 id="99-5-使用主键"><a href="#99-5-使用主键" class="headerlink" title="99.5 使用主键"></a>99.5 使用主键</h2><p>主键的好处：确保数据在整张表中的唯一性。在CURD的时候能确保操作数据范围安全</p>
<p>推荐使用自增ID，而不是UUID。因为InnoDB中的主键索引是聚簇索引，即主键索引的B+上叶子节点上存储了主键索引及全部数据(按顺序)。使用自增ID，只需要不断想后排列即可；但如果是UUID，先确定顺序，导致数据移动等操作，使插入性能下降。</p>
<h2 id="99-6-字段定义要求not-null的好处"><a href="#99-6-字段定义要求not-null的好处" class="headerlink" title="99.6 字段定义要求not null的好处"></a>99.6 字段定义要求not null的好处</h2><p>null值会占用更多的字节，也会在程序中造成很多与预期不符的情况</p>
<h2 id="99-7-存储密码散列"><a href="#99-7-存储密码散列" class="headerlink" title="99.7 存储密码散列"></a>99.7 存储密码散列</h2><p>密码散列、盐值、也会手机号等固定长度的字符串应该使用char而不是varchar，这样可以节约空间且提高检索效率。</p>
<h2 id="99-8-数据库CPU飙升到500-怎么处理"><a href="#99-8-数据库CPU飙升到500-怎么处理" class="headerlink" title="99.8 数据库CPU飙升到500%怎么处理"></a>99.8 数据库CPU飙升到500%怎么处理</h2><p>1）使用top观察是不是mysqld占用导致的，如果不是，找到占用高的进程，并进行处理</p>
<p>2）对于mysqld造成的问题，可以使用<code>show processlist</code> 查看 session 情况，是否有消耗 sql 的资源在运行。查看执行计划是否准确，index是否缺失等</p>
<h2 id="99-9-重复值高的字段不能建索引"><a href="#99-9-重复值高的字段不能建索引" class="headerlink" title="99.9 重复值高的字段不能建索引"></a>99.9 重复值高的字段不能建索引</h2><p>未命中索引的原因：</p>
<ul>
<li><p>查询的数据量可能已经是总数据量的20%以上了，这个时候就会选择表扫描。</p>
</li>
<li><p>索引坏块，需要重建索引。</p>
</li>
</ul>
<p>原因：</p>
<p>1）非聚簇索引存储了对主键的引用，如果select字段不在非聚簇索引内，就需要跳到主键索引（图中从右边索引树跳到左边的索引树），再获取select字段值</p>
<p>2）如果非聚簇索引值重复率高，那么将查询时就会出现图中从右边跳到左边的情况，导致整个流程很慢</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/mysql/mysql-clustered-index.png" alt="a"></p>

      </div>
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-10-09T19:08:08+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>更新于 2021年10月9日</p>
  </a>
</div>

        
      
        
          

        
      
        
          

        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                          <h4>
                              <a href="/2020/07/16/Go%20Context/" rel="prev" title="Go Context">
                                
                                    Go Context
                                
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2020/01/12/Go%20%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/" rel="prev" title="Go 缓存淘汰策略">
                                  
                                      Go 缓存淘汰策略
                                  
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/algorithm/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> algorithm</a>
                              </h6>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'MySQL',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
      
        
          
          
            
              <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:eli.he@outlook.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/elihe2011"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=282243842"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-text">1. 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">1.1 架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-SQL-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2 SQL 执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">1.3 数据类型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%BC%95%E6%93%8E"><span class="toc-text">2. 引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95"><span class="toc-text">2.1 聚簇索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-InnoDB"><span class="toc-text">2.2 InnoDB</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%B4%A2%E5%BC%95"><span class="toc-text">3. 索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%B4%A2%E5%BC%95"><span class="toc-text">3.1 什么是索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">3.2 数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-BTree-amp-B-Tree"><span class="toc-text">3.2.1 BTree &amp; B+Tree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E5%93%88%E5%B8%8C%E7%B4%A2%E5%BC%95"><span class="toc-text">3.2.2 哈希索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95"><span class="toc-text">3.2.3 全文索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99"><span class="toc-text">3.3 使用原则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%BA%8B%E5%8A%A1"><span class="toc-text">4. 事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ACID"><span class="toc-text">4.1 ACID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-text">4.2 隔离级别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E9%94%81"><span class="toc-text">5. 锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text">5.1 锁的分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E8%A1%A8%E7%BA%A7%E9%94%81"><span class="toc-text">5.2 表级锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="toc-text">5.3 行级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E8%A1%8C%E9%94%81"><span class="toc-text">5.3.1 行锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E9%97%B4%E9%9A%99%E9%94%81%EF%BC%9A"><span class="toc-text">5.3.2 间隙锁：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-3-%E9%94%81%E5%AE%9A%E4%B8%80%E8%A1%8C"><span class="toc-text">5.3.3 锁定一行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-4-%E8%A1%8C%E9%94%81%E6%80%BB%E7%BB%93"><span class="toc-text">5.3.4 行锁总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E6%AD%BB%E9%94%81"><span class="toc-text">5.4 死锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-MVVC"><span class="toc-text">5.5 MVVC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E8%A7%86%E5%9B%BE"><span class="toc-text">6. 视图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E7%89%B9%E7%82%B9"><span class="toc-text">6.1 特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">6.2 使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">6.3 优缺点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-text">7. 存储过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">8. 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%96%B9%E6%A1%88"><span class="toc-text">8.1 读写分离方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE"><span class="toc-text">8.2 主从配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-SQL"><span class="toc-text">9. SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E8%AF%AD%E5%8F%A5%E5%88%86%E7%B1%BB"><span class="toc-text">9.1 语句分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-text">9.2 关联查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-text">9.3 子查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-in-amp-exists"><span class="toc-text">9.4 in &amp; exists</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-%E5%88%86%E9%A1%B5"><span class="toc-text">9.5 分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-6-%E6%9F%A5%E6%89%BE%E5%AD%97%E6%AE%B5%E7%9B%B8%E5%90%8C%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-text">9.6 查找字段相同的数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-7-%E5%BE%AA%E7%8E%AF%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="toc-text">9.7 循环更新数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-8-%E5%BC%BA%E5%88%B6%E5%88%A0%E9%99%A4%E5%A4%96%E9%94%AE%E5%BC%95%E7%94%A8%E7%9A%84%E8%A1%A8"><span class="toc-text">9.8 强制删除外键引用的表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%97%A5%E5%BF%97"><span class="toc-text">10. 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-undoLog"><span class="toc-text">10.1 undoLog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-redoLog"><span class="toc-text">10.2 redoLog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-binLog"><span class="toc-text">10.3 binLog</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90"><span class="toc-text">11. 查询分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">11.1 问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">11.2 慢查询日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-explain"><span class="toc-text">11.3 explain</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-1-explain-%E8%AF%A6%E8%A7%A3"><span class="toc-text">11.3.1 explain 详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-2-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-text">11.3.2 索引优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-3-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">11.3.3 索引失效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-4-%E7%B4%A2%E5%BC%95%E6%80%BB%E7%BB%93"><span class="toc-text">11.3.4 索引总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-4-Show-profile"><span class="toc-text">11.4 Show profile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-5-%E5%85%A8%E5%B1%80%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">11.5 全局查询日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-6-Order-by"><span class="toc-text">11.6 Order by</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-7-Group-by"><span class="toc-text">11.7 Group by</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-SQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-text">12. SQL 性能优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#99-%E9%97%AE%E9%A2%98%E9%9B%86"><span class="toc-text">99. 问题集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#99-1-%E5%88%A0%E9%99%A4%E7%99%BE%E4%B8%87%E7%BA%A7%E5%88%AB%E6%95%B0%E6%8D%AE"><span class="toc-text">99.1 删除百万级别数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-2-%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83%E5%A4%A7%E8%A1%A8%EF%BC%8C%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="toc-text">99.2 线上环境大表，添加索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-3-%E5%A4%A7%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">99.3 大表数据查询优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-4-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">99.4 慢查询优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-5-%E4%BD%BF%E7%94%A8%E4%B8%BB%E9%94%AE"><span class="toc-text">99.5 使用主键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-6-%E5%AD%97%E6%AE%B5%E5%AE%9A%E4%B9%89%E8%A6%81%E6%B1%82not-null%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-text">99.6 字段定义要求not null的好处</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-7-%E5%AD%98%E5%82%A8%E5%AF%86%E7%A0%81%E6%95%A3%E5%88%97"><span class="toc-text">99.7 存储密码散列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-8-%E6%95%B0%E6%8D%AE%E5%BA%93CPU%E9%A3%99%E5%8D%87%E5%88%B0500-%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86"><span class="toc-text">99.8 数据库CPU飙升到500%怎么处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#99-9-%E9%87%8D%E5%A4%8D%E5%80%BC%E9%AB%98%E7%9A%84%E5%AD%97%E6%AE%B5%E4%B8%8D%E8%83%BD%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text">99.9 重复值高的字段不能建索引</span></a></li></ol></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/categories/"
    title="blog/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/CentOS/" href="/categories/CentOS/"><div class='name'>CentOS</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Docker/" href="/categories/Docker/"><div class='name'>Docker</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Golang/" href="/categories/Golang/"><div class='name'>Golang</div><div class='badge'>(39)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Linux/" href="/categories/Linux/"><div class='name'>Linux</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/MySQL/" href="/categories/MySQL/"><div class='name'>MySQL</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Nginx/" href="/categories/Nginx/"><div class='name'>Nginx</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/NoSQL/" href="/categories/NoSQL/"><div class='name'>NoSQL</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/RabbitMQ/" href="/categories/RabbitMQ/"><div class='name'>RabbitMQ</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Tools/" href="/categories/Tools/"><div class='name'>Tools</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/golang/" href="/categories/golang/"><div class='name'>golang</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/k8s/" href="/categories/k8s/"><div class='name'>k8s</div><div class='badge'>(9)</div></a></li>
        
          <li><a class="flat-box" title="/categories/kubernetes/" href="/categories/kubernetes/"><div class='name'>kubernetes</div><div class='badge'>(3)</div></a></li>
        
      </ul>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget tagcloud'>
    
<header class='pure'>
  <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/tags/"
    title="blog/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <a href="/tags/algorithm/" style="font-size: 17.33px; color: #828282">algorithm</a> <a href="/tags/elasticsearch/" style="font-size: 14px; color: #999">elasticsearch</a> <a href="/tags/git/" style="font-size: 14px; color: #999">git</a> <a href="/tags/go/" style="font-size: 24px; color: #555">go</a> <a href="/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/tags/mongodb/" style="font-size: 14px; color: #999">mongodb</a> <a href="/tags/nginx/" style="font-size: 14px; color: #999">nginx</a> <a href="/tags/orm/" style="font-size: 14px; color: #999">orm</a> <a href="/tags/rabbitmq/" style="font-size: 14px; color: #999">rabbitmq</a> <a href="/tags/redis/" style="font-size: 14px; color: #999">redis</a> <a href="/tags/rpc/" style="font-size: 20.67px; color: #6c6c6c">rpc</a> <a href="/tags/supervisor/" style="font-size: 14px; color: #999">supervisor</a> <a href="/tags/websocket/" style="font-size: 14px; color: #999">websocket</a>
    </div>
  </section>


            
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:eli.he@outlook.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/elihe2011"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/#/user/home?id=282243842"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="/js/app.js"></script>



  
<script src="/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
