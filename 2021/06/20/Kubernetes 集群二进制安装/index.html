<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Kubernetes 集群二进制安装 | Eli&#39;s Blog</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/favicon/favicon.ico">
  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Eli's Blog</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Eli's Blog
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" target="_blank" href="https://xaoxuu.com/wiki/material-x/"
                
                  rel="nofollow noopener"
                
                
                id="https:xaoxuu.comwikimaterial-x">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2021/06/20/Kubernetes%20%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/">
        Kubernetes 集群二进制安装
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="https://elihe2011.github.io" rel="nofollow">
        
          <img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png">
        
        <p>Eli He</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2021-06-20</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/kubernetes/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>kubernetes</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <h1 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h1><h2 id="1-1-安装规划"><a href="#1-1-安装规划" class="headerlink" title="1.1 安装规划"></a>1.1 安装规划</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>组件</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master1</td>
<td>192.168.80.45</td>
<td>etcd, api-server, controller-manager, scheduler, docker</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>192.168.80.46</td>
<td>etcd, kubelet, kube-proxy, docker</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>192.168.80.47</td>
<td>etcd, kubelet, kube-proxy, docker</td>
</tr>
</tbody></table>
<p>软件版本：</p>
<table>
<thead>
<tr>
<th>软件</th>
<th>版本</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>OS</td>
<td>Ubuntu 16.04.6 LTS</td>
<td></td>
</tr>
<tr>
<td>Kubernetes</td>
<td>1.21.4</td>
<td></td>
</tr>
<tr>
<td>Etcd</td>
<td>v3.5.0</td>
<td></td>
</tr>
<tr>
<td>Docker</td>
<td>19.03.9</td>
<td></td>
</tr>
</tbody></table>
<span id="more"></span>

<h2 id="1-2-系统设置"><a href="#1-2-系统设置" class="headerlink" title="1.2 系统设置"></a>1.2 系统设置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 修改主机名</span></span><br><span class="line">hostnamectl set-hostname k8s-master</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br><span class="line">hostnamectl set-hostname k8s-node02</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 主机名解析</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.80.45  k8s-master</span></span><br><span class="line"><span class="string">192.168.80.46  k8s-node01</span></span><br><span class="line"><span class="string">192.168.80.47  k8s-node02</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 禁用 swap</span></span><br><span class="line">swapoff -a &amp;&amp; sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 将桥接的IPv4流量传递到iptables的链 </span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF </span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1 </span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1 </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system </span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 时间同步 </span></span><br><span class="line">apt install ntpdate -y </span><br><span class="line">ntpdate ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line">crontab -e</span><br><span class="line">*/30 * * * * /usr/sbin/ntpdate-u ntp1.aliyun.com &gt;&gt; /var/<span class="built_in">log</span>/ntpdate.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>



<h1 id="2-安装-docker"><a href="#2-安装-docker" class="headerlink" title="2. 安装 docker"></a>2. 安装 docker</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 下载安装包</span></span><br><span class="line">wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</span><br><span class="line">tar zxvf docker-19.03.9.tgz</span><br><span class="line">mv docker/* /usr/bin</span><br><span class="line">docker version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 开机启动配置</span></span><br><span class="line">cat &gt; /lib/systemd/system/docker.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Docker Application Container Engine</span></span><br><span class="line"><span class="string">Documentation=https://docs.docker.com</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/dockerd</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">LimitNOFILE=infinity</span></span><br><span class="line"><span class="string">LimitNPROC=infinity</span></span><br><span class="line"><span class="string">LimitCORE=infinity</span></span><br><span class="line"><span class="string">TimeoutStartSec=0</span></span><br><span class="line"><span class="string">Delegate=yes</span></span><br><span class="line"><span class="string">KillMode=process</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">StartLimitBurst=3</span></span><br><span class="line"><span class="string">StartLimitInterval=60s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl status docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>



<h1 id="3-TLS-证书"><a href="#3-TLS-证书" class="headerlink" title="3. TLS 证书"></a>3. TLS 证书</h1><h2 id="3-1-证书工具"><a href="#3-1-证书工具" class="headerlink" title="3.1 证书工具"></a>3.1 证书工具</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line"></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl_1.5.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssljson_1.5.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl-certinfo_1.5.0_linux_amd64</span><br><span class="line"></span><br><span class="line">mv cfssl_1.5.0_linux_amd64 /usr/<span class="built_in">local</span>/bin/cfssl</span><br><span class="line">mv cfssljson_1.5.0_linux_amd64 /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_1.5.0_linux_amd64 /usr/bin/cfssl-certinfo</span><br><span class="line">chmod /usr/<span class="built_in">local</span>/bin/cfssl*</span><br></pre></td></tr></table></figure>



<h2 id="3-2-证书归类"><a href="#3-2-证书归类" class="headerlink" title="3.2 证书归类"></a>3.2 证书归类</h2><p><strong>生成的 CA 证书和秘钥文件如下：</strong></p>
<table>
<thead>
<tr>
<th>组件</th>
<th>证书</th>
<th>密钥</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>etcd</td>
<td>ca.pem、etcd.pem</td>
<td>etcd-key.pem</td>
<td></td>
</tr>
<tr>
<td>apiserver</td>
<td>ca.pem、apiserver.pem</td>
<td>apiserver-key.pem</td>
<td></td>
</tr>
<tr>
<td>controller-manager</td>
<td>ca.pem、kube-controller-manager.pem</td>
<td>ca-key.pem、kube-controller-manager-key.pem</td>
<td>kubeconfig</td>
</tr>
<tr>
<td>scheduler</td>
<td>ca.pem、kube-scheduler.pem</td>
<td>kube-scheduler-key.pem</td>
<td>kubeconfig</td>
</tr>
<tr>
<td>kubelet</td>
<td>ca.pem</td>
<td></td>
<td>kubeconfig+token</td>
</tr>
<tr>
<td>kube-proxy</td>
<td>ca.pem、kube-proxy.pem</td>
<td>kube-proxy-key.pem</td>
<td>kubeconfig</td>
</tr>
<tr>
<td>kubectl</td>
<td>ca.pem、admin.pem</td>
<td>admin-key.pem</td>
<td></td>
</tr>
</tbody></table>
<h2 id="3-3-CA-证书"><a href="#3-3-CA-证书" class="headerlink" title="3.3 CA 证书"></a>3.3 CA 证书</h2><p>CA: Certificate Authority</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/ssl &amp;&amp; <span class="built_in">cd</span> /root/ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. CA 配置文件</span></span><br><span class="line">cat &gt; ca-config.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;signing&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;expiry&quot;: &quot;87600h&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;profiles&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;kubernetes&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">            &quot;client auth&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;expiry&quot;: &quot;87600h&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. CA 证书签名请求文件</span></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">    &quot;ca&quot;: &#123;</span></span><br><span class="line"><span class="string">       &quot;expiry&quot;: &quot;87600h&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 生成CA证书和密钥</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line"></span><br><span class="line">ls  ca*</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span><br></pre></td></tr></table></figure>



<h2 id="3-4-etcd-证书"><a href="#3-4-etcd-证书" class="headerlink" title="3.4 etcd 证书"></a>3.4 etcd 证书</h2><p>注意：hosts 中的IP地址，分别指定了 <code>etcd</code> 集群的主机 IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 证书签名请求文件</span></span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;etcd&quot;,</span></span><br><span class="line"><span class="string">    &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">      &quot;127.0.0.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;localhost&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.45&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.46&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.47&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">            &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">            &quot;O&quot;: &quot;etcd&quot;,</span></span><br><span class="line"><span class="string">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure>



<h2 id="3-5-kube-apiserver-证书"><a href="#3-5-kube-apiserver-证书" class="headerlink" title="3.5 kube-apiserver 证书"></a>3.5 kube-apiserver 证书</h2><p>注意：hosts 中的IP地址，分别指定了 <code>kubernetes master</code> 集群的主机 IP 和 <strong><code>kubernetes</code> 服务的服务 IP</strong>（一般是 <code>kube-apiserver</code> 指定的 <code>service-cluster-ip-range</code> 网段的第一个IP，如 10.96.0.1）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 证书签名请求文件</span></span><br><span class="line">cat &gt; kube-apiserver-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class="line"><span class="string">    &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">      &quot;127.0.0.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;localhost&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.2&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.45&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.46&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.47&quot;,</span></span><br><span class="line"><span class="string">      &quot;10.96.0.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default.svc&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default.svc.cluster&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">            &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">            &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class="line"><span class="string">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br></pre></td></tr></table></figure>



<h2 id="3-6-kube-controller-manager-证书"><a href="#3-6-kube-controller-manager-证书" class="headerlink" title="3.6 kube-controller-manager 证书"></a>3.6 kube-controller-manager 证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 证书签名请求文件</span></span><br><span class="line">cat &gt; kube-controller-manager-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span></span><br><span class="line"><span class="string">  &quot;hosts&quot;: [],</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure>



<h2 id="3-8-kube-scheduler-证书"><a href="#3-8-kube-scheduler-证书" class="headerlink" title="3.8 kube-scheduler 证书"></a>3.8 kube-scheduler 证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 证书签名请求文件</span></span><br><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span></span><br><span class="line"><span class="string">  &quot;hosts&quot;: [],</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure>



<h2 id="3-9-admin-证书"><a href="#3-9-admin-证书" class="headerlink" title="3.9 admin 证书"></a>3.9 admin 证书</h2><ul>
<li>后续 <code>kube-apiserver</code> 使用 <code>RBAC</code> 对客户端(如 <code>kubelet</code>、<code>kube-proxy</code>、<code>Pod</code>)请求进行授权；</li>
<li><code>kube-apiserver</code> 预定义了一些 <code>RBAC</code> 使用的 <code>RoleBindings</code>，如 <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> 的<strong>所有 API</strong>的权限；</li>
<li>O 指定该证书的 Group 为 <code>system:masters</code>，<code>kubelet</code> 使用该证书访问 <code>kube-apiserver</code> 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 <code>system:masters</code>，所以被授予访问所有 API 的权限；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 证书签名请求文件</span></span><br><span class="line">cat &gt; admin-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;admin&quot;,</span></span><br><span class="line"><span class="string">  &quot;hosts&quot;: [],</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成证书 </span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"></span><br><span class="line">ls admin*</span><br><span class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</span><br></pre></td></tr></table></figure>

<p>搭建完 kubernetes 集群后，可以通过命令: <code>kubectl get clusterrolebinding cluster-admin -o yaml</code> ,查看到 <code>clusterrolebinding cluster-admin</code> 的 subjects 的 kind 是 Group，name 是 <code>system:masters</code>。 <code>roleRef</code> 对象是 <code>ClusterRole cluster-admin</code>。 即 <code>system:masters Group</code> 的 user 或者 <code>serviceAccount</code> 都拥有 <code>cluster-admin</code> 的角色。 因此在使用 kubectl 命令时候，才拥有整个集群的管理权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kubectl get clusterrolebinding cluster-admin -o yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">&quot;true&quot;</span></span><br><span class="line">  creationTimestamp: 2017-04-11T11:20:42Z</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  resourceVersion: <span class="string">&quot;52&quot;</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin</span><br><span class="line">  uid: e61b97b2-1ea8-11e7-8cd7-f4e9d49f8ed0</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:masters</span><br></pre></td></tr></table></figure>



<h2 id="3-10-kube-proxy-证书"><a href="#3-10-kube-proxy-证书" class="headerlink" title="3.10 kube-proxy 证书"></a>3.10 kube-proxy 证书</h2><ul>
<li>CN 指定该证书的 User 为 <code>system:kube-proxy</code>；</li>
<li><code>kube-apiserver</code> 预定义的 RoleBinding <code>system:node-proxier</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 证书签名请求文件</span></span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span></span><br><span class="line"><span class="string">  &quot;hosts&quot;: [],</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure>




<h2 id="3-11-证书信息"><a href="#3-11-证书信息" class="headerlink" title="3.11 证书信息"></a>3.11 证书信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">cfssl-certinfo -cert apiserver.pem</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;subject&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;common_name&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;country&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organization&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organizational_unit&quot;</span>: <span class="string">&quot;System&quot;</span>,</span><br><span class="line">    <span class="string">&quot;locality&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;province&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;System&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;issuer&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;common_name&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;country&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organization&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organizational_unit&quot;</span>: <span class="string">&quot;System&quot;</span>,</span><br><span class="line">    <span class="string">&quot;locality&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;province&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;System&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;serial_number&quot;</span>: <span class="string">&quot;275867496157961939649344217740970264800633176866&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sans&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster.local&quot;</span>,</span><br><span class="line">    <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.80.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.80.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.80.45&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.80.46&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.80.47&quot;</span>,</span><br><span class="line">    <span class="string">&quot;10.96.0.1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;not_before&quot;</span>: <span class="string">&quot;2021-06-09T05:20:00Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;not_after&quot;</span>: <span class="string">&quot;2031-06-07T05:20:00Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sigalg&quot;</span>: <span class="string">&quot;SHA256WithRSA&quot;</span>,</span><br><span class="line">  <span class="string">&quot;authority_key_id&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;subject_key_id&quot;</span>: <span class="string">&quot;E3:84:0F:9C:00:07:4A:8F:5C:B2:35:45:A0:50:4D:3E:9D:C0:B4:D0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pem&quot;</span>: <span class="string">&quot;-----BEGIN CERTIFICATE-----\nMIIEezCCA2OgAwIBAgIUMFJTjEXe9sDDDpPXcAiUBt5+QyIwDQYJKoZIhvcNAQEL\nBQAwZTELMAkGA1UEBhMCQ04xEDAOBgNVBAgTB0JlaUppbmcxEDAOBgNVBAcTB0Jl\naUppbmcxDDAKBgNVBAoTA2s4czEPMA0GA1UECxMGU3lzdGVtMRMwEQYDVQQDEwpr\ndWJlcm5ldGVzMB4XDTIxMDYwOTA1MjAwMFoXDTMxMDYwNzA1MjAwMFowZTELMAkG\nA1UEBhMCQ04xEDAOBgNVBAgTB0JlaUppbmcxEDAOBgNVBAcTB0JlaUppbmcxDDAK\nBgNVBAoTA2s4czEPMA0GA1UECxMGU3lzdGVtMRMwEQYDVQQDEwprdWJlcm5ldGVz\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAw0BpjZQNEd6Oqu8ubEWG\nhbdwJecOTCfdbY+VLIKEm0Tys8ZBlu7OrtZ8Rj5OAZTXil0ZJz+hvHo8YTNJJ16g\njHV88VSpfoXD5DE59PITSFwfY1lWHVctC3Ddo9CM9cU9Ty+Kf29XcrLbc/VNGZTB\ncvKXoM3b6NkBKOdKphVjUvafhKC6ls2ac5uub3uqZTpPgBs/1PvINKNZkP5U6lUV\noTBMAT+qbQ9aggA+bA+WegL3jHU78ngo1XMnsb1HfAjwKDOf66smNJ/K+YjD+Cul\ngjpyqOQKGlz5xqXUcBgIMO9djI4f5hvaMsSje1aSJ/oh5AfQbxQsGjajlS80ED08\nxwIDAQABo4IBITCCAR0wDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUF\nBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBTjhA+cAAdKj1yy\nNUWgUE0+ncC00DCBvgYDVR0RBIG2MIGzgglsb2NhbGhvc3SCCmt1YmVybmV0ZXOC\nEmt1YmVybmV0ZXMuZGVmYXVsdIIWa3ViZXJuZXRlcy5kZWZhdWx0LnN2Y4Iea3Vi\nZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVygiRrdWJlcm5ldGVzLmRlZmF1bHQu\nc3ZjLmNsdXN0ZXIubG9jYWyHBH8AAAGHBMCoUAGHBMCoUAKHBMCoUC2HBMCoUC6H\nBMCoUC+HBAr+AAEwDQYJKoZIhvcNAQELBQADggEBAG+RUKp4cxz4EOqmAPiczkl2\nHciAg01RbCavoLoUWmoDDAQf7PIhQF2pLewFCwR5w6SwvCJAVdg+eHdefJ2MBtJr\nKQgbmEOBXd4Z5ZqBeSP6ViHvb1pKtRSldznZLfxjsVd0bN3na/JmS4TZ90SqLLtL\nN4CgGfTs2AfrtbtWIqewDMS9aWjBK8VePzLBmsdLddD4WYQOnl+QjdrX9bbqYRCG\nQo3CKvJ3JZqh6AJHcgKsm0702uMU/TCJwe1M8I8SpYrwA74uCBy3O9jXed1rZlrp\nRVURB6Ro7SMLjiadTJyf6AbLPMmZcPKHhZ1XG07q8Od2Kd+KVx1PxF3et6OOteE=\n-----END CERTIFICATE-----\n&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-12-分发证书"><a href="#3-12-分发证书" class="headerlink" title="3.12 分发证书"></a>3.12 分发证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/pki</span><br><span class="line">cp *.pem /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>



<h1 id="4-安装-etcd-多节点"><a href="#4-安装-etcd-多节点" class="headerlink" title="4. 安装 etcd  (多节点)"></a>4. 安装 etcd  (多节点)</h1><h2 id="4-1-节点-etcd-1"><a href="#4-1-节点-etcd-1" class="headerlink" title="4.1 节点 etcd-1"></a>4.1 节点 etcd-1</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 下载并安装</span></span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class="line">tar zxvf etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv etcd-v3.5.0-linux-amd64/&#123;etcd,etcdctl&#125; /usr/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置文件</span></span><br><span class="line">mkdir -p /etc/etcd</span><br><span class="line">cat &gt; /etc/etcd/etcd.conf.yml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Human-readable name for this member.</span></span><br><span class="line"><span class="string">name: &#x27;etcd-1&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Path to the data directory.</span></span><br><span class="line"><span class="string">data-dir: /var/lib/etcd/default.etcd</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="string">wal-dir:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="string">snapshot-count: 10000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="string">heartbeat-interval: 100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="string">election-timeout: 1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="string"># default quota.</span></span><br><span class="line"><span class="string">quota-backend-bytes: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="string">listen-peer-urls: &#x27;https://localhost:2380,https://192.168.80.45:2380&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="string">listen-client-urls: &#x27;https://localhost:2379,https://192.168.80.45:2379&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="string">max-snapshots: 5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="string">max-wals: 5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="string">cors:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># List of this member&#x27;s peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="string"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="string">initial-advertise-peer-urls: &#x27;https://localhost:2380,https://192.168.80.45:2380&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># List of this member&#x27;s client URLs to advertise to the public.</span></span><br><span class="line"><span class="string"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="string">advertise-client-urls: &#x27;https://localhost:2379,https://192.168.80.45:2379&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="string">discovery:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Valid values include &#x27;exit&#x27;, &#x27;proxy&#x27;</span></span><br><span class="line"><span class="string">discovery-fallback: &#x27;proxy&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="string">discovery-proxy:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="string">discovery-srv:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="string">initial-cluster: &#x27;etcd-1=https://192.168.80.45:2380,etcd-2=https://192.168.80.46:2380,etcd-3=https://192.168.80.47:2380&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="string">initial-cluster-token: &#x27;etcd-cluster&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Initial cluster state (&#x27;new&#x27; or &#x27;existing&#x27;).</span></span><br><span class="line"><span class="string">initial-cluster-state: &#x27;new&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="string">strict-reconfig-check: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="string">enable-v2: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="string">enable-pprof: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Valid values include &#x27;on&#x27;, &#x27;readonly&#x27;, &#x27;off&#x27;</span></span><br><span class="line"><span class="string">proxy: &#x27;off&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="string">proxy-failure-wait: 5000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="string">proxy-refresh-interval: 30000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="string">proxy-dial-timeout: 1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="string">proxy-write-timeout: 5000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="string">proxy-read-timeout: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">client-transport-security:</span></span><br><span class="line"><span class="string">  # Path to the client server TLS cert file.</span></span><br><span class="line"><span class="string">  cert-file: /etc/kubernetes/pki/etcd.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Path to the client server TLS key file.</span></span><br><span class="line"><span class="string">  key-file: /etc/kubernetes/pki/etcd-key.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Enable client cert authentication.</span></span><br><span class="line"><span class="string">  client-cert-auth: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="string">  trusted-ca-file: /etc/kubernetes/pki/ca.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Client TLS using generated certificates</span></span><br><span class="line"><span class="string">  auto-tls: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">peer-transport-security:</span></span><br><span class="line"><span class="string">  # Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="string">  cert-file: /etc/kubernetes/pki/etcd.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Path to the peer server TLS key file.</span></span><br><span class="line"><span class="string">  key-file: /etc/kubernetes/pki/etcd-key.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Enable peer client cert authentication.</span></span><br><span class="line"><span class="string">  client-cert-auth: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="string">  trusted-ca-file: /etc/kubernetes/pki/ca.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Peer TLS using generated certificates.</span></span><br><span class="line"><span class="string">  auto-tls: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="string">log-level: debug</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">logger: zap</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Specify &#x27;stdout&#x27; or &#x27;stderr&#x27; to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="string">log-outputs: [stderr]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="string">force-new-cluster: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">auto-compaction-mode: periodic</span></span><br><span class="line"><span class="string">auto-compaction-retention: &quot;1&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开机启动</span></span><br><span class="line">cat &gt; /lib/systemd/system/etcd.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd Server</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/etcd --config-file=/etc/etcd/etcd.conf.yml</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=5</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<h2 id="4-2-其他节点"><a href="#4-2-其他节点" class="headerlink" title="4.2 其他节点"></a>4.2 其他节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 解压克隆文件</span></span><br><span class="line">sudo -i</span><br><span class="line"><span class="built_in">cd</span> / &amp;&amp; mv /home/ubuntu/etcd-clone.tar / &amp;&amp; tar xvf etcd-clone.tar &amp;&amp; rm -f etcd-clone.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 修改配置文件, 改成各自对应的IP和名称</span></span><br><span class="line">vi /etc/etcd/etcd.conf.yml</span><br></pre></td></tr></table></figure>



<h2 id="4-3-启动"><a href="#4-3-启动" class="headerlink" title="4.3 启动"></a>4.3 启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 开机启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl status etcd</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 运行状态</span></span><br><span class="line">etcdctl member list --cacert=/etc/kubernetes/pki/ca.pem --cert=/etc/kubernetes/pki/etcd.pem --key=/etc/kubernetes/pki/etcd-key.pem --write-out=table</span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+------------+</span><br><span class="line">|        ID        | STATUS  |  NAME  |         PEER ADDRS         |        CLIENT ADDRS        | IS LEARNER |</span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+------------+</span><br><span class="line">| 46bc5ad35e418584 | started | etcd-1 | https://192.168.80.45:2380 | https://192.168.80.45:2379 |      <span class="literal">false</span> |</span><br><span class="line">| 8f347c1327049bc8 | started | etcd-3 | https://192.168.80.47:2380 | https://192.168.80.47:2379 |      <span class="literal">false</span> |</span><br><span class="line">| b01e7a29099f3eb8 | started | etcd-2 | https://192.168.80.46:2380 | https://192.168.80.46:2379 |      <span class="literal">false</span> |</span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 健康状态</span></span><br><span class="line">etcdctl endpoint health --cacert=/etc/kubernetes/pki/ca.pem --cert=/etc/kubernetes/pki/etcd.pem --key=/etc/kubernetes/pki/etcd-key.pem --cluster --write-out=table</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">|          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">| https://192.168.80.47:2379 |   <span class="literal">true</span> | 20.973639ms |       |</span><br><span class="line">| https://192.168.80.46:2379 |   <span class="literal">true</span> | 29.842299ms |       |</span><br><span class="line">| https://192.168.80.45:2379 |   <span class="literal">true</span> | 30.564766ms |       |</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></figure>



<h1 id="4-安装-etcd-单节点"><a href="#4-安装-etcd-单节点" class="headerlink" title="4. 安装 etcd  (单节点)"></a>4. 安装 etcd  (单节点)</h1><h2 id="4-1-节点-etcd-1-1"><a href="#4-1-节点-etcd-1-1" class="headerlink" title="4.1 节点 etcd-1"></a>4.1 节点 etcd-1</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 下载并安装</span></span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class="line">tar zxvf etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv etcd-v3.5.0-linux-amd64/&#123;etcd,etcdctl&#125; /usr/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置文件</span></span><br><span class="line">mkdir -p /etc/etcd</span><br><span class="line">cat &gt; /etc/etcd/etcd.conf.yml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">name: &#x27;etcd-1&#x27;</span></span><br><span class="line"><span class="string">data-dir: /var/lib/etcd/default.etcd</span></span><br><span class="line"><span class="string">wal-dir:</span></span><br><span class="line"><span class="string">snapshot-count: 10000</span></span><br><span class="line"><span class="string">heartbeat-interval: 100</span></span><br><span class="line"><span class="string">election-timeout: 1000</span></span><br><span class="line"><span class="string">quota-backend-bytes: 0</span></span><br><span class="line"><span class="string">listen-peer-urls: &#x27;https://localhost:2380,https://192.168.80.45:2380&#x27;</span></span><br><span class="line"><span class="string">listen-client-urls: &#x27;https://localhost:2379,https://192.168.80.45:2379&#x27;</span></span><br><span class="line"><span class="string">max-snapshots: 5</span></span><br><span class="line"><span class="string">max-wals: 5</span></span><br><span class="line"><span class="string">cors:</span></span><br><span class="line"><span class="string">initial-advertise-peer-urls: &#x27;https://localhost:2380,https://192.168.80.45:2380&#x27;</span></span><br><span class="line"><span class="string">advertise-client-urls: &#x27;https://localhost:2379,https://192.168.80.45:2379&#x27;</span></span><br><span class="line"><span class="string">discovery:</span></span><br><span class="line"><span class="string">discovery-fallback: &#x27;proxy&#x27;</span></span><br><span class="line"><span class="string">discovery-proxy:</span></span><br><span class="line"><span class="string">discovery-srv:</span></span><br><span class="line"><span class="string">strict-reconfig-check: false</span></span><br><span class="line"><span class="string">enable-v2: true</span></span><br><span class="line"><span class="string">enable-pprof: true</span></span><br><span class="line"><span class="string">proxy: &#x27;off&#x27;</span></span><br><span class="line"><span class="string">proxy-failure-wait: 5000</span></span><br><span class="line"><span class="string">proxy-refresh-interval: 30000</span></span><br><span class="line"><span class="string">proxy-dial-timeout: 1000</span></span><br><span class="line"><span class="string">proxy-write-timeout: 5000</span></span><br><span class="line"><span class="string">proxy-read-timeout: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">client-transport-security:</span></span><br><span class="line"><span class="string">  cert-file: /etc/kubernetes/pki/etcd.pem</span></span><br><span class="line"><span class="string">  key-file: /etc/kubernetes/pki/etcd-key.pem</span></span><br><span class="line"><span class="string">  client-cert-auth: true</span></span><br><span class="line"><span class="string">  trusted-ca-file: /etc/kubernetes/pki/ca.pem</span></span><br><span class="line"><span class="string">  auto-tls: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">peer-transport-security:</span></span><br><span class="line"><span class="string">  cert-file: /etc/kubernetes/pki/etcd.pem</span></span><br><span class="line"><span class="string">  key-file: /etc/kubernetes/pki/etcd-key.pem</span></span><br><span class="line"><span class="string">  client-cert-auth: true</span></span><br><span class="line"><span class="string">  trusted-ca-file: /etc/kubernetes/pki/ca.pem</span></span><br><span class="line"><span class="string">  auto-tls: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">log-level: debug</span></span><br><span class="line"><span class="string">logger: zap</span></span><br><span class="line"><span class="string">log-outputs: [stderr]</span></span><br><span class="line"><span class="string">force-new-cluster: false</span></span><br><span class="line"><span class="string">auto-compaction-mode: periodic</span></span><br><span class="line"><span class="string">auto-compaction-retention: &quot;1&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开机启动</span></span><br><span class="line">cat &gt; /lib/systemd/system/etcd.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd Server</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/etcd --config-file=/etc/etcd/etcd.conf.yml</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=5</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl status etcd</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 运行状态</span></span><br><span class="line">etcdctl member list --cacert=/etc/kubernetes/pki/ca.pem --cert=/etc/kubernetes/pki/etcd.pem --key=/etc/kubernetes/pki/etcd-key.pem --write-out=table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 健康状态</span></span><br><span class="line">etcdctl endpoint health --cacert=/etc/kubernetes/pki/ca.pem --cert=/etc/kubernetes/pki/etcd.pem --key=/etc/kubernetes/pki/etcd-key.pem --cluster --write-out=table</span><br></pre></td></tr></table></figure>



<h1 id="5-Master-节点"><a href="#5-Master-节点" class="headerlink" title="5. Master 节点"></a>5. Master 节点</h1><p>kubernetes master 节点组件：</p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
<li>kubelet （非必须，但必要）</li>
<li>kube-proxy（非必须，但必要）</li>
</ul>
<h2 id="5-1-安装准备"><a href="#5-1-安装准备" class="headerlink" title="5.1 安装准备"></a>5.1 安装准备</h2><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.21.md">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.21.md</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line">wget https://dl.k8s.io/v1.21.4/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> kubernetes/server/bin</span><br><span class="line">cp kube-apiserver kube-scheduler kube-controller-manager kubectl kubelet kube-proxy /usr/bin</span><br></pre></td></tr></table></figure>



<h2 id="5-2-apiserver"><a href="#5-2-apiserver" class="headerlink" title="5.2 apiserver"></a>5.2 apiserver</h2><h3 id="5-2-1-TLS-Bootstrapping-Token"><a href="#5-2-1-TLS-Bootstrapping-Token" class="headerlink" title="5.2.1 TLS Bootstrapping Token"></a>5.2.1 TLS Bootstrapping Token</h3><p><strong>启用 TLS Bootstrapping 机制：</strong></p>
<p>TLS Bootstraping：Master apiserver启用TLS认证后，Node节点kubelet和kube-proxy要与kube-apiserver进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目前主要用于kubelet，kube-proxy还是由我们统一颁发一个证书。</p>
<p><code>TLS bootstraping</code> 工作流程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-tls-bootstrap.png" alt="img"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d <span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式：token，用户名，UID，用户组</span></span><br><span class="line">cat &gt; /etc/kubernetes/token.csv &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">$&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<h3 id="5-2-2-开机启动"><a href="#5-2-2-开机启动" class="headerlink" title="5.2.2 开机启动"></a>5.2.2 开机启动</h3><p><code>--service-cluster-ip-range=10.96.0.0/16</code>: Service IP 段</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER_OPTS=<span class="string">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span></span><br><span class="line"><span class="string">  --anonymous-auth=false \</span></span><br><span class="line"><span class="string">  --bind-address=192.168.80.45 \</span></span><br><span class="line"><span class="string">  --secure-port=6443 \</span></span><br><span class="line"><span class="string">  --advertise-address=192.168.80.45 \</span></span><br><span class="line"><span class="string">  --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">  --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">  --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">  --token-auth-file=/etc/kubernetes/token.csv \</span></span><br><span class="line"><span class="string">  --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/pki/kube-apiserver.pem  \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/pki/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --client-ca-file=/etc/kubernetes/pki/ca.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-certificate=/etc/kubernetes/pki/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-key=/etc/kubernetes/pki/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-key-file=/etc/kubernetes/pki/ca-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-signing-key-file=/etc/kubernetes/pki/ca-key.pem  \</span></span><br><span class="line"><span class="string">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span></span><br><span class="line"><span class="string">  --etcd-cafile=/etc/kubernetes/pki/ca.pem \</span></span><br><span class="line"><span class="string">  --etcd-certfile=/etc/kubernetes/pki/etcd.pem \</span></span><br><span class="line"><span class="string">  --etcd-keyfile=/etc/kubernetes/pki/etcd-key.pem \</span></span><br><span class="line"><span class="string">  --etcd-servers=https://192.168.80.45:2379 \</span></span><br><span class="line"><span class="string">  --allow-privileged=true \</span></span><br><span class="line"><span class="string">  --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">  --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">  --audit-log-path=/var/log/kubernetes/kube-apiserver-audit.log \</span></span><br><span class="line"><span class="string">  --event-ttl=1h \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=2&quot;</span></span><br><span class="line"></span><br><span class="line">cat &gt; /lib/systemd/system/kube-apiserver.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes API Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-apiserver $KUBE_APISERVER_OPTS</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver </span><br><span class="line">systemctl status kube-apiserver </span><br><span class="line">systemctl <span class="built_in">enable</span> kube-apiserver</span><br></pre></td></tr></table></figure>



<h3 id="5-2-3-kubectl-管理集群"><a href="#5-2-3-kubectl-管理集群" class="headerlink" title="5.2.3 kubectl 管理集群"></a>5.2.3 kubectl 管理集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/.kube</span><br><span class="line"></span><br><span class="line">KUBE_CONFIG=/root/.kube/config</span><br><span class="line">KUBE_APISERVER=<span class="string">&quot;https://192.168.80.45:6443&quot;</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-credentials cluster-admin \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/admin.pem \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/admin-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=cluster-admin \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config use-context default --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="5-2-4-授权-kubelet-bootstrap-用户允许请求证书"><a href="#5-2-4-授权-kubelet-bootstrap-用户允许请求证书" class="headerlink" title="5.2.4 授权 kubelet-bootstrap 用户允许请求证书"></a>5.2.4 授权 kubelet-bootstrap 用户允许请求证书</h3><p>防止错误：<code>failed to run Kubelet: cannot create certificate signing request: certificatesigningrequests.certificates.k8s.io is forbidden: User &quot;kubelet-bootstrap&quot; cannot create resource &quot;certificatesigningrequests&quot; in API group &quot;certificates.k8s.io&quot; at the cluster scope</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>



<h3 id="5-2-5-授权-apiserver-访问-kubelet"><a href="#5-2-5-授权-apiserver-访问-kubelet" class="headerlink" title="5.2.5 授权 apiserver 访问 kubelet"></a>5.2.5 授权 <code>apiserver</code> 访问 <code>kubelet</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line"></span><br><span class="line">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: ClusterRole</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    kubernetes.io/bootstrapping: rbac-defaults</span></span><br><span class="line"><span class="string">  name: system:kube-apiserver-to-kubelet</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">  - apiGroups:</span></span><br><span class="line"><span class="string">      - &quot;&quot;</span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">      - nodes/proxy</span></span><br><span class="line"><span class="string">      - nodes/stats</span></span><br><span class="line"><span class="string">      - nodes/log</span></span><br><span class="line"><span class="string">      - nodes/spec</span></span><br><span class="line"><span class="string">      - nodes/metrics</span></span><br><span class="line"><span class="string">      - pods/log</span></span><br><span class="line"><span class="string">    verbs:</span></span><br><span class="line"><span class="string">      - &quot;*&quot;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: ClusterRoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: system:kube-apiserver</span></span><br><span class="line"><span class="string">  namespace: &quot;&quot;</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: ClusterRole</span></span><br><span class="line"><span class="string">  name: system:kube-apiserver-to-kubelet</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">  - apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">    kind: User</span></span><br><span class="line"><span class="string">    name: kubernetes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>



<h2 id="5-3-controller-manager"><a href="#5-3-controller-manager" class="headerlink" title="5.3 controller-manager"></a>5.3 controller-manager</h2><h3 id="5-3-1-kubeconfig"><a href="#5-3-1-kubeconfig" class="headerlink" title="5.3.1 kubeconfig"></a>5.3.1 kubeconfig</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONFIG=<span class="string">&quot;/etc/kubernetes/kube-controller-manager.kubeconfig&quot;</span></span><br><span class="line">KUBE_APISERVER=<span class="string">&quot;https://192.168.80.45:6443&quot;</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-credentials kube-controller-manager \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/kube-controller-manager.pem \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-controller-manager \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config use-context default --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="5-3-2-开机启动"><a href="#5-3-2-开机启动" class="headerlink" title="5.3.2 开机启动"></a>5.3.2 开机启动</h3><p><code>--cluster-cidr=10.244.0.0/16</code>: Pod IP  段</p>
<p><code>--service-cluster-ip-range=10.96.0.0/16</code>: Service IP 段</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">&quot;--logtostderr=false \</span></span><br><span class="line"><span class="string">--v=2 \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">--bind-address=127.0.0.1 \</span></span><br><span class="line"><span class="string">--allocate-node-cidrs=true \</span></span><br><span class="line"><span class="string">--cluster-cidr=10.244.0.0/16 \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">--cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \</span></span><br><span class="line"><span class="string">--cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem  \</span></span><br><span class="line"><span class="string">--root-ca-file=/etc/kubernetes/pki/ca.pem \</span></span><br><span class="line"><span class="string">--service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem \</span></span><br><span class="line"><span class="string">--cluster-signing-duration=87600h0m0s&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; /lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Controller Manager</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl status kube-controller-manager</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-controller-manager</span><br></pre></td></tr></table></figure>



<h2 id="5-4-scheduler"><a href="#5-4-scheduler" class="headerlink" title="5.4 scheduler"></a>5.4 scheduler</h2><h3 id="5-4-1-kubeconfig"><a href="#5-4-1-kubeconfig" class="headerlink" title="5.4.1 kubeconfig"></a>5.4.1 kubeconfig</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONFIG=<span class="string">&quot;/etc/kubernetes/kube-scheduler.kubeconfig&quot;</span></span><br><span class="line">KUBE_APISERVER=<span class="string">&quot;https://192.168.80.45:6443&quot;</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-credentials kube-scheduler \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/kube-scheduler.pem \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-scheduler \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config use-context default --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="5-4-2-开机启动"><a href="#5-4-2-开机启动" class="headerlink" title="5.4.2 开机启动"></a>5.4.2 开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">&quot;--logtostderr=false \</span></span><br><span class="line"><span class="string">--v=2 \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--leader-elect \</span></span><br><span class="line"><span class="string">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">--bind-address=127.0.0.1&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; /lib/systemd/system/kube-scheduler.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Scheduler</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-scheduler</span><br></pre></td></tr></table></figure>



<h2 id="5-5-kubelet"><a href="#5-5-kubelet" class="headerlink" title="5.5 kubelet"></a>5.5 kubelet</h2><h3 id="5-5-1-参数配置"><a href="#5-5-1-参数配置" class="headerlink" title="5.5.1 参数配置"></a>5.5.1 参数配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kubelet-config.yml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">address: 0.0.0.0</span></span><br><span class="line"><span class="string">port: 10250</span></span><br><span class="line"><span class="string">readOnlyPort: 10255</span></span><br><span class="line"><span class="string">cgroupDriver: cgroupfs</span></span><br><span class="line"><span class="string">clusterDNS:</span></span><br><span class="line"><span class="string">- 10.96.0.2</span></span><br><span class="line"><span class="string">clusterDomain: cluster.local </span></span><br><span class="line"><span class="string">failSwapOn: false</span></span><br><span class="line"><span class="string">authentication:</span></span><br><span class="line"><span class="string">  anonymous:</span></span><br><span class="line"><span class="string">    enabled: false</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheTTL: 2m0s</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">  x509:</span></span><br><span class="line"><span class="string">    clientCAFile: /etc/kubernetes/pki/ca.pem </span></span><br><span class="line"><span class="string">authorization:</span></span><br><span class="line"><span class="string">  mode: Webhook</span></span><br><span class="line"><span class="string">  webhook:</span></span><br><span class="line"><span class="string">    cacheAuthorizedTTL: 5m0s</span></span><br><span class="line"><span class="string">    cacheUnauthorizedTTL: 30s</span></span><br><span class="line"><span class="string">evictionHard:</span></span><br><span class="line"><span class="string">  imagefs.available: 15%</span></span><br><span class="line"><span class="string">  memory.available: 100Mi</span></span><br><span class="line"><span class="string">  nodefs.available: 10%</span></span><br><span class="line"><span class="string">  nodefs.inodesFree: 5%</span></span><br><span class="line"><span class="string">maxOpenFiles: 1000000</span></span><br><span class="line"><span class="string">maxPods: 110</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<h3 id="5-5-2-kubeconfig"><a href="#5-5-2-kubeconfig" class="headerlink" title="5.5.2 kubeconfig"></a>5.5.2 kubeconfig</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">BOOTSTRAP_TOKEN=$(cat /etc/kubernetes/token.csv | awk -F, <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">KUBE_CONFIG=<span class="string">&quot;/etc/kubernetes/bootstrap.kubeconfig&quot;</span></span><br><span class="line">KUBE_APISERVER=<span class="string">&quot;https://192.168.80.45:6443&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 kubelet bootstrap kubeconfig 配置文件</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-credentials <span class="string">&quot;kubelet-bootstrap&quot;</span> \</span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=<span class="string">&quot;kubelet-bootstrap&quot;</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config use-context default --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="5-5-3-开机启动"><a href="#5-5-3-开机启动" class="headerlink" title="5.5.3 开机启动"></a>5.5.3 开机启动</h3><p>其中：<code>--kubeconfig=/etc/kubernetes/kubelet.kubeconfig</code> 在加入集群时自动生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_OPTS=<span class="string">&quot;--logtostderr=false \</span></span><br><span class="line"><span class="string">--v=2 \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--hostname-override=k8s-master1 \</span></span><br><span class="line"><span class="string">--network-plugin=cni \</span></span><br><span class="line"><span class="string">--kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">--config=/etc/kubernetes/kubelet-config.yml \</span></span><br><span class="line"><span class="string">--cert-dir=/etc/kubernetes/pki \</span></span><br><span class="line"><span class="string">--pod-infra-container-image=mirrorgooglecontainers/pause-amd64:3.1&quot;</span></span><br><span class="line"></span><br><span class="line">cat &gt; /lib/systemd/system/kubelet.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Kubelet</span></span><br><span class="line"><span class="string">After=docker.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kubelet $KUBELET_OPTS</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl status kubelet</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure>



<h3 id="5-5-4-加入集群"><a href="#5-5-4-加入集群" class="headerlink" title="5.5.4 加入集群"></a>5.5.4 加入集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看kubelet证书请求</span></span><br><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-ghWG-AWFM9sxJbr5A-BIq9puVIRxfFHrQlwDjYbHba8   25s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批准申请</span></span><br><span class="line">kubectl certificate approve node-csr-ghWG-AWFM9sxJbr5A-BIq9puVIRxfFHrQlwDjYbHba8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看证书</span></span><br><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-ghWG-AWFM9sxJbr5A-BIq9puVIRxfFHrQlwDjYbHba8   53m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点（由于网络插件还没有部署，节点会没有准备就绪 NotReady）</span></span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   NotReady   &lt;none&gt;   4m8s   v1.21.4</span><br></pre></td></tr></table></figure>



<h2 id="5-6-kube-proxy"><a href="#5-6-kube-proxy" class="headerlink" title="5.6 kube-proxy"></a>5.6 kube-proxy</h2><h3 id="5-6-1-参数配置"><a href="#5-6-1-参数配置" class="headerlink" title="5.6.1 参数配置"></a>5.6.1 参数配置</h3><p><code>clusterCIDR: 10.96.0.0/16</code>: Service IP 段，与apiserver &amp; controller-manager 的<code>--service-cluster-ip-range</code> 一致</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kube-proxy-config.yml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">bindAddress: 0.0.0.0</span></span><br><span class="line"><span class="string">metricsBindAddress: 0.0.0.0:10249</span></span><br><span class="line"><span class="string">clientConnection:</span></span><br><span class="line"><span class="string">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span></span><br><span class="line"><span class="string">hostnameOverride: k8s-master1</span></span><br><span class="line"><span class="string">clusterCIDR: 10.96.0.0/16</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<h3 id="5-6-2-kubeconfig-文件"><a href="#5-6-2-kubeconfig-文件" class="headerlink" title="5.6.2 kubeconfig 文件"></a>5.6.2 kubeconfig 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONFIG=<span class="string">&quot;/etc/kubernetes/kube-proxy.kubeconfig&quot;</span></span><br><span class="line">KUBE_APISERVER=<span class="string">&quot;https://192.168.80.45:6443&quot;</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br><span class="line">kubectl config use-context default --kubeconfig=<span class="variable">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="5-6-3-开机启动"><a href="#5-6-3-开机启动" class="headerlink" title="5.6.3 开机启动"></a>5.6.3 开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">KUBE_PROXY_OPTS=<span class="string">&quot;--logtostderr=false \</span></span><br><span class="line"><span class="string">--v=2 \</span></span><br><span class="line"><span class="string">--proxy-mode=iptables \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--config=/etc/kubernetes/kube-proxy-config.yml&quot;</span></span><br><span class="line"></span><br><span class="line">cat &gt; /lib/systemd/system/kube-proxy.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Proxy</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-proxy $KUBE_PROXY_OPTS</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl status kube-proxy</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy</span><br></pre></td></tr></table></figure>



<h2 id="5-7-集群管理"><a href="#5-7-集群管理" class="headerlink" title="5.7 集群管理"></a>5.7 集群管理</h2><h3 id="5-7-1-集群配置信息"><a href="#5-7-1-集群配置信息" class="headerlink" title="5.7.1 集群配置信息"></a>5.7.1 集群配置信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kubectl config view</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.80.45:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: cluster-admin</span><br><span class="line">  name: default</span><br><span class="line">current-context: default</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: cluster-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br></pre></td></tr></table></figure>



<h3 id="5-7-2-集群状态"><a href="#5-7-2-集群状态" class="headerlink" title="5.7.2 集群状态"></a>5.7.2 集群状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-8-命令补全"><a href="#5-8-命令补全" class="headerlink" title="5.8 命令补全"></a>5.8 命令补全</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install -y bash-completion</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>



<h1 id="6-网络插件"><a href="#6-网络插件" class="headerlink" title="6. 网络插件"></a>6. 网络插件</h1><p><strong>其中涉及的IP段，要与 kube-controller-manager中  “–cluster-cidr”  一致</strong></p>
<h2 id="6-1-CNI-Plugins"><a href="#6-1-CNI-Plugins" class="headerlink" title="6.1 CNI Plugins"></a>6.1 CNI Plugins</h2><p>所有节点都要操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install/network &amp;&amp; <span class="built_in">cd</span> <span class="variable">$_</span></span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/cni/bin</span><br><span class="line">tar zxvf cni-plugins-linux-amd64-v0.9.1.tgz -C /opt/cni/bin</span><br></pre></td></tr></table></figure>



<h2 id="6-2-calico"><a href="#6-2-calico" class="headerlink" title="6.2 calico"></a>6.2 calico</h2><p><code>Calico</code>是一个纯三层的数据中心网络方案，是目前Kubernetes主流的网络方案。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install/network &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install/network</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 下载插件</span></span><br><span class="line">wget https://docs.projectcalico.org/manifests/calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># CIDR的值，与 kube-controller-manager中“--cluster-cidr=10.244.0.0/16” 一致</span></span><br><span class="line">vi calico.yaml</span><br><span class="line">   3680             <span class="comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span></span><br><span class="line">   3681             <span class="comment"># chosen from this range. Changing this value after installation will have</span></span><br><span class="line">   3682             <span class="comment"># no effect. This should fall within `--cluster-cidr`.</span></span><br><span class="line">   3683             - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">   3684               value: <span class="string">&quot;10.244.0.0/16&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装网络插件</span></span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查是否启动</span></span><br><span class="line">kubectl get pod -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-7f4f5bf95d-tgklk   1/1     Running   0          2m7s</span><br><span class="line">calico-node-fwv5x                          1/1     Running   0          2m8s</span><br><span class="line">calico-node-ttt2c                          1/1     Running   0          2m8s</span><br><span class="line">calico-node-xjvjf                          1/1     Running   0          2m8s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 节点状态正常</span></span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    master   65m   v1.21.4</span><br><span class="line">k8s-node01    Ready    node     20m   v1.21.4</span><br><span class="line">k8s-node02    Ready    node     20m   v1.21.4</span><br></pre></td></tr></table></figure>




<h2 id="6-3-flannel"><a href="#6-3-flannel" class="headerlink" title="6.3 flannel"></a>6.3 flannel</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install/network &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install/network</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line"></span><br><span class="line">vi kube-flannel.yml</span><br><span class="line"> <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.244.0.0/16&quot;</span>,</span><br><span class="line"></span><br><span class="line">kubectl get pod -n kube-system</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-8qnnx   1/1     Running   0          10s</span><br><span class="line">kube-flannel-ds-979lc   1/1     Running   0          16m</span><br><span class="line">kube-flannel-ds-kgmgg   1/1     Running   0          16m</span><br><span class="line"></span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    master   85m   v1.21.4</span><br><span class="line">k8s-node01    Ready    node     40m   v1.21.4</span><br><span class="line">k8s-node02    Ready    node     40m   v1.21.4</span><br></pre></td></tr></table></figure>



<h2 id="6-4-ovs-cni"><a href="#6-4-ovs-cni" class="headerlink" title="6.4 ovs-cni"></a>6.4 ovs-cni</h2><h3 id="6-4-1-安装-open-vswitch"><a href="#6-4-1-安装-open-vswitch" class="headerlink" title="6.4.1 安装 open-vswitch"></a>6.4.1 安装 open-vswitch</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install openvswitch-switch</span><br></pre></td></tr></table></figure>



<h3 id="6-4-2-安装-multus"><a href="#6-4-2-安装-multus" class="headerlink" title="6.4.2 安装 multus"></a>6.4.2 安装 multus</h3><p>multus创建的crd资源network-attachment-definitions来定义ovs配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/images/multus-daemonset.yml</span><br><span class="line"></span><br><span class="line">kubectl apply -f multus-daemonset.yml</span><br></pre></td></tr></table></figure>



<h3 id="6-4-3-安装-ovs-cni"><a href="#6-4-3-安装-ovs-cni" class="headerlink" title="6.4.3 安装 ovs-cni"></a>6.4.3 安装 ovs-cni</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/k8snetworkplumbingwg/ovs-cni/blob/main/manifests/ovs-cni.yml.in</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参照配置</span></span><br><span class="line">cat &gt; ovs-cni.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: DaemonSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ovs-cni-amd64</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    tier: node</span></span><br><span class="line"><span class="string">    app: ovs-cni</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: ovs-cni</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        tier: node</span></span><br><span class="line"><span class="string">        app: ovs-cni</span></span><br><span class="line"><span class="string">      annotations:</span></span><br><span class="line"><span class="string">        description: OVS CNI allows users to attach their Pods/VMs to Open vSwitch bridges available on nodes</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      serviceAccountName: ovs-cni-marker</span></span><br><span class="line"><span class="string">      hostNetwork: true</span></span><br><span class="line"><span class="string">      nodeSelector:</span></span><br><span class="line"><span class="string">        beta.kubernetes.io/arch: amd64</span></span><br><span class="line"><span class="string">      tolerations:</span></span><br><span class="line"><span class="string">      - key: node-role.kubernetes.io/master</span></span><br><span class="line"><span class="string">        operator: Exists</span></span><br><span class="line"><span class="string">        effect: NoSchedule</span></span><br><span class="line"><span class="string">      initContainers:</span></span><br><span class="line"><span class="string">      - name: ovs-cni-plugin</span></span><br><span class="line"><span class="string">        image: quay.io/kubevirt/ovs-cni-plugin:latest</span></span><br><span class="line"><span class="string">        command: [&#x27;cp&#x27;, &#x27;/ovs&#x27;, &#x27;/host/opt/cni/bin/ovs&#x27;]</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        securityContext:</span></span><br><span class="line"><span class="string">          privileged: true</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">        - name: cnibin</span></span><br><span class="line"><span class="string">          mountPath: /host/opt/cni/bin</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: ovs-cni-marker</span></span><br><span class="line"><span class="string">        image: quay.io/kubevirt/ovs-cni-marker:latest</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        securityContext:</span></span><br><span class="line"><span class="string">          privileged: true</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">          - -node-name</span></span><br><span class="line"><span class="string">          - $(NODE_NAME)</span></span><br><span class="line"><span class="string">          - -ovs-socket</span></span><br><span class="line"><span class="string">          - /host/var/run/openvswitch/db.sock</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">          - name: ovs-var-run</span></span><br><span class="line"><span class="string">            mountPath: /host/var/run/openvswitch</span></span><br><span class="line"><span class="string">        env:</span></span><br><span class="line"><span class="string">          - name: NODE_NAME</span></span><br><span class="line"><span class="string">            valueFrom:</span></span><br><span class="line"><span class="string">              fieldRef:</span></span><br><span class="line"><span class="string">                fieldPath: spec.nodeName</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">        - name: cnibin</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /opt/cni/bin</span></span><br><span class="line"><span class="string">        - name: ovs-var-run</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /var/run/openvswitch</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">kind: ClusterRole</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ovs-cni-marker-cr</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">- apiGroups:</span></span><br><span class="line"><span class="string">  - &quot;&quot;</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">  - nodes</span></span><br><span class="line"><span class="string">  - nodes/status</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">  - update</span></span><br><span class="line"><span class="string">  - patch</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">kind: ClusterRoleBinding</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ovs-cni-marker-crb</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: ClusterRole</span></span><br><span class="line"><span class="string">  name: ovs-cni-marker-cr</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">- kind: ServiceAccount</span></span><br><span class="line"><span class="string">  name: ovs-cni-marker</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ovs-cni-marker</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装 ovs-cni</span></span><br><span class="line">kubectl apply -f ovs-cni.yaml</span><br></pre></td></tr></table></figure>



<h3 id="6-4-4-网桥"><a href="#6-4-4-网桥" class="headerlink" title="6.4.4 网桥"></a>6.4.4 网桥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建网桥</span></span><br><span class="line">ovs-vsctl add-br br1</span><br><span class="line">ovs-vsctl show</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看node是否使用了网桥</span></span><br><span class="line">kubectl describe node k8s-master</span><br><span class="line">...</span><br><span class="line">Capacity:</span><br><span class="line">  ovs-cni.network.kubevirt.io/br1:  1k     <span class="comment"># 默认写死 1k</span></span><br><span class="line">...</span><br><span class="line">Allocatable:</span><br><span class="line">  ovs-cni.network.kubevirt.io/br1:  1k     <span class="comment"># 默认写死 1k</span></span><br></pre></td></tr></table></figure>



<h3 id="6-4-5-网络扩展"><a href="#6-4-5-网络扩展" class="headerlink" title="6.4.5 网络扩展"></a>6.4.5 网络扩展</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ovs-ipam-net.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: &quot;k8s.cni.cncf.io/v1&quot;</span></span><br><span class="line"><span class="string">kind: NetworkAttachmentDefinition</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ovs-ipam-net</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    k8s.v1.cni.cncf.io/resourceName: ovs-cni.network.kubevirt.io/br1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  config: &#x27;&#123;</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;type&quot;: &quot;ovs&quot;,</span></span><br><span class="line"><span class="string">      &quot;bridge&quot;: &quot;br1&quot;,</span></span><br><span class="line"><span class="string">      &quot;vlan&quot;: 100,</span></span><br><span class="line"><span class="string">      &quot;ipam&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;static&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f ovs-ipam-net.yml</span><br></pre></td></tr></table></figure>



<h3 id="6-4-6-验证"><a href="#6-4-6-验证" class="headerlink" title="6.4.6 验证"></a>6.4.6 验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建pod</span></span><br><span class="line">cat &gt; ovs-test.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: samplepod-1</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    k8s.v1.cni.cncf.io/networks: &#x27;[</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;name&quot;: &quot;ovs-ipam-net&quot;,</span></span><br><span class="line"><span class="string">          &quot;ips&quot;: [&quot;10.10.10.1/24&quot;]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">]&#x27;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: pod-1</span></span><br><span class="line"><span class="string">    command: [&quot;sleep&quot;, &quot;99999&quot;]</span></span><br><span class="line"><span class="string">    image: alpine</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: samplepod-2</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    k8s.v1.cni.cncf.io/networks: &#x27;[</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;name&quot;: &quot;ovs-ipam-net&quot;,</span></span><br><span class="line"><span class="string">          &quot;ips&quot;: [&quot;10.10.10.2/24&quot;]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">]&#x27;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: pod-2</span></span><br><span class="line"><span class="string">    command: [&quot;sleep&quot;, &quot;99999&quot;]</span></span><br><span class="line"><span class="string">    image: alpine</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. zhic</span></span><br><span class="line">kubectl apply -f ovs-test.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 通信测试</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it samplepod-1 -- ping 10.10.10.2 -c 5</span><br><span class="line">PING 10.10.10.2 (10.10.10.2): 56 data bytes</span><br><span class="line">64 bytes from 10.10.10.2: seq=0 ttl=127 time=10.266 ms</span><br><span class="line">64 bytes from 10.10.10.2: seq=1 ttl=127 time=7.423 ms</span><br><span class="line">64 bytes from 10.10.10.2: seq=2 ttl=127 time=7.265 ms</span><br><span class="line">64 bytes from 10.10.10.2: seq=3 ttl=127 time=14.498 </span><br></pre></td></tr></table></figure>





<h1 id="7-Node-节点"><a href="#7-Node-节点" class="headerlink" title="7. Node 节点"></a>7. Node 节点</h1><p>Kubernetes node节点组件：</p>
<ul>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
<h2 id="6-1-克隆准备-master节点执行"><a href="#6-1-克隆准备-master节点执行" class="headerlink" title="6.1 克隆准备 (master节点执行)"></a>6.1 克隆准备 (master节点执行)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line"></span><br><span class="line">tar cvf worker-node-clone.tar /usr/bin/&#123;kubelet,kube-proxy&#125; /lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service /etc/kubernetes/kubelet* /etc/kubernetes/kube-proxy* /etc/kubernetes/pki /etc/kubernetes/bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">scp worker-node-clone.tar ubuntu@192.168.80.46:/home/ubuntu</span><br><span class="line">scp worker-node-clone.tar ubuntu@192.168.80.47:/home/ubuntu</span><br></pre></td></tr></table></figure>



<h2 id="6-2-克隆节点"><a href="#6-2-克隆节点" class="headerlink" title="6.2 克隆节点"></a>6.2 克隆节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> / &amp;&amp; mv /home/ubuntu/worker-node-clone.tar / &amp;&amp; tar xvf worker-node-clone.tar &amp;&amp; rm -f worker-node-clone.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除证书申请审批后自动生成的文件，后面重新生成</span></span><br><span class="line">rm -f /etc/kubernetes/kubelet.kubeconfig </span><br><span class="line">rm -f /etc/kubernetes/pki/kubelet*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志目录</span></span><br><span class="line">mkdir -p /var/<span class="built_in">log</span>/kubernetes</span><br></pre></td></tr></table></figure>



<h2 id="6-3-修改配置"><a href="#6-3-修改配置" class="headerlink" title="6.3 修改配置"></a>6.3 修改配置</h2><p>按实际节点名称修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubelet</span></span><br><span class="line">vi /lib/systemd/system/kubelet.service</span><br><span class="line">--hostname-override=k8s-node01</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-proxy</span></span><br><span class="line">vi /etc/kubernetes/kube-proxy-config.yml</span><br><span class="line">hostnameOverride: k8s-node01</span><br></pre></td></tr></table></figure>



<h2 id="6-4-开机启动"><a href="#6-4-开机启动" class="headerlink" title="6.4 开机启动"></a>6.4 开机启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet kube-proxy</span><br><span class="line">systemctl status kubelet kube-proxy</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet kube-proxy</span><br></pre></td></tr></table></figure>



<h2 id="6-5-加入集群-master节点执行"><a href="#6-5-加入集群-master节点执行" class="headerlink" title="6.5 加入集群 (master节点执行)"></a>6.5 加入集群 (master节点执行)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 节点信息</span></span><br><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-ghWG-AWFM9sxJbr5A-BIq9puVIRxfFHrQlwDjYbHba8   94m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-r2GF_8R3zuUe9BCf6eHeijWnzyPDDy-6WQUFOrOAQjA   34s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">node-csr-wvcKDHm38jQgjyaLiA_G2ycc2Qvmecf_iRRd9IqlSEw   97s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 批准加入</span></span><br><span class="line">kubectl certificate approve node-csr-r2GF_8R3zuUe9BCf6eHeijWnzyPDDy-6WQUFOrOAQjA </span><br><span class="line">kubectl certificate approve node-csr-wvcKDHm38jQgjyaLiA_G2ycc2Qvmecf_iRRd9IqlSEw</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 集群节点</span></span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-master1   NotReady   &lt;none&gt;   45m   v1.21.4</span><br><span class="line">k8s-node01    NotReady   &lt;none&gt;   6s    v1.21.4</span><br><span class="line">k8s-node02    NotReady   &lt;none&gt;   10s   v1.21.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 设置标签，即更改节点角色</span></span><br><span class="line">kubectl label node k8s-master1 node-role.kubernetes.io/master=</span><br><span class="line">kubectl label node k8s-node01 node-role.kubernetes.io/node=</span><br><span class="line">kubectl label node k8s-node02 node-role.kubernetes.io/node=</span><br><span class="line"></span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS     ROLES    AGE     VERSION</span><br><span class="line">k8s-master1   NotReady   master   49m     v1.21.4</span><br><span class="line">k8s-node01    NotReady   node     3m45s   v1.21.4</span><br><span class="line">k8s-node02    NotReady   node     3m49s   v1.21.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 设置污点：是master节点无法创建pod</span></span><br><span class="line">kubectl taint nodes k8s-master1 node-role.kubernetes.io/master=:NoSchedule</span><br><span class="line"></span><br><span class="line">kubectl describe node k8s-master1</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">                    node.kubernetes.io/not-ready:NoSchedule</span><br></pre></td></tr></table></figure>





<h1 id="8-Addons"><a href="#8-Addons" class="headerlink" title="8. Addons"></a>8. Addons</h1><h2 id="8-1-CoreDNS"><a href="#8-1-CoreDNS" class="headerlink" title="8.1 CoreDNS"></a>8.1 CoreDNS</h2><p>CoreDNS用于集群内部Service名称解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install/coredns &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install/coredns</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed</span><br><span class="line">wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/deploy.sh</span><br><span class="line"></span><br><span class="line">chmod +x deploy.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> CLUSTER_DNS_SVC_IP=<span class="string">&quot;10.96.0.2&quot;</span></span><br><span class="line"><span class="built_in">export</span> CLUSTER_DNS_DOMAIN=<span class="string">&quot;cluster.local&quot;</span></span><br><span class="line"></span><br><span class="line">./deploy.sh -i <span class="variable">$&#123;CLUSTER_DNS_SVC_IP&#125;</span> -d <span class="variable">$&#123;CLUSTER_DNS_DOMAIN&#125;</span> | kubectl apply -f -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询状态</span></span><br><span class="line">kubectl get pods -n kube-system | grep coredns</span><br><span class="line">coredns-746fcb4bc5-nts2k                   1/1     Running   0          6m2s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证 busybox1.33.1有问题</span></span><br><span class="line">kubectl run -it --rm dns-test --image=busybox:1.28.4 /bin/sh</span><br><span class="line">If you don<span class="string">&#x27;t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/ # nslookup kubernetes</span></span><br><span class="line"><span class="string">Server:         10.96.0.2</span></span><br><span class="line"><span class="string">Address:        10.96.0.2:53</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Name:   kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="string">Address: 10.0.0.1</span></span><br></pre></td></tr></table></figure>



<p>DNS问题排查：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dns service</span></span><br><span class="line">kubectl get svc -n kube-system</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.2   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   13m</span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoints 是否正常</span></span><br><span class="line">kubectl get endpoints kube-dns -n kube-system</span><br><span class="line">NAME       ENDPOINTS                                        AGE</span><br><span class="line">kube-dns   10.244.85.194:53,10.244.85.194:53,10.244.85.194:9153   13m</span><br><span class="line"></span><br><span class="line"><span class="comment"># coredns 增加解析日志</span></span><br><span class="line">CoreDNS 配置参数说明：</span><br><span class="line">errors: 输出错误信息到控制台。</span><br><span class="line">health：CoreDNS 进行监控检测，检测地址为 http://localhost:8080/health 如果状态为不健康则让 Pod 进行重启。</span><br><span class="line">ready: 全部插件已经加载完成时，将通过 endpoints 在 8081 端口返回 HTTP 状态 200。</span><br><span class="line">kubernetes：CoreDNS 将根据 Kubernetes 服务和 pod 的 IP 回复 DNS 查询。</span><br><span class="line">prometheus：是否开启 CoreDNS Metrics 信息接口，如果配置则开启，接口地址为 http://localhost:9153/metrics</span><br><span class="line">forward：任何不在Kubernetes 集群内的域名查询将被转发到预定义的解析器 (/etc/resolv.conf)。</span><br><span class="line">cache：启用缓存，30 秒 TTL。</span><br><span class="line">loop：检测简单的转发循环，如果找到循环则停止 CoreDNS 进程。</span><br><span class="line">reload：监听 CoreDNS 配置，如果配置发生变化则重新加载配置。</span><br><span class="line">loadbalance：DNS 负载均衡器，默认 round_robin。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 coredns 配置</span></span><br><span class="line">kubectl edit configmap coredns -n kube-system</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        <span class="built_in">log</span>     <span class="comment"># new add</span></span><br><span class="line">        errors</span><br><span class="line">        health &#123;</span><br><span class="line">          lameduck 5s</span><br><span class="line">        &#125;</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">          fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        forward . /etc/resolv.conf &#123;</span><br><span class="line">          max_concurrent 1000</span><br><span class="line">        &#125;</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">      &#123;<span class="string">&quot;apiVersion&quot;</span>:<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;data&quot;</span>:&#123;<span class="string">&quot;Corefile&quot;</span>:<span class="string">&quot;.:53 &#123;\n    errors\n    health &#123;\n      lameduck 5s\n    &#125;\n    ready\n    kubernetes cluster.local in-addr.arpa ip6.arpa &#123;\n      fallthrough in-addr.arpa ip6.arpa\n    &#125;\n    prometheus :9153\n    forward . /etc/resolv.conf &#123;\n      max_concurrent 1000\n    &#125;\n    cache 30\n    loop\n    reload\n    loadbalance\n&#125;\n&quot;</span>&#125;,<span class="string">&quot;kind&quot;</span>:<span class="string">&quot;ConfigMap&quot;</span>,<span class="string">&quot;metadata&quot;</span>:&#123;<span class="string">&quot;annotations&quot;</span>:&#123;&#125;,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;coredns&quot;</span>,<span class="string">&quot;namespace&quot;</span>:<span class="string">&quot;kube-system&quot;</span>&#125;&#125;</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2021-05-13T11:57:45Z&quot;</span></span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">&quot;38460&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns</span><br><span class="line">  uid: c62a856d-1fc3-4fe9-b5f1-3ca0dbeb39c1</span><br></pre></td></tr></table></figure>



<p>回滚操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/rollback.sh</span><br><span class="line">chmod +x rollback.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> CLUSTER_DNS_SVC_IP=<span class="string">&quot;10.96.0.2&quot;</span></span><br><span class="line"><span class="built_in">export</span> CLUSTER_DNS_DOMAIN=<span class="string">&quot;cluster.local&quot;</span></span><br><span class="line"></span><br><span class="line">./rollback.sh -i <span class="variable">$&#123;CLUSTER_DNS_SVC_IP&#125;</span> -d <span class="variable">$&#123;CLUSTER_DNS_DOMAIN&#125;</span> | kubectl apply -f -</span><br><span class="line"></span><br><span class="line">kubectl delete --namespace=kube-system deployment coredns</span><br></pre></td></tr></table></figure>





<h2 id="8-2-Dashboard"><a href="#8-2-Dashboard" class="headerlink" title="8.2 Dashboard"></a>8.2 Dashboard</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install/dashboard &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install/dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 下载并安装</span></span><br><span class="line">curl https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml -o dashboard.yaml</span><br><span class="line"></span><br><span class="line">kubectl apply -f dashboard.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查运行状态</span></span><br><span class="line">kubectl get pods -n kubernetes-dashboard -o wide</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE    IP           NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">dashboard-metrics-scraper-79c5968bdc-xkm78   1/1     Running   0          23m   10.244.159.129   k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-9f9799597-d8g8t         1/1     Running   0          23m   10.244.58.193    k8s-node02    &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查服务状态</span></span><br><span class="line">kubectl get svc -n kubernetes-dashboard -o wide</span><br><span class="line">NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE    SELECTOR</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.96.14.1      &lt;none&gt;        8000/TCP   24m   k8s-app=dashboard-metrics-scraper</span><br><span class="line">kubernetes-dashboard        ClusterIP   10.96.219.125   &lt;none&gt;        443/TCP    24m   k8s-app=kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 服务改为NodePort方式</span></span><br><span class="line">kubectl edit svc kubernetes-dashboard  -n  kubernetes-dashboard</span><br><span class="line"><span class="built_in">type</span>: ClusterIP =&gt; <span class="built_in">type</span>: NodePort</span><br><span class="line"> </span><br><span class="line">kubectl get svc -n kubernetes-dashboard -o wide</span><br><span class="line">NAME                        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE     SELECTOR</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.96.14.1      &lt;none&gt;        8000/TCP        3h30m   k8s-app=dashboard-metrics-scraper</span><br><span class="line">kubernetes-dashboard        NodePort    10.96.219.125   &lt;none&gt;        443:31639/TCP   3h30m   k8s-app=kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 创建service account并绑定默认cluster-admin管理员集群角色：</span></span><br><span class="line">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 获取访问 token</span></span><br><span class="line">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk <span class="string">&#x27;/dashboard-admin/&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">Name:         dashboard-admin-token-xwd72</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid: 013e9f84-827f-4dc7-81b3-874a28bfebc6</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1310 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6InNQRElCQTlPRUZ5SU54STQ1QWllLXlKMTFCcmZieG0wVTJnRlpzYlBNLXcifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teHdkNzIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMDEzZTlmODQtODI3Zi00ZGM3LTgxYjMtODc0YTI4YmZlYmM2Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.O-DI-0IlLFP2pDRKzQYJrZeDAnVvW1IjU-iVwGzvwID7BH0v6kXfWnti07qm8VkuGFJtpuQsmrf6v4sUeRDhr95kZlEVV8Rxnes6oixrkXdk3fR4xreh4lh6ZgCzbER6xI8pMG-j9KNjTRdY6gQPJuOThtI9ab13dpTT5AYpggA2O98DFfgcJ_DzD05hhk6TghOdoro00msHRSUrsEiH0CYa_3PiyPlkvmmY3MlJPsBTdO2pCDzcrjQ2L5EaJAvSh6OodkRY6ymOwfcbfPs3WwSocCEfwkogYOCAQhMC4NU3Jea_hoeFqzLdS1PK5R2rPT-wqemwjDKn0E6jUv6juw</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 访问</span></span><br><span class="line">https://192.168.80.45:31639</span><br></pre></td></tr></table></figure>



<h1 id="9-高可用"><a href="#9-高可用" class="headerlink" title="9. 高可用"></a>9. 高可用</h1><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>组件</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master1</td>
<td>192.168.80.45</td>
<td>etcd, api-server, controller-manager, scheduler, kubelet, kube-proxy, docker</td>
<td></td>
</tr>
<tr>
<td>k8s-node01</td>
<td>192.168.80.46</td>
<td>etcd, kubelet, kube-proxy, docker</td>
<td></td>
</tr>
<tr>
<td>k8s-node02</td>
<td>192.168.80.47</td>
<td>etcd, kubelet, kube-proxy, docker</td>
<td></td>
</tr>
<tr>
<td>k8s-master2</td>
<td>192.168.80.49</td>
<td>etcd, api-server, controller-manager, scheduler, kubelet, kube-proxy, docker</td>
<td>新增节点</td>
</tr>
</tbody></table>
<h2 id="9-1-准备操作-Master-1"><a href="#9-1-准备操作-Master-1" class="headerlink" title="9.1 准备操作 (Master-1)"></a>9.1 准备操作 (Master-1)</h2><h3 id="9-1-1-kube-apiserver-证书更新"><a href="#9-1-1-kube-apiserver-证书更新" class="headerlink" title="9.1.1 kube-apiserver 证书更新"></a>9.1.1 kube-apiserver 证书更新</h3><p>在新增节点的IP段未在证书中时需要如下操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/ssl &amp;&amp; <span class="built_in">cd</span> /root/ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 证书签名请求文件</span></span><br><span class="line">cat &gt; apiserver-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class="line"><span class="string">    &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">      &quot;127.0.0.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;localhost&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.2&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.3&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.45&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.46&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.47&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.48&quot;,</span></span><br><span class="line"><span class="string">      &quot;192.168.80.49&quot;,</span></span><br><span class="line"><span class="string">      &quot;10.96.0.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default.svc&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default.svc.cluster&quot;,</span></span><br><span class="line"><span class="string">      &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">            &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class="line"><span class="string">            &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class="line"><span class="string">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes apiserver-csr.json | cfssljson -bare apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 证书更新</span></span><br><span class="line">cp apiserver*.pem /etc/kubernetes/pki</span><br><span class="line">scp apiserver*.pem ubuntu@192.168.80.46:/home/ubuntu</span><br><span class="line">scp apiserver*.pem ubuntu@192.168.80.47:/home/ubuntu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. node节点证书更新</span></span><br><span class="line">chown root:root /home/ubuntu/apiserver*.pem </span><br><span class="line">mv /home/ubuntu/apiserver*.pem /etc/kubernetes/pki</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 重启 apiserver</span></span><br><span class="line">systemctl restart kube-apiserver</span><br><span class="line">systemctl status kube-apiserver</span><br></pre></td></tr></table></figure>



<h3 id="9-1-2-增加主机"><a href="#9-1-2-增加主机" class="headerlink" title="9.1.2 增加主机"></a>9.1.2 增加主机</h3><p>在 k8s-master1, k8s-node01, k8s-node02 上制作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;192.168.80.49  k8s-master2&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>



<h2 id="9-2-扩容-Master"><a href="#9-2-扩容-Master" class="headerlink" title="9.2 扩容 Master"></a>9.2 扩容 Master</h2><h3 id="9-2-1-初始化"><a href="#9-2-1-初始化" class="headerlink" title="9.2.1 初始化"></a>9.2.1 初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 修改主机名</span></span><br><span class="line">hostnamectl set-hostname k8s-master2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 主机名解析</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.80.45  k8s-master1</span></span><br><span class="line"><span class="string">192.168.80.46  k8s-node01</span></span><br><span class="line"><span class="string">192.168.80.47  k8s-node02</span></span><br><span class="line"><span class="string">192.168.80.49  k8s-master2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 禁用 swap</span></span><br><span class="line">swapoff -a &amp;&amp; sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 将桥接的IPv4流量传递到iptables的链 </span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF </span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1 </span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1 </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system </span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 域名解析</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt;&gt; /etc/resolv.conf</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 6. 时间同步 </span></span><br><span class="line">apt install ntpdate -y </span><br><span class="line">ntpdate ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line">crontab -e</span><br><span class="line">*/30 * * * * /usr/sbin/ntpdate-u ntp1.aliyun.com &gt;&gt; /var/<span class="built_in">log</span>/ntpdate.log 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 日志目录</span></span><br><span class="line">mkdir -p /var/<span class="built_in">log</span>/kubernetes</span><br></pre></td></tr></table></figure>



<h3 id="9-2-2-克隆"><a href="#9-2-2-克隆" class="headerlink" title="9.2.2 克隆"></a>9.2.2 克隆</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. k8s-master1 上执行</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/k8s-install &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/k8s-install</span><br><span class="line">tar zcvf master-node-clone.tar.gz /usr/bin/kube* /lib/systemd/system/kube*.service /etc/kubernetes /root/.kube/config /usr/bin/docker* /usr/bin/runc /usr/bin/containerd* /usr/bin/ctr /etc/docker /lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">scp master-node-clone.tar.gz ubuntu@192.168.80.49:/home/ubuntu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. k8s-master2 执行</span></span><br><span class="line"><span class="built_in">cd</span> / &amp;&amp; mv /home/ubuntu/master-node-clone.tar.gz / &amp;&amp; tar zxvf master-node-clone.tar.gz &amp;&amp; rm -f master-node-clone.tar.gz</span><br><span class="line"></span><br><span class="line">rm -f /etc/kubernetes/kubelet.kubeconfig </span><br><span class="line">rm -f /etc/kubernetes/pki/kubelet*</span><br></pre></td></tr></table></figure>



<h3 id="9-2-3-更新配置"><a href="#9-2-3-更新配置" class="headerlink" title="9.2.3 更新配置"></a>9.2.3 更新配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/kubernetes/kube-apiserver.conf </span><br><span class="line">--bind-address=192.168.80.49 \</span><br><span class="line">--advertise-address=192.168.80.49 \</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;s#k8s-master1#k8s-master2#&#x27;</span> /etc/kubernetes/*</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;s#192.168.80.45:6443#192.168.80.49:6443#&#x27;</span> /etc/kubernetes/*</span><br><span class="line"></span><br><span class="line">vi /root/.kube/config</span><br><span class="line">server: https://192.168.80.49:6443</span><br></pre></td></tr></table></figure>



<h3 id="9-2-4-开机启动"><a href="#9-2-4-开机启动" class="headerlink" title="9.2.4 开机启动"></a>9.2.4 开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker kube-apiserver kube-controller-manager kube-scheduler kubelet kube-proxy</span><br><span class="line">systemctl status docker kube-apiserver kube-controller-manager kube-scheduler kubelet kube-proxy</span><br><span class="line">systemctl <span class="built_in">enable</span> docker kube-apiserver kube-controller-manager kube-scheduler kubelet kube-proxy</span><br></pre></td></tr></table></figure>



<h3 id="9-2-5-集群状态"><a href="#9-2-5-集群状态" class="headerlink" title="9.2.5 集群状态"></a>9.2.5 集群状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br></pre></td></tr></table></figure>



<h3 id="9-2-6-加入集群"><a href="#9-2-6-加入集群" class="headerlink" title="9.2.6 加入集群"></a>9.2.6 加入集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-HfzAqSEc7sIIG9QFHip4vGFnFZhyZnYjBVGWQyGpz54   7m49s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批准加入</span></span><br><span class="line">kubectl certificate approve node-csr-HfzAqSEc7sIIG9QFHip4vGFnFZhyZnYjBVGWQyGpz54</span><br><span class="line"></span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE     VERSION</span><br><span class="line">NAME          STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready      master   27h   v1.21.4</span><br><span class="line">k8s-master2   NotReady   &lt;none&gt;   11s   v1.21.4</span><br><span class="line">k8s-node01    Ready      node     27h   v1.21.4</span><br><span class="line">k8s-node02    Ready      node     27h   v1.21.4</span><br></pre></td></tr></table></figure>



<h3 id="9-2-7-打标和污点"><a href="#9-2-7-打标和污点" class="headerlink" title="9.2.7 打标和污点"></a>9.2.7 打标和污点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置标签</span></span><br><span class="line">kubectl label node k8s-master2 node-role.kubernetes.io/master=</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置污点：是master节点无法创建pod</span></span><br><span class="line">kubectl taint nodes k8s-master2 node-role.kubernetes.io/master=:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点信息</span></span><br><span class="line">kubectl get nodes --show-labels</span><br><span class="line">NAME          STATUS   ROLES    AGE     VERSION    LABELS</span><br><span class="line">k8s-master1   Ready    master   27h     v1.21.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master1,kubernetes.io/os=linux,node-role.kubernetes.io/master=</span><br><span class="line">k8s-master2   Ready    master   2m13s   v1.21.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master2,kubernetes.io/os=linux,node-role.kubernetes.io/master=</span><br><span class="line">k8s-node01    Ready    node     27h     v1.21.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux,node-role.kubernetes.io/node=</span><br><span class="line">k8s-node02    Ready    node     27h     v1.21.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node02,kubernetes.io/os=linux,node-role.kubernetes.io/node=</span><br></pre></td></tr></table></figure>



<h2 id="9-3-高可用负载均衡"><a href="#9-3-高可用负载均衡" class="headerlink" title="9.3 高可用负载均衡"></a>9.3 高可用负载均衡</h2><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-apiserver-keepalived.png" alt="img"> </p>
<p><code>Nginx</code>: 主流Web服务和反向代理服务器，这里用四层实现对apiserver实现负载均衡。</p>
<p><code>Keepalived</code>: 主流高可用软件，基于VIP绑定实现服务器双机热备。Keepalived主要根据Nginx运行状态判断是否需要故障转移（漂移VIP），例如当Nginx主节点挂掉，VIP会自动绑定在Nginx备节点，从而保证VIP一直可用，实现Nginx高可用。</p>
<p>服务器规划：</p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>IP</strong></th>
<th>组件</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master1</td>
<td>192.168.80.45</td>
<td>kube-apiserver</td>
</tr>
<tr>
<td>k8s-master2</td>
<td>192.168.80.49</td>
<td>kube-apiserver</td>
</tr>
<tr>
<td>k8s-loadbalancer1</td>
<td>192.168.80.2</td>
<td>nginx, keepalived</td>
</tr>
<tr>
<td>k8s-loadbalancer2</td>
<td>192.168.80.3</td>
<td>nginx, keepalived</td>
</tr>
<tr>
<td>VIP</td>
<td>192.168.80.1</td>
<td>虚拟IP</td>
</tr>
</tbody></table>
<h3 id="9-3-1-安装软件"><a href="#9-3-1-安装软件" class="headerlink" title="9.3.1 安装软件"></a>9.3.1 安装软件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install nginx keepalived -y</span><br></pre></td></tr></table></figure>



<h3 id="9-3-2-配置Nginx"><a href="#9-3-2-配置Nginx" class="headerlink" title="9.3.2 配置Nginx"></a>9.3.2 配置Nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/nginx.conf &lt;&lt; <span class="string">&quot;EOF&quot;</span></span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/<span class="built_in">log</span>/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/k8s-access.log  main;</span><br><span class="line"></span><br><span class="line">    upstream k8s-apiserver &#123;</span><br><span class="line">       server 192.168.80.45:6443;   <span class="comment"># Master1 APISERVER IP:PORT</span></span><br><span class="line">       server 192.168.80.49:6443;   <span class="comment"># Master2 APISERVER IP:PORT</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">       listen 16443; </span><br><span class="line">       proxy_pass k8s-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="9-3-3-keepalived-配置-master"><a href="#9-3-3-keepalived-配置-master" class="headerlink" title="9.3.3 keepalived 配置 (master)"></a>9.3.3 keepalived 配置 (master)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">global_defs &#123; </span></span><br><span class="line"><span class="string">   notification_email &#123; </span></span><br><span class="line"><span class="string">     acassen@firewall.loc </span></span><br><span class="line"><span class="string">     failover@firewall.loc </span></span><br><span class="line"><span class="string">     sysadmin@firewall.loc </span></span><br><span class="line"><span class="string">   &#125; </span></span><br><span class="line"><span class="string">   notification_email_from Alexandre.Cassen@firewall.loc  </span></span><br><span class="line"><span class="string">   smtp_server 127.0.0.1 </span></span><br><span class="line"><span class="string">   smtp_connect_timeout 30 </span></span><br><span class="line"><span class="string">   router_id NGINX_MASTER</span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 检查脚本</span></span><br><span class="line"><span class="string">vrrp_script check_nginx &#123;</span></span><br><span class="line"><span class="string">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_instance VI_1 &#123; </span></span><br><span class="line"><span class="string">    state MASTER </span></span><br><span class="line"><span class="string">    interface ens33 # 修改为实际网卡名</span></span><br><span class="line"><span class="string">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class="line"><span class="string">    priority 100    # 优先级，备服务器设置 90 </span></span><br><span class="line"><span class="string">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span><br><span class="line"><span class="string">    authentication &#123; </span></span><br><span class="line"><span class="string">        auth_type PASS      </span></span><br><span class="line"><span class="string">        auth_pass 1111 </span></span><br><span class="line"><span class="string">    &#125;  </span></span><br><span class="line"><span class="string">    # 虚拟IP</span></span><br><span class="line"><span class="string">    virtual_ipaddress &#123; </span></span><br><span class="line"><span class="string">        192.168.80.1/24</span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    track_script &#123;</span></span><br><span class="line"><span class="string">        check_nginx</span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<h3 id="9-3-4-keepalived-配置-slave"><a href="#9-3-4-keepalived-配置-slave" class="headerlink" title="9.3.4 keepalived 配置 (slave)"></a>9.3.4 keepalived 配置 (slave)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">global_defs &#123; </span></span><br><span class="line"><span class="string">   notification_email &#123; </span></span><br><span class="line"><span class="string">     acassen@firewall.loc </span></span><br><span class="line"><span class="string">     failover@firewall.loc </span></span><br><span class="line"><span class="string">     sysadmin@firewall.loc </span></span><br><span class="line"><span class="string">   &#125; </span></span><br><span class="line"><span class="string">   notification_email_from Alexandre.Cassen@firewall.loc  </span></span><br><span class="line"><span class="string">   smtp_server 127.0.0.1 </span></span><br><span class="line"><span class="string">   smtp_connect_timeout 30 </span></span><br><span class="line"><span class="string">   router_id NGINX_BACKUP</span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 检查脚本</span></span><br><span class="line"><span class="string">vrrp_script check_nginx &#123;</span></span><br><span class="line"><span class="string">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_instance VI_1 &#123; </span></span><br><span class="line"><span class="string">    state BACKUP </span></span><br><span class="line"><span class="string">    interface ens33 # 修改为实际网卡名</span></span><br><span class="line"><span class="string">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class="line"><span class="string">    priority 90     # 优先级，备服务器设置 90 </span></span><br><span class="line"><span class="string">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span><br><span class="line"><span class="string">    authentication &#123; </span></span><br><span class="line"><span class="string">        auth_type PASS      </span></span><br><span class="line"><span class="string">        auth_pass 1111 </span></span><br><span class="line"><span class="string">    &#125;  </span></span><br><span class="line"><span class="string">    # 虚拟IP</span></span><br><span class="line"><span class="string">    virtual_ipaddress &#123; </span></span><br><span class="line"><span class="string">        192.168.80.1/24</span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    track_script &#123;</span></span><br><span class="line"><span class="string">        check_nginx</span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<h3 id="9-3-5-keepalived-检查脚本"><a href="#9-3-5-keepalived-检查脚本" class="headerlink" title="9.3.5 keepalived 检查脚本"></a>9.3.5 keepalived 检查脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/check_nginx.sh  &lt;&lt; <span class="string">&quot;EOF&quot;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">count=$(ss -antp |grep 16443 |egrep -cv <span class="string">&quot;grep|$$&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$count</span>&quot;</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure>



<h3 id="9-3-6-启动服务"><a href="#9-3-6-启动服务" class="headerlink" title="9.3.6 启动服务"></a>9.3.6 启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start nginx keepalived</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx keepalived</span><br></pre></td></tr></table></figure>



<h3 id="9-3-7-状态检查"><a href="#9-3-7-状态检查" class="headerlink" title="9.3.7 状态检查"></a>9.3.7 状态检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ip addr</span><br><span class="line"></span><br><span class="line">curl -k https://192.168.80.1:16443/version</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;major&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;minor&quot;</span>: <span class="string">&quot;19&quot;</span>,</span><br><span class="line">  <span class="string">&quot;gitVersion&quot;</span>: <span class="string">&quot;v1.21.4&quot;</span>,</span><br><span class="line">  <span class="string">&quot;gitCommit&quot;</span>: <span class="string">&quot;c6a2f08fc4378c5381dd948d9ad9d1080e3e6b33&quot;</span>,</span><br><span class="line">  <span class="string">&quot;gitTreeState&quot;</span>: <span class="string">&quot;clean&quot;</span>,</span><br><span class="line">  <span class="string">&quot;buildDate&quot;</span>: <span class="string">&quot;2021-05-12T12:19:22Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;goVersion&quot;</span>: <span class="string">&quot;go1.15.12&quot;</span>,</span><br><span class="line">  <span class="string">&quot;compiler&quot;</span>: <span class="string">&quot;gc&quot;</span>,</span><br><span class="line">  <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;linux/amd64&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="9-3-8-Worker-Node-连接到-LB-VIP"><a href="#9-3-8-Worker-Node-连接到-LB-VIP" class="headerlink" title="9.3.8 Worker Node 连接到 LB VIP"></a>9.3.8 Worker Node 连接到 LB VIP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s#192.168.80.45:6443#192.168.80.1:16443#&#x27;</span> /etc/kubernetes/*</span><br><span class="line">systemctl restart kubelet kube-proxy</span><br><span class="line"></span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-master1   Ready    master   3d17h   v1.21.4</span><br><span class="line">k8s-master2   Ready    master   2d16h   v1.21.4</span><br><span class="line">k8s-node01    Ready    node     3d15h   v1.21.4</span><br><span class="line">k8s-node02    Ready    node     3d15h   v1.21.4</span><br></pre></td></tr></table></figure>



<h1 id="10-删除节点"><a href="#10-删除节点" class="headerlink" title="10. 删除节点"></a>10. 删除节点</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. k8s-master2 上，停止kubelet进程</span></span><br><span class="line">systemctl stop kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查 k8s-master2 是否已下线</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME          STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready      master   40h   v1.21.4</span><br><span class="line">k8s-master2   NotReady   master   12h   v1.21.4</span><br><span class="line">k8s-node01    Ready      node     40h   v1.21.4</span><br><span class="line">k8s-node02    Ready      node     40h   v1.21.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除节点</span></span><br><span class="line">kubectl drain k8s-master2</span><br><span class="line">node/k8s-master2 cordoned</span><br><span class="line">error: unable to drain node <span class="string">&quot;k8s-master2&quot;</span>, aborting <span class="built_in">command</span>...</span><br><span class="line"></span><br><span class="line">There are pending nodes to be drained:</span><br><span class="line"> k8s-master2</span><br><span class="line">error: cannot delete DaemonSet-managed Pods (use --ignore-daemonsets to ignore): kube-system/calico-node-lwj2r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 强制下线</span></span><br><span class="line">kubectl drain k8s-master2 --ignore-daemonsets</span><br><span class="line">node/k8s-master2 already cordoned</span><br><span class="line">WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-lwj2r</span><br><span class="line">node/k8s-master2 drained</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 下线状态</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME          STATUS                     ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready                      master   40h   v1.21.4</span><br><span class="line">k8s-master2   Ready,SchedulingDisabled   master   12h   v1.21.4</span><br><span class="line">k8s-node01    Ready                      node     39h   v1.21.4</span><br><span class="line">k8s-node02    Ready                      node     39h   v1.21.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 恢复操作 (如有必要)</span></span><br><span class="line">kubectl uncordon k8s-master2</span><br><span class="line">node/k8s-master2 uncordoned</span><br><span class="line"></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    master   40h   v1.21.4</span><br><span class="line">k8s-master2   Ready    master   12h   v1.21.4</span><br><span class="line">k8s-node01    Ready    node     39h   v1.21.4</span><br><span class="line">k8s-node02    Ready    node     39h   v1.21.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 彻底删除</span></span><br><span class="line">kubectl delete node k8s-master2 </span><br><span class="line"></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    master   41h   v1.21.4</span><br><span class="line">k8s-node01    Ready    node     40h   v1.21.4</span><br><span class="line">k8s-node02    Ready    node     40h   v1.21.4</span><br></pre></td></tr></table></figure>



<h1 id="Z-补充"><a href="#Z-补充" class="headerlink" title="Z. 补充"></a>Z. 补充</h1><h2 id="组件日志级别"><a href="#组件日志级别" class="headerlink" title="组件日志级别"></a>组件日志级别</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--v=0	Generally useful for this to ALWAYS be visible to an operator.</span><br><span class="line">--v=1	A reasonable default log level if you don’t want verbosity.</span><br><span class="line">--v=2	Useful steady state information about the service and important log messages that may correlate to significant changes in the system. This is the recommended default log level for most systems.</span><br><span class="line">--v=3	Extended information about changes.</span><br><span class="line">--v=4	Debug level verbosity.</span><br><span class="line">--v=6	Display requested resources.</span><br><span class="line">--v=7	Display HTTP request headers.</span><br><span class="line">--v=8	Display HTTP request contents</span><br></pre></td></tr></table></figure>


      </div>
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-10-09T19:02:01+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>更新于 2021年10月9日</p>
  </a>
</div>

        
      
        
          

        
      
        
          

        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                          <h4>
                              <a href="/2021/07/13/Kubernetes%20%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/" rel="prev" title="Kubernetes 核心组件">
                                
                                    Kubernetes 核心组件
                                
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2021/05/31/Kubernetes%20%E9%9B%86%E7%BE%A4kubeadm%E5%AE%89%E8%A3%85/" rel="prev" title="Kubernetes 集群kubeadmin安装">
                                  
                                      Kubernetes 集群kubeadmin安装
                                  
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Kubernetes 集群二进制安装',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
      
        
          
          
            
              <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:eli.he@outlook.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/elihe2011"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=282243842"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">1. 环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%AE%89%E8%A3%85%E8%A7%84%E5%88%92"><span class="toc-text">1.1 安装规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE"><span class="toc-text">1.2 系统设置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85-docker"><span class="toc-text">2. 安装 docker</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-TLS-%E8%AF%81%E4%B9%A6"><span class="toc-text">3. TLS 证书</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%AF%81%E4%B9%A6%E5%B7%A5%E5%85%B7"><span class="toc-text">3.1 证书工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E8%AF%81%E4%B9%A6%E5%BD%92%E7%B1%BB"><span class="toc-text">3.2 证书归类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-CA-%E8%AF%81%E4%B9%A6"><span class="toc-text">3.3 CA 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-etcd-%E8%AF%81%E4%B9%A6"><span class="toc-text">3.4 etcd 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-kube-apiserver-%E8%AF%81%E4%B9%A6"><span class="toc-text">3.5 kube-apiserver 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-kube-controller-manager-%E8%AF%81%E4%B9%A6"><span class="toc-text">3.6 kube-controller-manager 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-kube-scheduler-%E8%AF%81%E4%B9%A6"><span class="toc-text">3.8 kube-scheduler 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-admin-%E8%AF%81%E4%B9%A6"><span class="toc-text">3.9 admin 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10-kube-proxy-%E8%AF%81%E4%B9%A6"><span class="toc-text">3.10 kube-proxy 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-11-%E8%AF%81%E4%B9%A6%E4%BF%A1%E6%81%AF"><span class="toc-text">3.11 证书信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-12-%E5%88%86%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="toc-text">3.12 分发证书</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%AE%89%E8%A3%85-etcd-%E5%A4%9A%E8%8A%82%E7%82%B9"><span class="toc-text">4. 安装 etcd  (多节点)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%8A%82%E7%82%B9-etcd-1"><span class="toc-text">4.1 节点 etcd-1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9"><span class="toc-text">4.2 其他节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%90%AF%E5%8A%A8"><span class="toc-text">4.3 启动</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%AE%89%E8%A3%85-etcd-%E5%8D%95%E8%8A%82%E7%82%B9"><span class="toc-text">4. 安装 etcd  (单节点)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%8A%82%E7%82%B9-etcd-1-1"><span class="toc-text">4.1 节点 etcd-1</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Master-%E8%8A%82%E7%82%B9"><span class="toc-text">5. Master 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87"><span class="toc-text">5.1 安装准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-apiserver"><span class="toc-text">5.2 apiserver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-TLS-Bootstrapping-Token"><span class="toc-text">5.2.1 TLS Bootstrapping Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-text">5.2.2 开机启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-kubectl-%E7%AE%A1%E7%90%86%E9%9B%86%E7%BE%A4"><span class="toc-text">5.2.3 kubectl 管理集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-4-%E6%8E%88%E6%9D%83-kubelet-bootstrap-%E7%94%A8%E6%88%B7%E5%85%81%E8%AE%B8%E8%AF%B7%E6%B1%82%E8%AF%81%E4%B9%A6"><span class="toc-text">5.2.4 授权 kubelet-bootstrap 用户允许请求证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-5-%E6%8E%88%E6%9D%83-apiserver-%E8%AE%BF%E9%97%AE-kubelet"><span class="toc-text">5.2.5 授权 apiserver 访问 kubelet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-controller-manager"><span class="toc-text">5.3 controller-manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-kubeconfig"><span class="toc-text">5.3.1 kubeconfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-text">5.3.2 开机启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-scheduler"><span class="toc-text">5.4 scheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-kubeconfig"><span class="toc-text">5.4.1 kubeconfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-text">5.4.2 开机启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-kubelet"><span class="toc-text">5.5 kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">5.5.1 参数配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2-kubeconfig"><span class="toc-text">5.5.2 kubeconfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-3-%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-text">5.5.3 开机启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-4-%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-text">5.5.4 加入集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-kube-proxy"><span class="toc-text">5.6 kube-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-1-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">5.6.1 参数配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-2-kubeconfig-%E6%96%87%E4%BB%B6"><span class="toc-text">5.6.2 kubeconfig 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-3-%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-text">5.6.3 开机启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-7-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-text">5.7 集群管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-1-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-text">5.7.1 集群配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-2-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-text">5.7.2 集群状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-8-%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8"><span class="toc-text">5.8 命令补全</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-text">6. 网络插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-CNI-Plugins"><span class="toc-text">6.1 CNI Plugins</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-calico"><span class="toc-text">6.2 calico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-flannel"><span class="toc-text">6.3 flannel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-ovs-cni"><span class="toc-text">6.4 ovs-cni</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1-%E5%AE%89%E8%A3%85-open-vswitch"><span class="toc-text">6.4.1 安装 open-vswitch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-2-%E5%AE%89%E8%A3%85-multus"><span class="toc-text">6.4.2 安装 multus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-3-%E5%AE%89%E8%A3%85-ovs-cni"><span class="toc-text">6.4.3 安装 ovs-cni</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-4-%E7%BD%91%E6%A1%A5"><span class="toc-text">6.4.4 网桥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-5-%E7%BD%91%E7%BB%9C%E6%89%A9%E5%B1%95"><span class="toc-text">6.4.5 网络扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-6-%E9%AA%8C%E8%AF%81"><span class="toc-text">6.4.6 验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Node-%E8%8A%82%E7%82%B9"><span class="toc-text">7. Node 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%85%8B%E9%9A%86%E5%87%86%E5%A4%87-master%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C"><span class="toc-text">6.1 克隆准备 (master节点执行)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%85%8B%E9%9A%86%E8%8A%82%E7%82%B9"><span class="toc-text">6.2 克隆节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-text">6.3 修改配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-text">6.4 开机启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4-master%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C"><span class="toc-text">6.5 加入集群 (master节点执行)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Addons"><span class="toc-text">8. Addons</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-CoreDNS"><span class="toc-text">8.1 CoreDNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-Dashboard"><span class="toc-text">8.2 Dashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">9. 高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E5%87%86%E5%A4%87%E6%93%8D%E4%BD%9C-Master-1"><span class="toc-text">9.1 准备操作 (Master-1)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-1-kube-apiserver-%E8%AF%81%E4%B9%A6%E6%9B%B4%E6%96%B0"><span class="toc-text">9.1.1 kube-apiserver 证书更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-2-%E5%A2%9E%E5%8A%A0%E4%B8%BB%E6%9C%BA"><span class="toc-text">9.1.2 增加主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E6%89%A9%E5%AE%B9-Master"><span class="toc-text">9.2 扩容 Master</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-1-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">9.2.1 初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-2-%E5%85%8B%E9%9A%86"><span class="toc-text">9.2.2 克隆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-3-%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">9.2.3 更新配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-4-%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-text">9.2.4 开机启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-5-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-text">9.2.5 集群状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-6-%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-text">9.2.6 加入集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-7-%E6%89%93%E6%A0%87%E5%92%8C%E6%B1%A1%E7%82%B9"><span class="toc-text">9.2.7 打标和污点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">9.3 高可用负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-1-%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="toc-text">9.3.1 安装软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-2-%E9%85%8D%E7%BD%AENginx"><span class="toc-text">9.3.2 配置Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-3-keepalived-%E9%85%8D%E7%BD%AE-master"><span class="toc-text">9.3.3 keepalived 配置 (master)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-4-keepalived-%E9%85%8D%E7%BD%AE-slave"><span class="toc-text">9.3.4 keepalived 配置 (slave)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-5-keepalived-%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%AC"><span class="toc-text">9.3.5 keepalived 检查脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-6-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">9.3.6 启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-7-%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="toc-text">9.3.7 状态检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-8-Worker-Node-%E8%BF%9E%E6%8E%A5%E5%88%B0-LB-VIP"><span class="toc-text">9.3.8 Worker Node 连接到 LB VIP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="toc-text">10. 删除节点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Z-%E8%A1%A5%E5%85%85"><span class="toc-text">Z. 补充</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-text">组件日志级别</span></a></li></ol></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/categories/"
    title="blog/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/CentOS/" href="/categories/CentOS/"><div class='name'>CentOS</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Docker/" href="/categories/Docker/"><div class='name'>Docker</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Golang/" href="/categories/Golang/"><div class='name'>Golang</div><div class='badge'>(39)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Linux/" href="/categories/Linux/"><div class='name'>Linux</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/MySQL/" href="/categories/MySQL/"><div class='name'>MySQL</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Nginx/" href="/categories/Nginx/"><div class='name'>Nginx</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/NoSQL/" href="/categories/NoSQL/"><div class='name'>NoSQL</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Programing/" href="/categories/Programing/"><div class='name'>Programing</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/RabbitMQ/" href="/categories/RabbitMQ/"><div class='name'>RabbitMQ</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Tools/" href="/categories/Tools/"><div class='name'>Tools</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/golang/" href="/categories/golang/"><div class='name'>golang</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/k8s/" href="/categories/k8s/"><div class='name'>k8s</div><div class='badge'>(10)</div></a></li>
        
          <li><a class="flat-box" title="/categories/kubernetes/" href="/categories/kubernetes/"><div class='name'>kubernetes</div><div class='badge'>(3)</div></a></li>
        
      </ul>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget tagcloud'>
    
<header class='pure'>
  <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/tags/"
    title="blog/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <a href="/tags/algorithm/" style="font-size: 17.33px; color: #828282">algorithm</a> <a href="/tags/elasticsearch/" style="font-size: 14px; color: #999">elasticsearch</a> <a href="/tags/git/" style="font-size: 14px; color: #999">git</a> <a href="/tags/go/" style="font-size: 24px; color: #555">go</a> <a href="/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/tags/mongodb/" style="font-size: 14px; color: #999">mongodb</a> <a href="/tags/nginx/" style="font-size: 14px; color: #999">nginx</a> <a href="/tags/orm/" style="font-size: 14px; color: #999">orm</a> <a href="/tags/programing/" style="font-size: 14px; color: #999">programing</a> <a href="/tags/rabbitmq/" style="font-size: 14px; color: #999">rabbitmq</a> <a href="/tags/redis/" style="font-size: 14px; color: #999">redis</a> <a href="/tags/rpc/" style="font-size: 20.67px; color: #6c6c6c">rpc</a> <a href="/tags/supervisor/" style="font-size: 14px; color: #999">supervisor</a> <a href="/tags/websocket/" style="font-size: 14px; color: #999">websocket</a>
    </div>
  </section>


            
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:eli.he@outlook.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/elihe2011"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/#/user/home?id=282243842"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="/js/app.js"></script>



  
<script src="/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
