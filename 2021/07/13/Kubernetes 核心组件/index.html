<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Kubernetes 核心组件 | Eli&#39;s Blog</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/favicon/favicon.ico">
  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Eli's Blog</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Eli's Blog
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" target="_blank" href="https://xaoxuu.com/wiki/material-x/"
                
                  rel="nofollow noopener"
                
                
                id="https:xaoxuu.comwikimaterial-x">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2021/07/13/Kubernetes%20%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/">
        Kubernetes 核心组件
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="https://elihe2011.github.io" rel="nofollow">
        
          <img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png">
        
        <p>Eli He</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2021-07-13</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/kubernetes/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>kubernetes</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <h1 id="1-API-Server"><a href="#1-API-Server" class="headerlink" title="1. API-Server"></a>1. API-Server</h1><h2 id="1-1-工作原理"><a href="#1-1-工作原理" class="headerlink" title="1.1 工作原理"></a>1.1 工作原理</h2><p>核心功能：<strong>资源操作入口</strong></p>
<ul>
<li>提供集群管理的 <strong>REST API 接口</strong>，包括认证授权、准入控制、数据校验以及集群状态变更等</li>
<li>提供其他模块之间的数据交互和通信的<strong>枢纽</strong>（其他模块通过 API Server 查询或修改数据，<strong>只有 API Server 能够直接操作 etcd</strong>）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-api-server.png" alt="img"> </p>
<span id="more"></span>

<h2 id="1-2-访问"><a href="#1-2-访问" class="headerlink" title="1.2 访问"></a>1.2 访问</h2><h3 id="1-2-1-访问端口"><a href="#1-2-1-访问端口" class="headerlink" title="1.2.1 访问端口"></a>1.2.1 访问端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/kubernetes/kube-apiserver.conf</span><br><span class="line">--insecure-bind-address=127.0.0.1 \</span><br><span class="line">--insecure-port=8080 \</span><br><span class="line">--bind-address=192.168.80.11 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line"></span><br><span class="line">curl http://localhost:8080</span><br><span class="line">curl https://192.168.80.11:6443</span><br></pre></td></tr></table></figure>



<h3 id="1-2-2-访问方式"><a href="#1-2-2-访问方式" class="headerlink" title="1.2.2 访问方式"></a>1.2.2 访问方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. sdk</span></span><br><span class="line">go get k8s.io/client-go@latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. kubectl</span></span><br><span class="line">kubectl get --raw /api/v1/namespaces | python -m json.tool</span><br><span class="line">kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes</span><br><span class="line">kubectl get --raw /apis/metrics.k8s.io/v1beta1/pods</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. kubectl proxy</span></span><br><span class="line">kubectl proxy --port=8081 &amp;</span><br><span class="line">curl http://localhost:8081/api/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;APIVersions&quot;</span>,</span><br><span class="line">  <span class="string">&quot;versions&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;v1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;serverAddressByClientCIDRs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;clientCIDR&quot;</span>: <span class="string">&quot;0.0.0.0/0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;serverAddress&quot;</span>: <span class="string">&quot;192.168.80.45:6443&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. curl</span></span><br><span class="line">TOKEN=$(kubectl describe secrets $(kubectl get secrets -n kube-system |grep admin |cut -f1 -d <span class="string">&#x27; &#x27;</span>) -n kube-system |grep -E <span class="string">&#x27;^token&#x27;</span> |cut -f2 -d<span class="string">&#x27;:&#x27;</span>|tr -d <span class="string">&#x27;\t&#x27;</span>|tr -d <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">APISERVER=$(kubectl config view |grep server|cut -f 2- -d <span class="string">&quot;:&quot;</span> | tr -d <span class="string">&quot; &quot;</span>)</span><br><span class="line">curl -H <span class="string">&quot;Authorization: Bearer <span class="variable">$TOKEN</span>&quot;</span> <span class="variable">$APISERVER</span>/api  --insecure</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;APIVersions&quot;</span>,</span><br><span class="line">  <span class="string">&quot;versions&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;v1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;serverAddressByClientCIDRs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;clientCIDR&quot;</span>: <span class="string">&quot;0.0.0.0/0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;serverAddress&quot;</span>: <span class="string">&quot;192.168.80.45:6443&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;r</span><br></pre></td></tr></table></figure>



<h2 id="1-3-API-资源"><a href="#1-3-API-资源" class="headerlink" title="1.3 API 资源"></a>1.3 API 资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有支持的资源</span></span><br><span class="line">$ kubectl api-resources</span><br><span class="line">NAME                              SHORTNAMES   APIGROUP                       NAMESPACED   KIND</span><br><span class="line">bindings                                                                      <span class="literal">true</span>         Binding</span><br><span class="line">componentstatuses                 cs                                          <span class="literal">false</span>        ComponentStatus</span><br><span class="line">configmaps                        cm                                          <span class="literal">true</span>         ConfigMap</span><br><span class="line">endpoints                         ep                                          <span class="literal">true</span>         Endpoints</span><br><span class="line">events                            ev                                          <span class="literal">true</span>         Event</span><br><span class="line">limitranges                       limits                                      <span class="literal">true</span>         LimitRange</span><br><span class="line">namespaces                        ns                                          <span class="literal">false</span>        Namespace</span><br><span class="line">nodes                             no                                          <span class="literal">false</span>        Node</span><br><span class="line">persistentvolumeclaims            pvc                                         <span class="literal">true</span>         PersistentVolumeClaim</span><br><span class="line">persistentvolumes                 pv                                          <span class="literal">false</span>        PersistentVolume</span><br><span class="line">pods                              po                                          <span class="literal">true</span>         Pod</span><br><span class="line">podtemplates                                                                  <span class="literal">true</span>         PodTemplate</span><br><span class="line">replicationcontrollers            rc                                          <span class="literal">true</span>         ReplicationController</span><br><span class="line">resourcequotas                    quota                                       <span class="literal">true</span>         ResourceQuota</span><br><span class="line">secrets                                                                       <span class="literal">true</span>         Secret</span><br><span class="line">serviceaccounts                   sa                                          <span class="literal">true</span>         ServiceAccount</span><br><span class="line">services                          svc                                         <span class="literal">true</span>         Service</span><br><span class="line">mutatingwebhookconfigurations                  admissionregistration.k8s.io   <span class="literal">false</span>        MutatingWebhookConfiguration</span><br><span class="line">validatingwebhookconfigurations                admissionregistration.k8s.io   <span class="literal">false</span>        ValidatingWebhookConfiguration</span><br><span class="line">customresourcedefinitions         crd,crds     apiextensions.k8s.io           <span class="literal">false</span>        CustomResourceDefinition</span><br><span class="line">apiservices                                    apiregistration.k8s.io         <span class="literal">false</span>        APIService</span><br><span class="line">controllerrevisions                            apps                           <span class="literal">true</span>         ControllerRevision</span><br><span class="line">daemonsets                        ds           apps                           <span class="literal">true</span>         DaemonSet</span><br><span class="line">deployments                       deploy       apps                           <span class="literal">true</span>         Deployment</span><br><span class="line">replicasets                       rs           apps                           <span class="literal">true</span>         ReplicaSet</span><br><span class="line">statefulsets                      sts          apps                           <span class="literal">true</span>         StatefulSet</span><br><span class="line">tokenreviews                                   authentication.k8s.io          <span class="literal">false</span>        TokenReview</span><br><span class="line">localsubjectaccessreviews                      authorization.k8s.io           <span class="literal">true</span>         LocalSubjectAccessReview</span><br><span class="line">selfsubjectaccessreviews                       authorization.k8s.io           <span class="literal">false</span>        SelfSubjectAccessReview</span><br><span class="line">selfsubjectrulesreviews                        authorization.k8s.io           <span class="literal">false</span>        SelfSubjectRulesReview</span><br><span class="line">subjectaccessreviews                           authorization.k8s.io           <span class="literal">false</span>        SubjectAccessReview</span><br><span class="line">horizontalpodautoscalers          hpa          autoscaling                    <span class="literal">true</span>         HorizontalPodAutoscaler</span><br><span class="line">cronjobs                          cj           batch                          <span class="literal">true</span>         CronJob</span><br><span class="line"><span class="built_in">jobs</span>                                           batch                          <span class="literal">true</span>         Job</span><br><span class="line">certificatesigningrequests        csr          certificates.k8s.io            <span class="literal">false</span>        CertificateSigningRequest</span><br><span class="line">leases                                         coordination.k8s.io            <span class="literal">true</span>         Lease</span><br><span class="line">endpointslices                                 discovery.k8s.io               <span class="literal">true</span>         EndpointSlice</span><br><span class="line">events                            ev           events.k8s.io                  <span class="literal">true</span>         Event</span><br><span class="line">ingresses                         ing          extensions                     <span class="literal">true</span>         Ingress</span><br><span class="line">ingressclasses                                 networking.k8s.io              <span class="literal">false</span>        IngressClass</span><br><span class="line">ingresses                         ing          networking.k8s.io              <span class="literal">true</span>         Ingress</span><br><span class="line">networkpolicies                   netpol       networking.k8s.io              <span class="literal">true</span>         NetworkPolicy</span><br><span class="line">runtimeclasses                                 node.k8s.io                    <span class="literal">false</span>        RuntimeClass</span><br><span class="line">poddisruptionbudgets              pdb          policy                         <span class="literal">true</span>         PodDisruptionBudget</span><br><span class="line">podsecuritypolicies               psp          policy                         <span class="literal">false</span>        PodSecurityPolicy</span><br><span class="line">clusterrolebindings                            rbac.authorization.k8s.io      <span class="literal">false</span>        ClusterRoleBinding</span><br><span class="line">clusterroles                                   rbac.authorization.k8s.io      <span class="literal">false</span>        ClusterRole</span><br><span class="line">rolebindings                                   rbac.authorization.k8s.io      <span class="literal">true</span>         RoleBinding</span><br><span class="line">roles                                          rbac.authorization.k8s.io      <span class="literal">true</span>         Role</span><br><span class="line">priorityclasses                   pc           scheduling.k8s.io              <span class="literal">false</span>        PriorityClass</span><br><span class="line">csidrivers                                     storage.k8s.io                 <span class="literal">false</span>        CSIDriver</span><br><span class="line">csinodes                                       storage.k8s.io                 <span class="literal">false</span>        CSINode</span><br><span class="line">storageclasses                    sc           storage.k8s.io                 <span class="literal">false</span>        StorageClass</span><br><span class="line">volumeattachments                              storage.k8s.io                 <span class="literal">false</span>        VolumeAttachment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取特定组 apps 的资源</span></span><br><span class="line">$ kubectl api-resources --api-group apps</span><br><span class="line">kubectl api-resources --api-group apps</span><br><span class="line">NAME                  SHORTNAMES   APIGROUP   NAMESPACED   KIND</span><br><span class="line">controllerrevisions                apps       <span class="literal">true</span>         ControllerRevision</span><br><span class="line">daemonsets            ds           apps       <span class="literal">true</span>         DaemonSet</span><br><span class="line">deployments           deploy       apps       <span class="literal">true</span>         Deployment</span><br><span class="line">replicasets           rs           apps       <span class="literal">true</span>         ReplicaSet</span><br><span class="line">statefulsets          sts          apps       <span class="literal">true</span>         StatefulSet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 资源详细解释</span></span><br><span class="line">$ kubectl explain svc</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Service is a named abstraction of software service (<span class="keyword">for</span> example, mysql)</span><br><span class="line">     consisting of <span class="built_in">local</span> port (<span class="keyword">for</span> example 3306) that the proxy listens on, and</span><br><span class="line">     the selector that determines <span class="built_in">which</span> pods will answer requests sent through</span><br><span class="line">     the proxy.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion   &lt;string&gt;</span><br><span class="line">     APIVersion defines the versioned schema of this representation of an</span><br><span class="line">     object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">     value, and may reject unrecognized values. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#resources</span></span><br><span class="line"></span><br><span class="line">   kind &lt;string&gt;</span><br><span class="line">     Kind is a string value representing the REST resource this object</span><br><span class="line">     represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">     requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#types-kinds</span></span><br><span class="line"></span><br><span class="line">   metadata     &lt;Object&gt;</span><br><span class="line">     Standard object<span class="string">&#x27;s metadata. More info:</span></span><br><span class="line"><span class="string">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   spec &lt;Object&gt;</span></span><br><span class="line"><span class="string">     Spec defines the behavior of a service.</span></span><br><span class="line"><span class="string">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   status       &lt;Object&gt;</span></span><br><span class="line"><span class="string">     Most recently observed status of the service. Populated by the system.</span></span><br><span class="line"><span class="string">     Read-only. More info:</span></span><br><span class="line"><span class="string">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line"><span class="string">     </span></span><br><span class="line"><span class="string"># 集群支持的API版本</span></span><br><span class="line"><span class="string">$ kubectl api-versions</span></span><br><span class="line"><span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="string">admissionregistration.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="string">apiregistration.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">apps/v1</span></span><br><span class="line"><span class="string">authentication.k8s.io/v1</span></span><br><span class="line"><span class="string">authentication.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">autoscaling/v1</span></span><br><span class="line"><span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="string">autoscaling/v2beta2</span></span><br><span class="line"><span class="string">batch/v1</span></span><br><span class="line"><span class="string">batch/v1beta1</span></span><br><span class="line"><span class="string">certificates.k8s.io/v1</span></span><br><span class="line"><span class="string">certificates.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">coordination.k8s.io/v1</span></span><br><span class="line"><span class="string">coordination.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">discovery.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">events.k8s.io/v1</span></span><br><span class="line"><span class="string">events.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">node.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">policy/v1beta1</span></span><br><span class="line"><span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="string">scheduling.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="string">storage.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">v1</span></span><br></pre></td></tr></table></figure>



<h2 id="1-4-示例"><a href="#1-4-示例" class="headerlink" title="1.4 示例"></a>1.4 示例</h2><p><a target="_blank" rel="noopener" href="https://v1-19.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#read-pod-v1-core">https://v1-19.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#read-pod-v1-core</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; pod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-example</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: alpine</span></span><br><span class="line"><span class="string">    image: alpine:latest</span></span><br><span class="line"><span class="string">    command: [&quot;echo&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;Hello World&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f pod.yml</span><br><span class="line">kubectl get pod</span><br><span class="line"></span><br><span class="line">curl http://localhost:8080/api/v1/namespaces/default/pods/pod-example</span><br></pre></td></tr></table></figure>



<h1 id="2-Controller-Manager"><a href="#2-Controller-Manager" class="headerlink" title="2. Controller-Manager"></a>2. Controller-Manager</h1><p>Controller Manager 由 kube-controller-manager 和 cloud-controller-manager 组成，<strong>是 Kubernetes 的大脑</strong>，它通过 apiserver 监控整个集群的状态，并确保集群处于预期的工作状态。</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-controller-manager.png" alt="img"> </p>
<p>Controller Manager作为<strong>集群内部的管理控制中心</strong>，负责集群内的Node、Pod副本、服务端点（Endpoint）、命名空间（Namespace）、服务账号（ServiceAccount）、资源定额（ResourceQuota）的管理，当某个Node意外宕机时，Controller Manager会及时发现并执行自动化修复流程，确保集群始终处于预期的工作状态。</p>
<h2 id="2-1-控制器分类"><a href="#2-1-控制器分类" class="headerlink" title="2.1 控制器分类"></a>2.1 控制器分类</h2><p><strong>kube-controller-manager:</strong></p>
<ul>
<li>Replication Controller</li>
<li>Node Controller</li>
<li>CronJob Controller</li>
<li>Daemon Controller</li>
<li>Deployment Controller</li>
<li>Endpoint Controller</li>
<li>Garbage Collector</li>
<li>Namespace Controller</li>
<li>Job Controller</li>
<li>Pod AutoScaler</li>
<li>RelicaSet</li>
<li>Service Controller</li>
<li>ServiceAccount Controller</li>
<li>StatefulSet Controller</li>
<li>Volume Controller</li>
<li>Resource quota Controller</li>
</ul>
<p><strong>cloud-controller-manager:</strong> 在 Kubernetes 启用 Cloud Provider 的时候才需要，用来配合云服务提供商的控制</p>
<ul>
<li>Node Controller</li>
<li>Route Controller</li>
<li>Service Controller</li>
</ul>
<h2 id="2-2-Replication-Controller-RC"><a href="#2-2-Replication-Controller-RC" class="headerlink" title="2.2 Replication Controller (RC)"></a>2.2 Replication Controller (RC)</h2><p>简称RC，即副本控制器，它的作用是保证集群中一个RC所关联的Pod副本数始终保持预设值</p>
<ul>
<li>只有当Pod的重启策略<code>RestartPolicy=Always</code>时，RC才会管理该Pod的操作（创建、销毁、重启等）</li>
<li>创建Pod的RC模板，只在创建Pod时有效，一旦Pod创建完成，模板的变化，不会影响到已创建好的Pod</li>
<li>可通过修改Pod的Label，使该Pod脱离RC的管理。该方法可用于Pod从集群中迁移，数据修复等调试</li>
<li>删除一个RC不影响它所创建的Pod，如果要删除Pod，需要将RC的副本数属性设置为0</li>
<li>不要越过RC创建Pod，因为RC实现了自动化管理Pod，提高容灾能力</li>
</ul>
<h3 id="2-2-1-RC-的职责"><a href="#2-2-1-RC-的职责" class="headerlink" title="2.2.1 RC 的职责"></a>2.2.1 RC 的职责</h3><ul>
<li>维护集群中Pod的副本数</li>
<li>通过调整RC中的<code>spec.replicas</code>属性值来实现系统的扩容或缩容</li>
<li>通过改变RC中的Pod模板来实现系统的滚动升级</li>
</ul>
<h3 id="2-2-2-存活探针"><a href="#2-2-2-存活探针" class="headerlink" title="2.2.2 存活探针"></a>2.2.2 存活探针</h3><p>Kubemetes有以下三种探测容器的机制：</p>
<ul>
<li>HTTPGET探针：对容器的地址<code>http://ip:port/path</code>执行HTTPGET请求<ul>
<li>成功：探测器收到响应，且响应状态码不代表错误（2xx、3xx)</li>
<li>失败：未收到响应，或收到错误响应状态码</li>
</ul>
</li>
<li>TCP套接字探针：尝试与容器指定端口建立TCP连接。如果连接成功建立，则探测成功；否则，容器重新启动。</li>
<li>Exec探针：在容器内执行任意命令，并检查命令的退出状态码。如果状态码是0, 则探测成功；其他状态码都被认为失败。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">      <span class="comment"># 一个基于HTTP GET的存活探针</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="comment"># 第一次检测在容器启动15秒后</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>



<h2 id="2-3-ReplicaSet-RS"><a href="#2-3-ReplicaSet-RS" class="headerlink" title="2.3 ReplicaSet (RS)"></a>2.3 ReplicaSet (RS)</h2><p>RS 是RC的替代者，它使用Deployment管理，比RC更强大</p>
<h2 id="2-4-Node-Controller"><a href="#2-4-Node-Controller" class="headerlink" title="2.4 Node Controller"></a>2.4 Node Controller</h2><p>kubelet 在启动时，会通过API Server注册自身的节点信息，并定时向API Server汇报状态信息；API Server接收到信息后，将信息更新到etcd中。</p>
<p>Controller Manager 在启动时，如果设置了<code>--cluster-cidr</code> 参数，对于没有设置<code>Sepc.PodCIDR</code>的Node节点生成一个CIDR地址，并用该CIDR地址设置节点的<code>Spec.PodCIDR</code>属性，防止不同的节点的CIDR地址发生冲突。</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-node-controller.png" alt="img"> </p>
<h3 id="2-4-1-Node-Eviction"><a href="#2-4-1-Node-Eviction" class="headerlink" title="2.4.1 Node Eviction"></a>2.4.1 Node Eviction</h3><p>Node 控制器在节点异常后，会按照默认的速率（<code>--node-eviction-rate=0.1</code>，即每10秒一个节点的速率）进行 Node 的驱逐。Node 控制器按照 Zone 将节点划分为不同的组，再跟进 Zone 的状态进行速率调整：</p>
<ul>
<li><p>Normal：所有节点都 Ready，默认速率驱逐。</p>
</li>
<li><p>PartialDisruption：即超过33% 的节点 NotReady 的状态。当异常节点比例大于<code>--unhealthy-zone-threshold=0.55</code>时开始减慢速率：</p>
<ul>
<li>小集群（即节点数量小于 <code>--large-cluster-size-threshold=50</code>）：停止驱逐</li>
<li>大集群，减慢速率为 <code>--secondary-node-eviction-rate=0.01</code></li>
</ul>
</li>
<li><p>FullDisruption：所有节点都 NotReady，返回使用默认速率驱逐。但当所有 Zone 都处在 FullDisruption 时，停止驱逐。</p>
</li>
</ul>
<h2 id="2-5-ResourceQuota-Controller"><a href="#2-5-ResourceQuota-Controller" class="headerlink" title="2.5 ResourceQuota Controller"></a>2.5 ResourceQuota Controller</h2><p>资源配额管理，确保指定的资源对象在任何适合都不会超量占用系统物理资源。</p>
<p>支持三个级别的资源配置管理：</p>
<ul>
<li>容器级别：对CPU和Memory进行限制</li>
<li>Pod级别：对一个Pod内所有容器的可用资源进行限制</li>
<li>Namespace级别：<ul>
<li>Pod数量</li>
<li>RS 数量</li>
<li>SVC 数量</li>
<li>ResourceQuota 数量</li>
<li>Secret 数量</li>
<li>可持有的PV（Persistent Volume）数量</li>
</ul>
</li>
</ul>
<p>说明：</p>
<ol>
<li>配额管理通过 Admission Control (准入控制) 来管理</li>
<li>Admission Control 提供两针配额约束方式<ul>
<li>LimitRanger：作用于Pod和Container</li>
<li>ResourceQuota：作用于Namespace，限定一个Namespace中的各种资源的使用总额</li>
</ul>
</li>
</ol>
<p>ResourceQuota Controller流程图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-resource-quota-controller.png" alt="img"> </p>
<h2 id="2-6-Namespace-Controller"><a href="#2-6-Namespace-Controller" class="headerlink" title="2.6 Namespace Controller"></a>2.6 Namespace Controller</h2><p>用户通过API Server创建新的Namespace并保存在etcd中，Namespace Controller定时通过API Server 读取这些Namespace信息。</p>
<p>如果Namespace被API标记为优雅删除(即设置删除期限，DeletionTimestamp)，则将该Namespace状态设置为”Terminating”，并保存到etcd中，同时Namespace Controller删除该Namespace下的ServiceAccount, RS, Pod等资源对象。</p>
<h2 id="2-7-Endpoint-Controller"><a href="#2-7-Endpoint-Controller" class="headerlink" title="2.7 Endpoint Controller"></a>2.7 Endpoint Controller</h2><p><strong>Service, Endpoint, Pod的关系：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-svc-endpoint-pod.png" alt="img"> </p>
<p>Endpoints 表示一个Service对应的所有Pod副本的访问地址，而Endpoints Controller负责生成和维护所有Endpoints对象的控制器，它负责监听Service和对应的Pod副本变化：</p>
<ul>
<li>Service被删除，则删除和该Service同名的Endpoints对象</li>
<li>Service被创建或修改，则根据该Service信息获得相关的Pod列表，然后创建或更新Service对应的Endpoints对象</li>
<li>Pod事件，则更它对应的Service的Endpoints对象</li>
</ul>
<p><strong>kube-proxy</strong> 进程获取每个Service的Endpoints，实现Service的负载均衡功能</p>
<h2 id="2-8-Service-Controller"><a href="#2-8-Service-Controller" class="headerlink" title="2.8 Service Controller"></a>2.8 Service Controller</h2><p>Service Controller 属于kubernetes集群与外部云平台之间的一个接口控制器。它监听Service变化，如果一个LoadBalancer类型的Service，则确保外部的云平台上对该Service对应的Load Balancer实例相应地创建、删除及更新路由转发表。</p>
<h1 id="3-Scheduler"><a href="#3-Scheduler" class="headerlink" title="3. Scheduler"></a>3. Scheduler</h1><p>Scheduler负责Pod调度，在整个系统中起“承上启下”作用</p>
<p><strong>承上</strong>：负责接收Controller Manager 创建的新的Pod，并为其选择合适的Node</p>
<p><strong>启下</strong>：Node上的kubelet接管Pod的生命周期</p>
<p><strong>Scheduler 集群分发调度器:</strong></p>
<p>1) 通过调度算法，选择合适的Node，将待调度的Pod在该Node上创建，并将信息写入etcd中</p>
<p>2) kubelet 通过API Server监听到 Scheduler 产生的Pod绑定信息，然后获取对应的Pod清单，下载image，并启动容器</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-scheduler.png" alt="img"></p>
<h2 id="3-1-调度流程"><a href="#3-1-调度流程" class="headerlink" title="3.1 调度流程"></a>3.1 调度流程</h2><ul>
<li>预选调度过程：即遍历所有目标Node，筛选出符合要求的候选节点。k8s 内置了多种预选策略(Predicates) 供用户选择</li>
<li>确定最优节点：采用优选策略（Priority）计算出每个候选节点的积分，取最高分</li>
</ul>
<p>调度流程通过插件式加载的<strong>调度算法提供者(Algorithm Provider)</strong> 具体实现，一个调度算法提供者就是包括一组预选策略与一组优选策略的结构体。</p>
<h2 id="3-2-预选策略"><a href="#3-2-预选策略" class="headerlink" title="3.2 预选策略"></a>3.2 预选策略</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CheckNodeCondition：检查节点是否正常（如ip，磁盘等）</span><br><span class="line">GeneralPredicates</span><br><span class="line">  HostName：检查Pod对象是否定义了pod.spec.hostname</span><br><span class="line">  PodFitsHostPorts：pod要能适配node的端口 pods.spec.containers.ports.hostPort（指定绑定在节点的端口上）</span><br><span class="line">  MatchNodeSelector：检查节点的NodeSelector的标签 pods.spec.nodeSelector</span><br><span class="line">  PodFitsResources：检查Pod的资源需求是否能被节点所满足</span><br><span class="line">NoDiskConflict: 检查Pod依赖的存储卷是否能满足需求（默认未使用）</span><br><span class="line">PodToleratesNodeTaints：检查Pod上的spec.tolerations可容忍的污点是否完全包含节点上的污点</span><br><span class="line">PodToleratesNodeNoExecuteTaints：不能执行（NoExecute）的污点（默认未使用）</span><br><span class="line">CheckNodeLabelPresence：检查指定的标签再上节点是否存在</span><br><span class="line">CheckServiceAffinity：将相同services相同的pod尽量放在一起（默认未使用）</span><br><span class="line">MaxEBSVolumeCount： 检查EBS（AWS存储）存储卷的最大数量</span><br><span class="line">MaxGCEPDVolumeCount GCE存储最大数</span><br><span class="line">MaxAzureDiskVolumeCount: AzureDisk 存储最大数</span><br><span class="line">CheckVolumeBinding：检查节点上已绑定或未绑定的pvc</span><br><span class="line">NoVolumeZoneConflict：检查存储卷对象与pod是否存在冲突</span><br><span class="line">CheckNodeMemoryPressure：检查节点内存是否存在压力过大</span><br><span class="line">CheckNodePIDPressure：检查节点上的PID数量是否过大</span><br><span class="line">CheckNodeDiskPressure： 检查内存、磁盘IO是否过大</span><br><span class="line">MatchInterPodAffinity: 检查节点是否能满足pod的亲和性或反亲和性</span><br></pre></td></tr></table></figure>



<h2 id="3-3-优选策略"><a href="#3-3-优选策略" class="headerlink" title="3.3 优选策略"></a>3.3 优选策略</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LeastRequested： 空闲量越高得分越高</span><br><span class="line">(cpu((capacity-sum(requested))*10/capacity)+memory((capacity-sum(requested))*10/capacity))/2</span><br><span class="line"></span><br><span class="line">BalancedResourceAllocation：CPU和内存资源被占用率相近的胜出</span><br><span class="line">NodePreferAvoidPods: 节点注解信息“scheduler.alpha.kubernetes.io/preferAvoidPods”</span><br><span class="line">TaintToleration：将Pod对象的spec.tolerations列表项与节点的taints列表项进行匹配度检查，匹配条目越，得分越低</span><br><span class="line"></span><br><span class="line">SeletorSpreading：标签选择器分散度，（与当前pod对象通选的标签，所选其它pod越多的得分越低）</span><br><span class="line">InterPodAffinity：遍历pod对象的亲和性匹配项目，项目越多得分越高</span><br><span class="line">NodeAffinity：节点亲和性 、</span><br><span class="line">MostRequested：空闲量越小得分越高，和LeastRequested相反 （默认未启用）</span><br><span class="line">NodeLabel：节点是否存在对应的标签 （默认未启用）</span><br><span class="line">ImageLocality：根据满足当前Pod对象需求的已有镜像的体积大小之和（默认未启用）</span><br></pre></td></tr></table></figure>



<h2 id="3-4-高级调度"><a href="#3-4-高级调度" class="headerlink" title="3.4 高级调度"></a>3.4 高级调度</h2><h3 id="3-4-1-nodeSelector"><a href="#3-4-1-nodeSelector" class="headerlink" title="3.4.1 nodeSelector"></a>3.4.1 <code>nodeSelector</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建 redis 集群</span></span><br><span class="line">cat &gt; redis-deploy.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: redis</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: redis</span></span><br><span class="line"><span class="string">  replicas: 2</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: redis</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: redis</span></span><br><span class="line"><span class="string">        image: redis:6.2.3</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">            cpu: 100m</span></span><br><span class="line"><span class="string">            memory: 100Mi</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 6379</span></span><br><span class="line"><span class="string">      nodeSelector:</span></span><br><span class="line"><span class="string">        disk: ssd  # 限定磁盘类型</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubetcl apply -f redis-deploy.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查pod状态</span></span><br><span class="line">kubectl get pod</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">redis-9fc84569-2jlxh   0/1     Pending   0          60s</span><br><span class="line">redis-9fc84569-q78jd   0/1     Pending   0          60s</span><br><span class="line"></span><br><span class="line">kubectl describe pod redis-9fc84569-2jlxh</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                From               Message</span><br><span class="line">  ----     ------            ----               ----               -------</span><br><span class="line">  Warning  FailedScheduling  20s (x3 over 76s)  default-scheduler  0/4 nodes are available: 4 node(s) didn<span class="string">&#x27;t match node selector.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># k8s-node2 增加标签 disk=ssd </span></span><br><span class="line"><span class="string">kubectl label node k8s-node2 disk=ssd </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kubectl get  nodes --show-labels | grep disk=ssd</span></span><br><span class="line"><span class="string">k8s-node2     Ready      node     4d21h   v1.19.11   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disk=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node2,kubernetes.io/os=linux,node-role.kubernetes.io/node=</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 再次检查 pod 是否创建成功</span></span><br><span class="line"><span class="string">kubectl get pod -o wide</span></span><br><span class="line"><span class="string">NAME                   READY   STATUS    RESTARTS   AGE     IP           NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="string">redis-9fc84569-2jlxh   1/1     Running   0          5m20s   10.244.1.8   k8s-node2   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="string">redis-9fc84569-q78jd   1/1     Running   0          5m20s   10.244.1.7   k8s-node2   &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-4-2-亲和性-affinity"><a href="#3-4-2-亲和性-affinity" class="headerlink" title="3.4.2 亲和性 (affinity)"></a>3.4.2 亲和性 (affinity)</h3><h4 id="1-软亲和"><a href="#1-软亲和" class="headerlink" title="1. 软亲和"></a>1. 软亲和</h4><h4 id="preferredDuringSchedulingIgnoredDuringExecution"><a href="#preferredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="preferredDuringSchedulingIgnoredDuringExecution"></a><code>preferredDuringSchedulingIgnoredDuringExecution</code></h4><p><strong>软亲和</strong>：选择条件匹配多的，就算都不满足条件，还是会生成pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; preferred-affinity-pod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: preferred-affinity-pod</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: my-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: preferred-affinity-pod</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      containerPort: 80</span></span><br><span class="line"><span class="string">  affinity:</span></span><br><span class="line"><span class="string">    nodeAffinity:</span></span><br><span class="line"><span class="string">      preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">      - preference:</span></span><br><span class="line"><span class="string">          matchExpressions:</span></span><br><span class="line"><span class="string">          - key: apps 	# 标签键名</span></span><br><span class="line"><span class="string">            operator: In</span></span><br><span class="line"><span class="string">            values:</span></span><br><span class="line"><span class="string">            - mysql     # apps=mysql</span></span><br><span class="line"><span class="string">            - redis     # apps=redis</span></span><br><span class="line"><span class="string">        weight: 60 		# 匹配相应nodeSelectorTerm相关联的权重,1-100</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f preferred-affinity-pod.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不满足依旧创建成功</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">preferred-affinity-pod   1/1     Running   0          61s   10.244.2.18   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<h4 id="2-硬亲和"><a href="#2-硬亲和" class="headerlink" title="2. 硬亲和"></a>2. 硬亲和</h4><p><code>requiredDuringSchedulingIgnoredDuringExecution</code> </p>
<p><strong>硬亲和</strong>：选择条件匹配多的，必须满足一项，才会生成pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; required-affinity-pod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: required-affinity-pod</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: my-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: required-affinity-pod</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      containerPort: 80</span></span><br><span class="line"><span class="string">  affinity:</span></span><br><span class="line"><span class="string">    nodeAffinity:</span></span><br><span class="line"><span class="string">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">        nodeSelectorTerms:</span></span><br><span class="line"><span class="string">          - matchExpressions:</span></span><br><span class="line"><span class="string">            - key: apps 	# 标签键名</span></span><br><span class="line"><span class="string">              operator: In</span></span><br><span class="line"><span class="string">              values:</span></span><br><span class="line"><span class="string">                - mysql     # apps=mysql</span></span><br><span class="line"><span class="string">                - redis     # apps=redis          </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f required-affinity-pod.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不满足无法创建成功</span></span><br><span class="line">kubectl  get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">required-affinity-pod    0/1     Pending   0          18s   &lt;none&gt;        &lt;none&gt;      &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 k8s-node1 的标签</span></span><br><span class="line">kubectl label node k8s-node1 apps=mysql </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建成功</span></span><br><span class="line">kubectl  get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">required-affinity-pod    1/1     Running   0          2m31s   10.244.2.19   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-3-反亲和性"><a href="#3-4-3-反亲和性" class="headerlink" title="3.4.3 反亲和性"></a>3.4.3 反亲和性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; anti-affinity.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: myapp1</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: myapp1</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: myapp1</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      containerPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: myapp2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: myapp2</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: myapp2</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      containerPort: 80</span></span><br><span class="line"><span class="string">  affinity:</span></span><br><span class="line"><span class="string">    podAntiAffinity: </span></span><br><span class="line"><span class="string">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">      - labelSelector:</span></span><br><span class="line"><span class="string">          matchExpressions:</span></span><br><span class="line"><span class="string">          - key: app</span></span><br><span class="line"><span class="string">            operator: In</span></span><br><span class="line"><span class="string">            values:</span></span><br><span class="line"><span class="string">            - myapp1   # app=myapp1</span></span><br><span class="line"><span class="string">        topologyKey: kubernetes.io/hostname  #kubernetes.io/hostname的值一样代表pod不处于同一位置  </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f anti-affinity.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分属不同的节点上</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp1   1/1     Running   0          43s   10.244.2.20   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp2   1/1     Running   0          43s   10.244.1.9    k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<h2 id="3-5-污点和容忍"><a href="#3-5-污点和容忍" class="headerlink" title="3.5 污点和容忍"></a>3.5 污点和容忍</h2><p>taint的effect定义对Pod排斥效果：</p>
<ul>
<li>NoSchedule：只影响调度过程，对现存的Pod对象不产生影响，即不驱离</li>
<li>NoExecute：既影响调度过程，也影响现在的Pod对象，即现存的Pod对象将被驱离</li>
<li>PreferNoSchedule： 最好不部署Pod，但如果实在找不到节点，也可以在此节点上部署</li>
</ul>
<h3 id="3-5-1-污点管理"><a href="#3-5-1-污点管理" class="headerlink" title="3.5.1 污点管理"></a>3.5.1 污点管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node k8s-master1 | grep Taints</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line"></span><br><span class="line">kubectl describe node k8s-node1 | grep Taints</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打污点</span></span><br><span class="line">kubectl taint node k8s-node1 node-role.kubernetes.io/node=:NoSchedule</span><br><span class="line"></span><br><span class="line">kubectl describe node k8s-node1 | grep Taints</span><br><span class="line">Taints:             node-role.kubernetes.io/node:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除污点</span></span><br><span class="line">kubectl taint node k8s-node1 node-role.kubernetes.io/node-</span><br></pre></td></tr></table></figure>



<h3 id="3-5-2-容忍"><a href="#3-5-2-容忍" class="headerlink" title="3.5.2 容忍"></a>3.5.2 容忍</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 节点全部加上node-type污点</span></span><br><span class="line">kubectl taint node k8s-node1 node-type=:NoSchedule</span><br><span class="line">kubectl taint node k8s-node2 node-type=:NoSchedule</span><br><span class="line"></span><br><span class="line">cat &gt; toleration-pod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: toleration-pod</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: toleration-pod</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: toleration-pod</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      containerPort: 80</span></span><br><span class="line"><span class="string">  tolerations:</span></span><br><span class="line"><span class="string">  - key: &quot;node-type&quot;           # 污点名称</span></span><br><span class="line"><span class="string">    operator: &quot;Equal&quot;          # Exists/Equal</span></span><br><span class="line"><span class="string">    value: &quot;PreferNoSchedule&quot;  # 污点值</span></span><br><span class="line"><span class="string">    effect: &quot;NoSchedule&quot;       # </span></span><br><span class="line"><span class="string">    #tolerationSeconds: 3600    # 如果被驱逐的话，容忍时间 effect和tolerationSeconds不能同时存在</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f toleration-pod.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法正常创建</span></span><br><span class="line">kubectl get pod</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">toleration-pod   0/1     Pending   0          5s</span><br><span class="line"></span><br><span class="line">kubectl describe pod toleration-pod</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                From               Message</span><br><span class="line">  ----     ------            ----               ----               -------</span><br><span class="line">  Warning  FailedScheduling  26s (x2 over 26s)  default-scheduler  0/4 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 3 node(s) had taint &#123;node-type: &#125;, that the pod didn&#x27;</span>t tolerate.</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s-node1 污点增加 PreferNoSchedule，并删除NoSchedule</span></span><br><span class="line">kubectl taint node k8s-node1 node-type=:PreferNoSchedule</span><br><span class="line">kubectl taint node k8s-node1 node-type=:NoSchedule-    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 调度成功</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">toleration-pod   1/1     Running   0          11m   10.244.2.21   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<h1 id="4-Kubelet"><a href="#4-Kubelet" class="headerlink" title="4. Kubelet"></a>4. Kubelet</h1><p>每个Node节点上都运行一个 Kubelet 服务进程，默认监听 10250 端口，接收并执行 Master 发来的指令，管理 Pod 及 Pod 中的容器。每个 Kubelet 进程会在 API Server 上注册所在Node节点的信息，定期向 Master 节点汇报该节点的资源使用情况，并通过 cAdvisor 监控节点和容器的资源。可以把kubelet理解成【Server-Agent】架构中的agent，是Node上的<strong>Pod管家</strong>。</p>
<h2 id="4-1-节点管理"><a href="#4-1-节点管理" class="headerlink" title="4.1 节点管理"></a>4.1 节点管理</h2><p>节点管理主要是节点自注册和节点状态更新：</p>
<ul>
<li>通过启动参数“-register-node” 来确定是否向API Server注册自己</li>
<li>没有选择自注册模式，则需要用户自己配置Node资源信息，同时配置API Server的地址</li>
<li>启动时，通过API Server注册节点信息，并定时向API Server发送节点新消息，API Server在接收到新消息后，将信息写入 etcd</li>
</ul>
<p>主要参数：</p>
<ul>
<li><code>--kubeconfig</code>: 指定kubeconfig的路径，该文件常用来指定证书</li>
<li><code>--hostname-override</code>: 配置该节点在集群中显示的主机名</li>
<li><code>--node-status-update-frequency</code>:  kubelet向API Server上报心跳的频率，默认10s</li>
</ul>
<h2 id="4-2-Pod-管理"><a href="#4-2-Pod-管理" class="headerlink" title="4.2 Pod 管理"></a>4.2 Pod 管理</h2><h3 id="4-2-1-获取-Pod-清单"><a href="#4-2-1-获取-Pod-清单" class="headerlink" title="4.2.1 获取 Pod 清单"></a>4.2.1 获取 Pod 清单</h3><p> kubelet 通过 API Server Client 使用Watch加List的方式，监听 “/registry/csinodes” 和 “/registry/pods” 目录，将获取到的信息同步到本地缓存中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">etcdctl get /registry/csinodes --prefix --keys-only</span><br><span class="line">/registry/csinodes/k8s-master1</span><br><span class="line">/registry/csinodes/k8s-master2</span><br><span class="line">/registry/csinodes/k8s-node1</span><br><span class="line">/registry/csinodes/k8s-node2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点详细信息</span></span><br><span class="line">etcdctl get /registry/csinodes/k8s-master1</span><br><span class="line">/registry/csinodes/k8s-master1</span><br><span class="line">k8s</span><br><span class="line"></span><br><span class="line">storage.k8s.io/v1CSINode⚌</span><br><span class="line">⚌</span><br><span class="line"></span><br><span class="line">k8s-master1<span class="string">&quot;*<span class="variable">$cc45d1d2</span>-dde9-4740-ac49-878a971ef0852⚌⚌⚌j=</span></span><br><span class="line"><span class="string">Node</span></span><br><span class="line"><span class="string">    k8s-master1&quot;</span><span class="variable">$5e851f78</span>-5bfc-4acb-b5c3-4a10cf353237*v1z⚌⚌</span><br><span class="line">kubeletUpdatestorage.k8s.io/v⚌⚌⚌FieldsV1:⚌</span><br><span class="line">⚌&#123;<span class="string">&quot;f:metadata&quot;</span>:&#123;<span class="string">&quot;f:ownerReferences&quot;</span>:&#123;<span class="string">&quot;.&quot;</span>:&#123;&#125;,<span class="string">&quot;k:&#123;\&quot;uid\&quot;:\&quot;5e851f78-5bfc-4acb-b5c3-4a10cf353237\&quot;&#125;&quot;</span>:&#123;<span class="string">&quot;.&quot;</span>:&#123;&#125;,<span class="string">&quot;f:apiVersion&quot;</span>:&#123;&#125;,<span class="string">&quot;f:kind&quot;</span>:&#123;&#125;,<span class="string">&quot;f:name&quot;</span>:&#123;&#125;,<span class="string">&quot;f:uid&quot;</span>:&#123;&#125;&#125;&#125;&#125;&#125;<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># pods信息</span></span><br><span class="line"><span class="string">etcdctl  get /registry/pods --prefix --keys-only</span></span><br><span class="line"><span class="string">/registry/pods/kube-system/coredns-867bfd96bd-264bb</span></span><br><span class="line"><span class="string">/registry/pods/kube-system/kube-flannel-ds-48kz2</span></span><br><span class="line"><span class="string">/registry/pods/kube-system/kube-flannel-ds-bsfpp</span></span><br><span class="line"><span class="string">/registry/pods/kube-system/kube-flannel-ds-h5shb</span></span><br><span class="line"><span class="string">/registry/pods/kube-system/kube-flannel-ds-qpvlt</span></span><br><span class="line"><span class="string">/registry/pods/kubernetes-dashboard/dashboard-metrics-scraper-79c5968bdc-62hlk</span></span><br><span class="line"><span class="string">/registry/pods/kubernetes-dashboard/kubernetes-dashboard-9f9799597-b8hfr</span></span><br></pre></td></tr></table></figure>

<p>所有针对 Pod 的操作都将会被 kubelet 监听到，kubelet会根据监听到的指令，创建、修改或删除本节点的Pod。</p>
<h3 id="4-2-2-Pod-创建流程"><a href="#4-2-2-Pod-创建流程" class="headerlink" title="4.2.2 Pod 创建流程"></a>4.2.2 Pod 创建流程</h3><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-pod-start-procedure.png" alt="img"> </p>
<p> kubelet 读取监听到的信息，如果是创建或修改 Pod，则执行如下处理：</p>
<ul>
<li>为Pod创建一个数据目录</li>
<li>从API Server读取该 Pod 清单</li>
<li>为该 Pod 挂载外部卷</li>
<li>下载 Pod 用到的 Secret</li>
<li>检查节点上是否已运行Pod，如果 Pod 没有容器或 Pause容器 没有启动，则先停止 Pod 里的所有容器进程。如果在Pod中有需要删除的容器，则删除这些容器</li>
<li>用 “kubernetes/pause” 镜像为每个Pod创建一个容器。Pause容器用于接管 Pod 中所有其他容器的网络。没创建一个新的Pod，kubelet 都会先创建一个 Pause容器，然后再创建其他容器。</li>
<li>Pod 中每个容器的处理：<ul>
<li>为容器计算一个hash值，然后用容器名字去docker查询对应容器的hash值。若查找到容器，但两者hash值不同，则停止docker中的容器进程，并停止与之管理的Pause容器；若两者相同，则不做任何处理</li>
<li>如果容器被终止了，且容器未指定 restartPolicy，则不做任何处理</li>
<li>调用 Docker Client 下载容器镜像，然后运行容器</li>
</ul>
</li>
</ul>
<h3 id="4-2-3-容器状态检查"><a href="#4-2-3-容器状态检查" class="headerlink" title="4.2.3 容器状态检查"></a>4.2.3 容器状态检查</h3><p>Pod 通过两类探针检查容器的监控状态：</p>
<ul>
<li>LivenessProbe: 生存检查。如果检查到容器不健康，则删除该容器，并根据容器的重启策略做响应处理。</li>
<li>ReadinessProbe: 就绪检查。如果检查的容器未就绪，将删除关联 Service 的 Endpoints 中关联条目。</li>
</ul>
<p>LivenessProbe 的三种实现方式：</p>
<ul>
<li>ExecAction：容器中执行命令，如果命令退出状态码是0，则表示容器健康</li>
<li>TCPSocketAction: 通过容器的 IP:PORT 执行 TCP 检查，如果端口能够被访问，则表示容器健康</li>
<li>HTTPGetAction：通过容器的 <a href="http://IP:PORT/path">http://IP:PORT/path</a> 调用HTTP GET方法，如果响应状态码表示成功(2xx, 3xx)，则认为容器健康</li>
</ul>
<h3 id="4-2-4-Static-Pod"><a href="#4-2-4-Static-Pod" class="headerlink" title="4.2.4 Static Pod"></a>4.2.4 Static Pod</h3><p>所有以非 API Server 方式创建的 Pod 都叫 Static Pod。Kubelet 将 Static Pod 的状态汇报给 API Server，API Server 为该 Static Pod 创建一个 Mirror Pod 和其相匹配。Mirror Pod 的状态将真实反映 Static Pod 的状态。当 Static Pod 被删除时，与之相对应的 Mirror Pod 也会被删除。</p>
<h2 id="4-3-cAdvisor-资源监控"><a href="#4-3-cAdvisor-资源监控" class="headerlink" title="4.3 cAdvisor 资源监控"></a>4.3 cAdvisor 资源监控</h2><p>资源监控级别：容器，Pod，Service，整个集群</p>
<p>Heapster: 为k8s提供了一个级别的监控平台，它是集群级别的监控和事件数据集成器(Aggregator)。它以Pod方式运行在集群中，并通过 kubelet 发现所有运行在集群中的节点，查看来自这些节点的资源使用情况。kubelet 通过 cAdvisor 获取其所在节点即容器的数据。Heapster通过带着关联标签的 Pod 分组信息，它们被推送到一个可配置的后端，用于存储和可视化展示。</p>
<p>cAdvisor: 一个开源的分析容器资源使用率和性能特征的代理工具，集成到 kubelet，当 kubelet 启动时会同时启动 cAdvisor，且一个cAdvidsor 只监控一个Node节点的信息。cAdvisor 自动查找所有在其节点上的容器，自动采集 CPU、内存、文件系统和网络使用的统计信息。cAdvisor 通过它所在节点的 Root 容器，采集并分析该节点的全面使用情况。</p>
<p>cAdvisor 通过其所在节点的 4149 端口暴露一个简单的 UI。</p>
<h2 id="4-4-工作原理"><a href="#4-4-工作原理" class="headerlink" title="4.4 工作原理"></a>4.4 工作原理</h2><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-kubelet-diagram.png" alt="img"></p>
<p>kubelet 内部组件：</p>
<ul>
<li>kubelet API：认证API (10250)，cAdvisor API (4194)，只读 API (10255)，健康检查API (10248)</li>
<li>syncLoop: 从 API 或者 manifest 目录接收 Pod 跟新，发送到 podWorkers 处理，大量使用 channel 来处理异步请求</li>
<li>辅助的 Manager: cAdvisor, PLEG, Volume Manager等，处理 syncLoop 以外的工作</li>
<li>CRI：容器执行引擎接口，负责与 container runtime shim 通信</li>
<li>容器执行引擎：dockershim, rkt等</li>
<li>网络插件：CNI， kubenet</li>
</ul>
<h2 id="4-5-Kubelet-Eviction"><a href="#4-5-Kubelet-Eviction" class="headerlink" title="4.5 Kubelet Eviction"></a>4.5 Kubelet Eviction</h2><p>kubelet 会健康资源的使用情况，并通过驱逐机制防止计算和存储资源耗尽。在驱逐时，Pod中的容器全部停止，并将 PodPhase 设置为 Failed</p>
<p>定期 (housekeeping-interval) 检查系统的资源是否达到了预先配置的驱逐阈值：</p>
<table>
<thead>
<tr>
<th>Eviction Signal</th>
<th>Condition</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>memory.available</code></td>
<td>MemoryPressue</td>
<td><code>memory.available</code> := <code>node.status.capacity[memory]</code> - <code>node.stats.memory.workingSet</code></td>
</tr>
<tr>
<td><code>nodefs.available</code></td>
<td>DiskPressure</td>
<td><code>nodefs.available</code> := <code>node.stats.fs.available</code>（Kubelet Volume以及日志等）</td>
</tr>
<tr>
<td><code>nodefs.inodesFree</code></td>
<td>DiskPressure</td>
<td><code>nodefs.inodesFree</code> := <code>node.stats.fs.inodesFree</code></td>
</tr>
<tr>
<td><code>imagefs.available</code></td>
<td>DiskPressure</td>
<td><code>imagefs.available</code> := <code>node.stats.runtime.imagefs.available</code>（镜像以及容器可写层等）</td>
</tr>
<tr>
<td><code>imagefs.inodesFree</code></td>
<td>DiskPressure</td>
<td><code>imagefs.inodesFree</code> := <code>node.stats.runtime.imagefs.inodesFree</code></td>
</tr>
</tbody></table>
<p>驱逐阈值可以使用百分比，也可以使用绝对值:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--eviction-hard=memory.available&lt;500Mi,nodefs.available&lt;1Gi,imagefs.available&lt;100Gi</span><br><span class="line">--eviction-minimum-reclaim=<span class="string">&quot;memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi&quot;</span>`</span><br><span class="line">--system-reserved=memory=1.5Gi</span><br></pre></td></tr></table></figure>

<p>驱逐信号分类：</p>
<ul>
<li>软驱逐 (Soft Eviction): 配合驱逐宽限期 (eviction-soft-grace-period 和 eviction-max-pod-grace-period) 一起使用。系统资源达到软驱逐阈值且超过宽限期之后才会执行驱逐动作</li>
<li>硬驱逐 (Hard Eviction): 系统资源达到硬驱逐阈值时理解执行驱逐动作</li>
</ul>
<p>驱逐动作：</p>
<ul>
<li>回收节点资源<ul>
<li>配置了 imagefs 阈值<ul>
<li>达到 nodefs 阈值：删除已停止的 Pod</li>
<li>达到 imagefs 阈值：删除未使用的镜像</li>
</ul>
</li>
<li>未配置 imagefs 阈值<ul>
<li>达到 nodefs 阈值：先删除已停止的 Pod，后删除未使用的镜像，顺序清理</li>
</ul>
</li>
</ul>
</li>
<li>驱逐用户 Pod<ul>
<li>驱逐顺序：BestEffort, Burstable, Guaranteed</li>
<li>配置了 imagefs 阈值<ul>
<li>达到 nodefs 阈值：基于nodefs用量驱逐 (local volume + logs)</li>
<li>达到 imagefs 阈值：基于imagefs用量驱逐 (容器可写层)</li>
</ul>
</li>
<li>未配置 imagefs 阈值<ul>
<li>达到 nodefs 阈值：安装总磁盘使用驱逐 (local volume + logs + 容器可写层)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>其他容器和镜像垃圾回收选项：</p>
<table>
<thead>
<tr>
<th>垃圾回收参数</th>
<th>驱逐参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>--image-gc-high-threshold</code></td>
<td><code>--eviction-hard</code> 或 <code>--eviction-soft</code></td>
<td>现存的驱逐回收信号可以触发镜像垃圾回收</td>
</tr>
<tr>
<td><code>--image-gc-low-threshold</code></td>
<td><code>--eviction-minimum-reclaim</code></td>
<td>驱逐回收实现相同行为</td>
</tr>
<tr>
<td><code>--minimum-image-ttl-duration</code></td>
<td></td>
<td>由于驱逐不包括TTL配置，所以它还会继续支持</td>
</tr>
<tr>
<td><code>--maximum-dead-containers</code></td>
<td></td>
<td>一旦旧日志存储在容器上下文之外，就会被弃用</td>
</tr>
<tr>
<td><code>--maximum-dead-containers-per-container</code></td>
<td></td>
<td>一旦旧日志存储在容器上下文之外，就会被弃用</td>
</tr>
<tr>
<td><code>--minimum-container-ttl-duration</code></td>
<td></td>
<td>一旦旧日志存储在容器上下文之外，就会被弃用</td>
</tr>
<tr>
<td><code>--low-diskspace-threshold-mb</code></td>
<td><code>--eviction-hard</code> or <code>eviction-soft</code></td>
<td>驱逐回收将磁盘阈值泛化到其他资源</td>
</tr>
<tr>
<td><code>--outofdisk-transition-frequency</code></td>
<td><code>--eviction-pressure-transition-period</code></td>
<td>驱逐回收将磁盘压力转换到其他资源</td>
</tr>
</tbody></table>
<h2 id="4-6-容器运行时"><a href="#4-6-容器运行时" class="headerlink" title="4.6 容器运行时"></a>4.6 容器运行时</h2><p>容器运行时 (Container Runtime)，负责真正管理镜像和容器的生命周期。kubelet 通过容器运行时接口 (Container Runtime Interface, CRI) 与容器运行时交互，以管理镜像和容器。</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-cri-diagram.png" alt="img"></p>
<p>CRI 容器引擎：</p>
<ul>
<li>Docker：dockershim</li>
<li>OCI (Open Container Initiative) 开放容器标准<ul>
<li>Containerd</li>
<li>CRI-O</li>
<li>runc, OCI 标准容器引擎</li>
</ul>
</li>
<li>PouchContainer：阿里巴巴开源的胖容器引擎</li>
</ul>
<h2 id="4-7-Node-汇总指标"><a href="#4-7-Node-汇总指标" class="headerlink" title="4.7 Node 汇总指标"></a>4.7 Node 汇总指标</h2><ul>
<li><p>集群内部：<code>curl http://k8s-master1:10255/stats/summary</code></p>
</li>
<li><p>集群外部：（暂未成功）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy &amp;</span><br><span class="line">curl http://localhost:8001/api/v1/proxy/csinodes/k8s-master1:10255/stats/summary</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="5-Kube-proxy"><a href="#5-Kube-proxy" class="headerlink" title="5. Kube-proxy"></a>5. Kube-proxy</h1><h2 id="5-1-简介"><a href="#5-1-简介" class="headerlink" title="5.1 简介"></a>5.1 简介</h2><p>kube-proxy 监听 API server 中 service 和 endpoint 的变化情况，并通过 userspace、iptables、ipvs 或 winuserspace 等 proxier 来为服务配置<strong>负载均衡</strong>（仅支持 TCP &amp; UDP）</p>
<p>kube-proxy 可以直接运行在物理机上，也可以以 static pod 或者daemonset的方式运行</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-kube-proxy-diagram.png" alt="img"> </p>
<p>kube-proxy 的实现：</p>
<ul>
<li><p>userspace： 早期方案，它在用户空间监听一个端口，所有服务通过 iptables 转发到这个端口，然后再其内部负载均衡器到实际的Pod。该方式最主要的问题时效率低，有明显的性能瓶颈。</p>
</li>
<li><p>iptables: 推荐方案，完全以iptables规则的方式来实现 service 负载均衡。该方式的最主要问题是创建了太多的 iptables 规则，非增量式更新会引入一定的时延，大规模情况下有明显的性能问题</p>
</li>
<li><p>ipvs: 解决了 iptables 的性能问题，采用增量式更新，可以保证 service 更新期间连接保持不断开</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ipvs 模式需要加载内核模块</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line"><span class="comment"># to check loaded modules, use</span></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">cut -f1 -d <span class="string">&quot; &quot;</span>  /proc/modules | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="5-2-Iptables-示例"><a href="#5-2-Iptables-示例" class="headerlink" title="5.2 Iptables 示例"></a>5.2 Iptables 示例</h2><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-kube-proxy-iptables.png" alt="img"> </p>
<h2 id="5-3-ipvs-示例"><a href="#5-3-ipvs-示例" class="headerlink" title="5.3 ipvs 示例"></a>5.3 ipvs 示例</h2><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-kube-proxy-ipvs.png" alt="img"> </p>
<h2 id="5-4-kube-proxy-的不足"><a href="#5-4-kube-proxy-的不足" class="headerlink" title="5.4 kube-proxy 的不足"></a>5.4 kube-proxy 的不足</h2><p>只支持 TCP 和 UDP，不支持 HTTP 路由，也没有健康检查机制。这些可以通过自定义 <a target="_blank" rel="noopener" href="https://feisky.gitbooks.io/kubernetes/content/plugins/ingress.html">Ingress Controller</a> 的方法来解决。</p>
<h1 id="6-Kube-DNS"><a href="#6-Kube-DNS" class="headerlink" title="6. Kube-DNS"></a>6. Kube-DNS</h1><h2 id="6-1-kube-dns"><a href="#6-1-kube-dns" class="headerlink" title="6.1 kube-dns"></a>6.1 kube-dns</h2><h3 id="6-1-1-工作原理"><a href="#6-1-1-工作原理" class="headerlink" title="6.1.1 工作原理"></a>6.1.1 工作原理</h3><p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-kube-dns-procedure.png" alt="img"> </p>
<p>kube-dns 由三个容器构成：</p>
<ul>
<li>kube-dns: 核心组件<ul>
<li>KubeDNS：负责监听 Service 和 Endpoint 的变化情况，并将相关信息更新到 Sky DNS 中</li>
<li>SkyDNS: 负责 DNS 解析，监听在 10053 端口，同时也监听在 10055 端口提供 metrics 服务</li>
<li>kube-dns 还监听在 8081 端口，提供健康检查使用</li>
</ul>
</li>
<li>dnsmasq-nanny: 负责启动 dnsmasq，配置发生变化时，重启 dnsmasq<ul>
<li>dnsmasq 的 upstream 为 SkyDNS，即集群内部的 DNS 解析由 SkyDNS 负责</li>
</ul>
</li>
<li>sidecar: 负责健康检查和 提供 DNS metrics （10054端口）</li>
</ul>
<h3 id="6-1-2-使用-kube-dns"><a href="#6-1-2-使用-kube-dns" class="headerlink" title="6.1.2 使用 kube-dns"></a>6.1.2 使用 kube-dns</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-dns.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: kube-dns</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    k8s-app: kube-dns</span></span><br><span class="line"><span class="string">    kubernetes.io/cluster-service: &quot;true&quot;</span></span><br><span class="line"><span class="string">    addonmanager.kubernetes.io/mode: Reconcile</span></span><br><span class="line"><span class="string">    kubernetes.io/name: &quot;KubeDNS&quot;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    k8s-app: kube-dns</span></span><br><span class="line"><span class="string">  clusterIP: 10.0.0.2</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: dns</span></span><br><span class="line"><span class="string">    port: 53</span></span><br><span class="line"><span class="string">    protocol: UDP</span></span><br><span class="line"><span class="string">  - name: dns-tcp</span></span><br><span class="line"><span class="string">    port: 53</span></span><br><span class="line"><span class="string">    protocol: TCP</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: kube-dns</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    kubernetes.io/cluster-service: &quot;true&quot;</span></span><br><span class="line"><span class="string">    addonmanager.kubernetes.io/mode: Reconcile</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: kube-dns</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    addonmanager.kubernetes.io/mode: EnsureExists</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: kube-dns</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    k8s-app: kube-dns</span></span><br><span class="line"><span class="string">    kubernetes.io/cluster-service: &quot;true&quot;</span></span><br><span class="line"><span class="string">    addonmanager.kubernetes.io/mode: Reconcile</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  # replicas: not specified here:</span></span><br><span class="line"><span class="string">  # 1. In order to make Addon Manager do not reconcile this replicas parameter.</span></span><br><span class="line"><span class="string">  # 2. Default is 1.</span></span><br><span class="line"><span class="string">  # 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class="line"><span class="string">  strategy:</span></span><br><span class="line"><span class="string">    rollingUpdate:</span></span><br><span class="line"><span class="string">      maxSurge: 10%</span></span><br><span class="line"><span class="string">      maxUnavailable: 0</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      k8s-app: kube-dns</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        k8s-app: kube-dns</span></span><br><span class="line"><span class="string">      annotations:</span></span><br><span class="line"><span class="string">        prometheus.io/port: &quot;10054&quot;</span></span><br><span class="line"><span class="string">        prometheus.io/scrape: &quot;true&quot;</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      priorityClassName: system-cluster-critical</span></span><br><span class="line"><span class="string">      securityContext:</span></span><br><span class="line"><span class="string">        seccompProfile:</span></span><br><span class="line"><span class="string">          type: RuntimeDefault</span></span><br><span class="line"><span class="string">        supplementalGroups: [ 65534 ]</span></span><br><span class="line"><span class="string">        fsGroup: 65534</span></span><br><span class="line"><span class="string">      affinity:</span></span><br><span class="line"><span class="string">        podAntiAffinity:</span></span><br><span class="line"><span class="string">          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">          - weight: 100</span></span><br><span class="line"><span class="string">            podAffinityTerm:</span></span><br><span class="line"><span class="string">              labelSelector:</span></span><br><span class="line"><span class="string">                matchExpressions:</span></span><br><span class="line"><span class="string">                  - key: k8s-app</span></span><br><span class="line"><span class="string">                    operator: In</span></span><br><span class="line"><span class="string">                    values: [&quot;kube-dns&quot;]</span></span><br><span class="line"><span class="string">              topologyKey: kubernetes.io/hostname</span></span><br><span class="line"><span class="string">      tolerations:</span></span><br><span class="line"><span class="string">      - key: &quot;CriticalAddonsOnly&quot;</span></span><br><span class="line"><span class="string">        operator: &quot;Exists&quot;</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">      - name: kube-dns-config</span></span><br><span class="line"><span class="string">        configMap:</span></span><br><span class="line"><span class="string">          name: kube-dns</span></span><br><span class="line"><span class="string">          optional: true</span></span><br><span class="line"><span class="string">      nodeSelector:</span></span><br><span class="line"><span class="string">        kubernetes.io/os: linux</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: kubedns</span></span><br><span class="line"><span class="string">        image: k8s.gcr.io/dns/k8s-dns-kube-dns:1.17.3</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          # TODO: Set memory limits when we&#x27;ve profiled the container for large</span></span><br><span class="line"><span class="string">          # clusters, then set request = limit to keep this container in</span></span><br><span class="line"><span class="string">          # guaranteed class. Currently, this container falls into the</span></span><br><span class="line"><span class="string">          # &quot;burstable&quot; category so the kubelet doesn&#x27;t backoff from restarting it.</span></span><br><span class="line"><span class="string">          limits:</span></span><br><span class="line"><span class="string">            memory: 170Mi</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">            cpu: 100m</span></span><br><span class="line"><span class="string">            memory: 70Mi</span></span><br><span class="line"><span class="string">        livenessProbe:</span></span><br><span class="line"><span class="string">          httpGet:</span></span><br><span class="line"><span class="string">            path: /healthcheck/kubedns</span></span><br><span class="line"><span class="string">            port: 10054</span></span><br><span class="line"><span class="string">            scheme: HTTP</span></span><br><span class="line"><span class="string">          initialDelaySeconds: 60</span></span><br><span class="line"><span class="string">          timeoutSeconds: 5</span></span><br><span class="line"><span class="string">          successThreshold: 1</span></span><br><span class="line"><span class="string">          failureThreshold: 5</span></span><br><span class="line"><span class="string">        readinessProbe:</span></span><br><span class="line"><span class="string">          httpGet:</span></span><br><span class="line"><span class="string">            path: /readiness</span></span><br><span class="line"><span class="string">            port: 8081</span></span><br><span class="line"><span class="string">            scheme: HTTP</span></span><br><span class="line"><span class="string">          # we poll on pod startup for the Kubernetes master service and</span></span><br><span class="line"><span class="string">          # only setup the /readiness HTTP server once that&#x27;s available.</span></span><br><span class="line"><span class="string">          initialDelaySeconds: 3</span></span><br><span class="line"><span class="string">          timeoutSeconds: 5</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">        - --domain=cluster.local.</span></span><br><span class="line"><span class="string">        - --dns-port=10053</span></span><br><span class="line"><span class="string">        - --config-dir=/kube-dns-config</span></span><br><span class="line"><span class="string">        - --v=2</span></span><br><span class="line"><span class="string">        env:</span></span><br><span class="line"><span class="string">        - name: PROMETHEUS_PORT</span></span><br><span class="line"><span class="string">          value: &quot;10055&quot;</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 10053</span></span><br><span class="line"><span class="string">          name: dns-local</span></span><br><span class="line"><span class="string">          protocol: UDP</span></span><br><span class="line"><span class="string">        - containerPort: 10053</span></span><br><span class="line"><span class="string">          name: dns-tcp-local</span></span><br><span class="line"><span class="string">          protocol: TCP</span></span><br><span class="line"><span class="string">        - containerPort: 10055</span></span><br><span class="line"><span class="string">          name: metrics</span></span><br><span class="line"><span class="string">          protocol: TCP</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">        - name: kube-dns-config</span></span><br><span class="line"><span class="string">          mountPath: /kube-dns-config</span></span><br><span class="line"><span class="string">        securityContext:</span></span><br><span class="line"><span class="string">          allowPrivilegeEscalation: false</span></span><br><span class="line"><span class="string">          readOnlyRootFilesystem: true</span></span><br><span class="line"><span class="string">          runAsUser: 1001</span></span><br><span class="line"><span class="string">          runAsGroup: 1001</span></span><br><span class="line"><span class="string">      - name: dnsmasq</span></span><br><span class="line"><span class="string">        image: k8s.gcr.io/dns/k8s-dns-dnsmasq-nanny:1.17.3</span></span><br><span class="line"><span class="string">        livenessProbe:</span></span><br><span class="line"><span class="string">          httpGet:</span></span><br><span class="line"><span class="string">            path: /healthcheck/dnsmasq</span></span><br><span class="line"><span class="string">            port: 10054</span></span><br><span class="line"><span class="string">            scheme: HTTP</span></span><br><span class="line"><span class="string">          initialDelaySeconds: 60</span></span><br><span class="line"><span class="string">          timeoutSeconds: 5</span></span><br><span class="line"><span class="string">          successThreshold: 1</span></span><br><span class="line"><span class="string">          failureThreshold: 5</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">        - -v=2</span></span><br><span class="line"><span class="string">        - -logtostderr</span></span><br><span class="line"><span class="string">        - -configDir=/etc/k8s/dns/dnsmasq-nanny</span></span><br><span class="line"><span class="string">        - -restartDnsmasq=true</span></span><br><span class="line"><span class="string">        - --</span></span><br><span class="line"><span class="string">        - -k</span></span><br><span class="line"><span class="string">        - --cache-size=1000</span></span><br><span class="line"><span class="string">        - --no-negcache</span></span><br><span class="line"><span class="string">        - --dns-loop-detect</span></span><br><span class="line"><span class="string">        - --log-facility=-</span></span><br><span class="line"><span class="string">        - --server=/cluster.local/127.0.0.1#10053</span></span><br><span class="line"><span class="string">        - --server=/in-addr.arpa/127.0.0.1#10053</span></span><br><span class="line"><span class="string">        - --server=/ip6.arpa/127.0.0.1#10053</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 53</span></span><br><span class="line"><span class="string">          name: dns</span></span><br><span class="line"><span class="string">          protocol: UDP</span></span><br><span class="line"><span class="string">        - containerPort: 53</span></span><br><span class="line"><span class="string">          name: dns-tcp</span></span><br><span class="line"><span class="string">          protocol: TCP</span></span><br><span class="line"><span class="string">        # see: https://github.com/kubernetes/kubernetes/issues/29055 for details</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">            cpu: 150m</span></span><br><span class="line"><span class="string">            memory: 20Mi</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">        - name: kube-dns-config</span></span><br><span class="line"><span class="string">          mountPath: /etc/k8s/dns/dnsmasq-nanny</span></span><br><span class="line"><span class="string">        securityContext:</span></span><br><span class="line"><span class="string">          capabilities:</span></span><br><span class="line"><span class="string">            drop:</span></span><br><span class="line"><span class="string">              - all</span></span><br><span class="line"><span class="string">            add:</span></span><br><span class="line"><span class="string">              - NET_BIND_SERVICE</span></span><br><span class="line"><span class="string">              - SETGID</span></span><br><span class="line"><span class="string">      - name: sidecar</span></span><br><span class="line"><span class="string">        image: k8s.gcr.io/dns/k8s-dns-sidecar:1.17.3</span></span><br><span class="line"><span class="string">        livenessProbe:</span></span><br><span class="line"><span class="string">          httpGet:</span></span><br><span class="line"><span class="string">            path: /metrics</span></span><br><span class="line"><span class="string">            port: 10054</span></span><br><span class="line"><span class="string">            scheme: HTTP</span></span><br><span class="line"><span class="string">          initialDelaySeconds: 60</span></span><br><span class="line"><span class="string">          timeoutSeconds: 5</span></span><br><span class="line"><span class="string">          successThreshold: 1</span></span><br><span class="line"><span class="string">          failureThreshold: 5</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">        - --v=2</span></span><br><span class="line"><span class="string">        - --logtostderr</span></span><br><span class="line"><span class="string">        - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.cluster.local,5,SRV</span></span><br><span class="line"><span class="string">        - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.cluster.local,5,SRV</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 10054</span></span><br><span class="line"><span class="string">          name: metrics</span></span><br><span class="line"><span class="string">          protocol: TCP</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">            memory: 20Mi</span></span><br><span class="line"><span class="string">            cpu: 10m</span></span><br><span class="line"><span class="string">        securityContext:</span></span><br><span class="line"><span class="string">          allowPrivilegeEscalation: false</span></span><br><span class="line"><span class="string">          readOnlyRootFilesystem: true</span></span><br><span class="line"><span class="string">          runAsUser: 1001</span></span><br><span class="line"><span class="string">          runAsGroup: 1001</span></span><br><span class="line"><span class="string">      dnsPolicy: Default  # Don&#x27;t use cluster DNS.</span></span><br><span class="line"><span class="string">      serviceAccountName: kube-dns</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f kube-dns.yaml</span><br><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>

<h3 id="6-1-3-相关问题"><a href="#6-1-3-相关问题" class="headerlink" title="6.1.3 相关问题"></a>6.1.3 相关问题</h3><h4 id="1-问题定位"><a href="#1-问题定位" class="headerlink" title="1. 问题定位"></a>1. 问题定位</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发现问题</span></span><br><span class="line">kubectl describe pod kube-dns-594c5b5cb5-mdxp6 -n kube-system</span><br><span class="line">...</span><br><span class="line">  Normal   Pulled     13m                   kubelet            Container image <span class="string">&quot;k8s.gcr.io/dns/k8s-dns-kube-dns:1.17.3&quot;</span> already present on machine</span><br><span class="line">  Warning  Unhealthy  12m (x2 over 13m)     kubelet            Liveness probe failed: HTTP probe failed with statuscode: 503</span><br><span class="line">  Warning  Unhealthy  9m32s (x25 over 13m)  kubelet            Readiness probe failed: Get <span class="string">&quot;http://10.244.2.28:8081/readiness&quot;</span>: dial tcp 10.244.2.28:8081: connect: connection refused</span><br><span class="line">  Warning  BackOff    4m30s (x19 over 10m)  kubelet            Back-off restarting failed container</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器日志</span></span><br><span class="line">kubectl logs  kube-dns-594c5b5cb5-mdxp6 kubedns -n kube-system</span><br><span class="line">...</span><br><span class="line">I0520 05:59:53.947378       1 server.go:195] Skydns metrics enabled (/metrics:10055)</span><br><span class="line">I0520 05:59:53.947996       1 log.go:172] skydns: ready <span class="keyword">for</span> queries on cluster.local. <span class="keyword">for</span> tcp://0.0.0.0:10053 [rcache 0]</span><br><span class="line">I0520 05:59:53.948005       1 log.go:172] skydns: ready <span class="keyword">for</span> queries on cluster.local. <span class="keyword">for</span> udp://0.0.0.0:10053 [rcache 0]</span><br><span class="line">E0520 05:59:53.957842       1 reflector.go:125] pkg/mod/k8s.io/client-go@v0.0.0-20190620085101-78d2af792bab/tools/cache/reflector.go:98: Failed to list *v1.Service: services is forbidden: User <span class="string">&quot;system:serviceaccount:kube-system:kube-dns&quot;</span> cannot list resource <span class="string">&quot;services&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">&quot;system:kube-dns&quot;</span> not found</span><br><span class="line">E0520 05:59:53.957894       1 reflector.go:125] pkg/mod/k8s.io/client-go@v0.0.0-20190620085101-78d2af792bab/tools/cache/reflector.go:98: Failed to list *v1.Endpoints: endpoints is forbidden: User <span class="string">&quot;system:serviceaccount:kube-system:kube-dns&quot;</span> cannot list resource <span class="string">&quot;endpoints&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">&quot;system:kube-dns&quot;</span> not found</span><br><span class="line">I0520 05:59:54.447988       1 dns.go:220] Waiting <span class="keyword">for</span> [endpoints services] to be initialized from apiserver...</span><br></pre></td></tr></table></figure>

<p><strong>问题根因</strong>：rbac “system:kube-dns” 未找到，导致无法访问apiserver</p>
<h4 id="2-解决办法"><a href="#2-解决办法" class="headerlink" title="2. 解决办法"></a>2. 解决办法</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 创建 rbac</span><br><span class="line">cat &gt; kube-dns-rbac.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-dns</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">    - endpoints</span><br><span class="line">    - services</span><br><span class="line">    verbs:</span><br><span class="line">    - get</span><br><span class="line">    - list</span><br><span class="line">    - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-dns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-dns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f kube-dns-rbac.yaml</span><br><span class="line"></span><br><span class="line">kubectl describe clusterrole system:kube-dns</span><br><span class="line">kubectl describe clusterrolebinding system:kube-dns</span><br></pre></td></tr></table></figure>



<h4 id="3-验证成功"><a href="#3-验证成功" class="headerlink" title="3. 验证成功"></a>3. 验证成功</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-dns.yaml</span><br><span class="line">kubectl apply -f kube-dns.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pod -n kube-system -o wide | grep kube-dns</span><br><span class="line">kube-dns-594c5b5cb5-6wttp   3/3     Running   0          13m     10.244.2.29     k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">kubectl describe pod kube-dns-594c5b5cb5-mdxp6 -n kube-system</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  48s   default-scheduler  Successfully assigned kube-system/kube-dns-594c5b5cb5-6wttp to k8s-node1</span><br><span class="line">  Normal  Pulled     47s   kubelet            Container image <span class="string">&quot;k8s.gcr.io/dns/k8s-dns-kube-dns:1.17.3&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    47s   kubelet            Created container kubedns</span><br><span class="line">  Normal  Started    47s   kubelet            Started container kubedns</span><br><span class="line">  Normal  Pulled     47s   kubelet            Container image <span class="string">&quot;k8s.gcr.io/dns/k8s-dns-dnsmasq-nanny:1.17.3&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    47s   kubelet            Created container dnsmasq</span><br><span class="line">  Normal  Started    47s   kubelet            Started container dnsmasq</span><br><span class="line">  Normal  Pulled     47s   kubelet            Container image <span class="string">&quot;k8s.gcr.io/dns/k8s-dns-sidecar:1.17.3&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    47s   kubelet            Created container sidecar</span><br><span class="line">  Normal  Started    47s   kubelet            Started container sidecar</span><br></pre></td></tr></table></figure>



<h2 id="6-2-CoreDNS"><a href="#6-2-CoreDNS" class="headerlink" title="6.2 CoreDNS"></a>6.2 CoreDNS</h2><p>kube-dns 的升级版。CoreDNS 的效率更高，资源占用更小</p>
<h3 id="6-2-1-安装-coredns"><a href="#6-2-1-安装-coredns" class="headerlink" title="6.2.1 安装 coredns"></a>6.2.1 安装 coredns</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/coredns/deployment/archive/refs/tags/coredns-1.14.0.tar.gz</span><br><span class="line">tar zxvf coredns-1.14.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> deployment-coredns-1.14.0/kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line">./deploy.sh | kubectl apply -f -</span><br><span class="line">kubectl delete --namespace=kube-system deployment kube-dns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">./rollback.sh | kubectl apply -f -</span><br><span class="line">kubectl delete --namespace=kube-system deployment coredns</span><br></pre></td></tr></table></figure>



<h3 id="6-2-2-支持的-DNS-格式"><a href="#6-2-2-支持的-DNS-格式" class="headerlink" title="6.2.2 支持的 DNS 格式"></a>6.2.2 支持的 DNS 格式</h3><ul>
<li><p>Service</p>
<ul>
<li>A record：<code>$&#123;my-svc&#125;.$&#123;my-namespace&#125;.svc.cluster.local</code>，解析分两种情况<ul>
<li>普通 Service 解析为 Cluster IP</li>
<li>Headless Service 解析为指定的 Pod IP 列表</li>
</ul>
</li>
<li>SRV record: <code>_$&#123;my-port-name&#125;._$&#123;my-port-protocol&#125;$&#123;my-svc&#125;.$&#123;my-namespace&#125;.svc.cluster.local</code></li>
</ul>
</li>
<li><p>Pod</p>
<ul>
<li>A record: <code>$&#123;pod-ip-address&#125;.$&#123;my-namespace&#125;.pod.cluster.local</code></li>
<li>指定 hostname 和 subdomain: <code>$&#123;hostname&#125;.$&#123;custom-subdomain&#125;.default.svc.cluster.local</code></li>
</ul>
</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; dns-test.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    name: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  hostname: nginx</span></span><br><span class="line"><span class="string">  subdomain: default-subdomain</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      containerPort: 80 </span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: dnsutils</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    name: dnsutils</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: tutum/dnsutils</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - sleep</span></span><br><span class="line"><span class="string">      - &quot;7200&quot;</span></span><br><span class="line"><span class="string">    name: dnsutils</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f nginx-pod.yaml</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> -it dnsutils /bin/sh</span><br></pre></td></tr></table></figure>



<h2 id="6-3-私有和上游-DNS-服务器"><a href="#6-3-私有和上游-DNS-服务器" class="headerlink" title="6.3 私有和上游 DNS 服务器"></a>6.3 私有和上游 DNS 服务器</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-dns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">stubDomains:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;“acme.local”: [“1.2.3.4”]&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">upstreamNameservers:</span> <span class="string">|</span></span><br><span class="line">    [<span class="string">“8.8.8.8”</span>, <span class="string">“8.8.4.4”</span>]</span><br></pre></td></tr></table></figure>

<p>查询请求首先会被发送到 kube-dns 的 DNS 缓存层 (Dnsmasq 服务器)。Dnsmasq 服务器会先检查请求的后缀，带有集群后缀（例如：”.cluster.local”）的请求会被发往 kube-dns，拥有存根域后缀的名称（例如：”.acme.local”）将会被发送到配置的私有 DNS 服务器 [“1.2.3.4”]。最后，不满足任何这些后缀的请求将会被发送到上游 DNS [“8.8.8.8”, “8.8.4.4”] 里。</p>
<p><img src="https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/kubernetes/k8s-kube-dns-upstream.png" alt="img"> </p>

      </div>
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-07-13T14:28:48+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>更新于 2021年7月13日</p>
  </a>
</div>

        
      
        
          

        
      
        
          

        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                          <h4>
                              <a href="/2021/10/09/Golang%20%E5%8A%A0%E5%AF%86%E5%92%8C%E7%AD%BE%E5%90%8D.md/" rel="prev" title="Golang 加密和签名">
                                
                                    Golang 加密和签名
                                
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2021/06/20/Kubernetes%20%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/" rel="prev" title="Kubernetes 集群二进制安装">
                                  
                                      Kubernetes 集群二进制安装
                                  
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Kubernetes 核心组件',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
      
        
          
          
            
              <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/avatar/avatar.png'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:eli.he@outlook.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/elihe2011"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=282243842"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-API-Server"><span class="toc-text">1. API-Server</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">1.1 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E8%AE%BF%E9%97%AE"><span class="toc-text">1.2 访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-%E8%AE%BF%E9%97%AE%E7%AB%AF%E5%8F%A3"><span class="toc-text">1.2.1 访问端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E8%AE%BF%E9%97%AE%E6%96%B9%E5%BC%8F"><span class="toc-text">1.2.2 访问方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-API-%E8%B5%84%E6%BA%90"><span class="toc-text">1.3 API 资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E7%A4%BA%E4%BE%8B"><span class="toc-text">1.4 示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Controller-Manager"><span class="toc-text">2. Controller-Manager</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%8E%A7%E5%88%B6%E5%99%A8%E5%88%86%E7%B1%BB"><span class="toc-text">2.1 控制器分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Replication-Controller-RC"><span class="toc-text">2.2 Replication Controller (RC)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-RC-%E7%9A%84%E8%81%8C%E8%B4%A3"><span class="toc-text">2.2.1 RC 的职责</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88"><span class="toc-text">2.2.2 存活探针</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-ReplicaSet-RS"><span class="toc-text">2.3 ReplicaSet (RS)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Node-Controller"><span class="toc-text">2.4 Node Controller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-Node-Eviction"><span class="toc-text">2.4.1 Node Eviction</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-ResourceQuota-Controller"><span class="toc-text">2.5 ResourceQuota Controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-Namespace-Controller"><span class="toc-text">2.6 Namespace Controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-Endpoint-Controller"><span class="toc-text">2.7 Endpoint Controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-Service-Controller"><span class="toc-text">2.8 Service Controller</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Scheduler"><span class="toc-text">3. Scheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%B0%83%E5%BA%A6%E6%B5%81%E7%A8%8B"><span class="toc-text">3.1 调度流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E9%A2%84%E9%80%89%E7%AD%96%E7%95%A5"><span class="toc-text">3.2 预选策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E4%BC%98%E9%80%89%E7%AD%96%E7%95%A5"><span class="toc-text">3.3 优选策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6"><span class="toc-text">3.4 高级调度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-nodeSelector"><span class="toc-text">3.4.1 nodeSelector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E4%BA%B2%E5%92%8C%E6%80%A7-affinity"><span class="toc-text">3.4.2 亲和性 (affinity)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%BD%AF%E4%BA%B2%E5%92%8C"><span class="toc-text">1. 软亲和</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#preferredDuringSchedulingIgnoredDuringExecution"><span class="toc-text">preferredDuringSchedulingIgnoredDuringExecution</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%A1%AC%E4%BA%B2%E5%92%8C"><span class="toc-text">2. 硬亲和</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-text">3.4.3 反亲和性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D"><span class="toc-text">3.5 污点和容忍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E6%B1%A1%E7%82%B9%E7%AE%A1%E7%90%86"><span class="toc-text">3.5.1 污点管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E5%AE%B9%E5%BF%8D"><span class="toc-text">3.5.2 容忍</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Kubelet"><span class="toc-text">4. Kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86"><span class="toc-text">4.1 节点管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Pod-%E7%AE%A1%E7%90%86"><span class="toc-text">4.2 Pod 管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E8%8E%B7%E5%8F%96-Pod-%E6%B8%85%E5%8D%95"><span class="toc-text">4.2.1 获取 Pod 清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-Pod-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-text">4.2.2 Pod 创建流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="toc-text">4.2.3 容器状态检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-Static-Pod"><span class="toc-text">4.2.4 Static Pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-cAdvisor-%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7"><span class="toc-text">4.3 cAdvisor 资源监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">4.4 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-Kubelet-Eviction"><span class="toc-text">4.5 Kubelet Eviction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="toc-text">4.6 容器运行时</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-Node-%E6%B1%87%E6%80%BB%E6%8C%87%E6%A0%87"><span class="toc-text">4.7 Node 汇总指标</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Kube-proxy"><span class="toc-text">5. Kube-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E7%AE%80%E4%BB%8B"><span class="toc-text">5.1 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Iptables-%E7%A4%BA%E4%BE%8B"><span class="toc-text">5.2 Iptables 示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-ipvs-%E7%A4%BA%E4%BE%8B"><span class="toc-text">5.3 ipvs 示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-kube-proxy-%E7%9A%84%E4%B8%8D%E8%B6%B3"><span class="toc-text">5.4 kube-proxy 的不足</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Kube-DNS"><span class="toc-text">6. Kube-DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-kube-dns"><span class="toc-text">6.1 kube-dns</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">6.1.1 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E4%BD%BF%E7%94%A8-kube-dns"><span class="toc-text">6.1.2 使用 kube-dns</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="toc-text">6.1.3 相关问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D"><span class="toc-text">1. 问题定位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-text">2. 解决办法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%AA%8C%E8%AF%81%E6%88%90%E5%8A%9F"><span class="toc-text">3. 验证成功</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-CoreDNS"><span class="toc-text">6.2 CoreDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-%E5%AE%89%E8%A3%85-coredns"><span class="toc-text">6.2.1 安装 coredns</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-%E6%94%AF%E6%8C%81%E7%9A%84-DNS-%E6%A0%BC%E5%BC%8F"><span class="toc-text">6.2.2 支持的 DNS 格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E7%A7%81%E6%9C%89%E5%92%8C%E4%B8%8A%E6%B8%B8-DNS-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">6.3 私有和上游 DNS 服务器</span></a></li></ol></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/categories/"
    title="blog/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/CentOS/" href="/categories/CentOS/"><div class='name'>CentOS</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Docker/" href="/categories/Docker/"><div class='name'>Docker</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Golang/" href="/categories/Golang/"><div class='name'>Golang</div><div class='badge'>(40)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Linux/" href="/categories/Linux/"><div class='name'>Linux</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/MySQL/" href="/categories/MySQL/"><div class='name'>MySQL</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Nginx/" href="/categories/Nginx/"><div class='name'>Nginx</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/NoSQL/" href="/categories/NoSQL/"><div class='name'>NoSQL</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/RabbitMQ/" href="/categories/RabbitMQ/"><div class='name'>RabbitMQ</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Tools/" href="/categories/Tools/"><div class='name'>Tools</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/golang/" href="/categories/golang/"><div class='name'>golang</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/k8s/" href="/categories/k8s/"><div class='name'>k8s</div><div class='badge'>(9)</div></a></li>
        
          <li><a class="flat-box" title="/categories/kubernetes/" href="/categories/kubernetes/"><div class='name'>kubernetes</div><div class='badge'>(3)</div></a></li>
        
      </ul>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget tagcloud'>
    
<header class='pure'>
  <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/tags/"
    title="blog/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <a href="/tags/algorithm/" style="font-size: 17.33px; color: #828282">algorithm</a> <a href="/tags/elasticsearch/" style="font-size: 14px; color: #999">elasticsearch</a> <a href="/tags/git/" style="font-size: 14px; color: #999">git</a> <a href="/tags/go/" style="font-size: 24px; color: #555">go</a> <a href="/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/tags/mongodb/" style="font-size: 14px; color: #999">mongodb</a> <a href="/tags/nginx/" style="font-size: 14px; color: #999">nginx</a> <a href="/tags/orm/" style="font-size: 14px; color: #999">orm</a> <a href="/tags/rabbitmq/" style="font-size: 17.33px; color: #828282">rabbitmq</a> <a href="/tags/redis/" style="font-size: 14px; color: #999">redis</a> <a href="/tags/rpc/" style="font-size: 20.67px; color: #6c6c6c">rpc</a> <a href="/tags/supervisor/" style="font-size: 14px; color: #999">supervisor</a> <a href="/tags/websocket/" style="font-size: 14px; color: #999">websocket</a>
    </div>
  </section>


            
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:eli.he@outlook.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/elihe2011"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/#/user/home?id=282243842"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://cdn.jsdelivr.net/gh/elihe2011/bedgraph@master/background/Fremont-Peak.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="/js/app.js"></script>



  
<script src="/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
